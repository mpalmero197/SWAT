<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Web Builder - Dark Mode</title>
  <!-- Combined Google Fonts API Call -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&family=Roboto:wght@400;500;700&family=Open+Sans:wght@300;400;600;700&family=Lato:wght@300;400;700&family=Oswald:wght@300;400;500;600;700&family=Raleway:wght@300;400;500;600;700&family=Merriweather:wght@300;400;700&family=Ubuntu:wght@300;400;500;700&family=PT+Sans:wght@400;700&family=Source+Sans+Pro:wght@300;400;600;700&family=Poppins:wght@300;400;500;600;700&family=Noto+Sans:wght@300;400;500;700&family=Noto+Serif:wght@300;400;600;700&family=Roboto+Condensed:wght@300;400;700&family=Dancing+Script:wght@400;500;700&family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    /* Basic Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #181818;
      color: #cfcfcf;
      display: flex;
      min-height: 100vh;
    }
    /* Sidebar */
    .sidebar {
      width: 250px;
      background-color: #202020;
      border-right: 1px solid #2a2a2a;
      display: flex;
      flex-direction: column;
    }
    .sidebar h1 {
      padding: 20px;
      font-size: 1.5rem;
      font-weight: 700;
      border-bottom: 1px solid #2a2a2a;
      text-align: center;
      color: #fff;
    }
    .tab-nav { display: flex; flex-direction: column; }
    .tab-btn {
      background: none;
      border: none;
      padding: 15px 20px;
      text-align: left;
      font-size: 1rem;
      cursor: pointer;
      border-bottom: 1px solid #2a2a2a;
      transition: background 0.3s;
      color: #cfcfcf;
    }
    .tab-btn:hover { background-color: #2e2e2e; }
    .tab-btn.active {
      background-color: #4A88F6;
      border-left: 4px solid #4A88F6;
      font-weight: 600;
      color: #fff;
    }
    /* Main Content */
    .main-content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      background-color: #181818;
    }
    .main-content h2 { margin-bottom: 10px; font-weight: 600; font-size: 1.2rem; color: #fff; }
    .main-content p { color: #bbb; line-height: 1.5; margin-bottom: 15px; }
    /* Tab Contents */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    /* Fields & Buttons */
    .field { margin-bottom: 15px; }
    .field label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.95rem; color: #ccc; }
    .field input, .field select, .field textarea {
      width: 100%; padding: 10px; border-radius: 4px;
      border: 1px solid #3a3a3a; background-color: #2a2a2a;
      font-size: 0.95rem; color: #cfcfcf; transition: border-color 0.2s, background-color 0.2s;
    }
    .field input[type="color"] { height: 40px; cursor: pointer; border: none; }
    .field input:focus, .field select:focus, .field textarea:focus { border-color: #4A88F6; background-color: #333; }
    .buttons {
      display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;
    }
    button {
      cursor: pointer; background: #4A88F6; color: #fff;
      padding: 10px 18px; border: none; border-radius: 4px;
      font-size: 0.95rem; transition: background 0.3s ease, transform 0.2s ease;
    }
    button:hover { background: #3c74d4; transform: translateY(-1px); }
    button.removePageBtn { background-color: #d9534f; }
    button.removePageBtn:hover { background-color: #c9302c; }
    /* Page Editor UI */
    .pageItem {
      background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 6px;
      padding: 15px; margin-bottom: 15px; transition: box-shadow 0.3s;
    }
    .pageItem:hover { box-shadow: 0 2px 6px rgba(255, 255, 255, 0.03); }
    .pageItem .pageHeader { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 10px; }
    .pageItem h3 { font-size: 1rem; margin: 0; flex: 1; color: #fff; }
    /* Section Container */
    .sectionContainer { margin-top: 15px; }
    .sectionItem {
      background: #1f1f1f; padding: 15px; border-radius: 4px; margin-bottom: 10px;
      position: relative; border: 1px solid #333;
    }
    .sectionItem label { font-size: 0.85rem; color: #ccc; }
    .reorder-btns {
      position: absolute; top: 15px; right: 15px; display: flex; flex-direction: column; gap: 3px;
    }
    .reorder-btns button {
      background-color: #444; color: #eee; padding: 3px;
      width: 28px; height: 28px; border-radius: 4px;
      display: flex; align-items: center; justify-content: center; border: none;
    }
    .reorder-btns button:hover { background-color: #555; }
    /* Preview & Generated Code */
    #previewFrame {
      width: 100%; height: 500px; border: 1px solid #3a3a3a;
      border-radius: 4px; background: #2a2a2a;
    }
    #generatedCode {
      margin-top: 20px; background: #1f1f1f; color: #ffffff; border: 1px solid #3a3a3a;
      border-radius: 4px; padding: 15px; width: 100%; height: 400px;
      font-family: 'Courier New', monospace; font-size: 0.9rem;
    }
    /* Submenu Style */
    nav { background: #111; padding: 15px; }
    nav ul {
      list-style: none; display: flex; gap: 20px; margin: 0; padding: 0; align-items: center; position: relative;
    }
    nav li { position: relative; }
    nav a { color: #fff; text-decoration: none; font-weight: bold; }
    .submenu {
      position: absolute; display: none; top: 50px; left: 0; flex-direction: column;
      background-color: #222; padding: 10px; border-radius: 5px;
    }
    .submenu li { margin: 5px 0; }
    .has-submenu:hover .submenu { display: flex; }
    .has-submenu > a::after { content: " \25BC"; margin-left: 5px; font-size: 0.8em; }
    /* Image Results Grid */
    .results-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px; margin-top: 20px;
    }
    .imageResult {
      position: relative; background: #2a2a2a; border: 1px solid #3a3a3a;
      padding: 10px; border-radius: 5px; transition: box-shadow 0.3s;
    }
    .imageResult:hover { box-shadow: 0 2px 6px rgba(255, 255, 255, 0.03); }
    .imageResult img { width: 100%; border-radius: 3px; }
    .assign-btns { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
    /* Responsive Layout */
    @media (max-width: 900px) {
      .sidebar { width: 180px; }
      .tab-btn { padding: 10px 15px; }
    }
    @media (max-width: 600px) {
      .sidebar { position: fixed; width: 60px; z-index: 999; }
      .sidebar h1 { display: none; }
      .tab-btn { font-size: 0; text-align: center; border-left: none; }
      .tab-btn::after { content: attr(data-label); font-size: 1rem; color: #cfcfcf; }
      .main-content { margin-left: 60px; }
    }
    /* Floating View Source Panel */
    #viewSourcePanel {
      position: fixed; background: rgba(0, 0, 0, 0.8); color: #fff;
      padding: 10px; font-family: 'Courier New', monospace; font-size: 0.8rem;
      border-radius: 4px; z-index: 2000; display: none;
      max-width: 300px; max-height: 200px; overflow: auto; word-break: break-all;
    }
    /* Modal Styles for Import Options */
    .import-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000;
    }
    .import-modal {
      background: #fff; padding: 20px; border-radius: 5px; max-width: 400px; width: 100%; color: #000;
    }
    .import-modal h3 { margin-bottom: 15px; }
    .import-modal div { margin-bottom: 10px; }
    .import-modal button { padding: 6px 12px; }
  </style>
</head>
<body>
  <!-- Sidebar Navigation -->
  <div class="sidebar">
    <h1>Web Builder</h1>
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="basicTab" data-label="Basic">Basic Settings</button>
      <button class="tab-btn" data-tab="pagesTab" data-label="Pages">Pages & Navigation</button>
      <button class="tab-btn" data-tab="referenceTab" data-label="Reference">Reference Layout</button>
      <button class="tab-btn" data-tab="imagesTab" data-label="Images">Images & Media</button>
      <button class="tab-btn" data-tab="previewCodeTab" data-label="Preview & Code">Preview & Code</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- BASIC SETTINGS TAB -->
    <div id="basicTab" class="tab-content active">
      <h2>Global Settings</h2>
      <!-- Custom Font Search UI -->
      <div class="field">
        <label for="fontFamilySearch">Font Family:</label>
        <input type="text" id="fontFamilySearch" placeholder="Search fonts (e.g., script, sans-serif, bold)..." />
        <div id="fontFamilyContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #444; margin-top: 5px;"></div>
      </div>
      <div class="field">
        <label for="globalBgColor">Background Color:</label>
        <input type="color" id="globalBgColor" value="#ffffff" />
      </div>
      <div class="field">
        <label for="globalTextColor">Text Color:</label>
        <input type="color" id="globalTextColor" value="#000000" />
      </div>
      <div class="field">
        <label for="globalHeadingColor">Heading Color:</label>
        <input type="color" id="globalHeadingColor" value="#000000" />
      </div>
      <div class="field">
        <label for="includeNav">Include Navigation Bar:</label>
        <input type="checkbox" id="includeNav" />
      </div>
      <div class="field">
        <label for="globalFontSize">Font Size (px):</label>
        <input type="number" id="globalFontSize" value="16" min="10" max="72" />
      </div>
      <div class="field">
        <label for="globalLineHeight">Line Height:</label>
        <input type="number" step="0.1" id="globalLineHeight" value="1.6" min="1" max="3" />
      </div>
      <div class="field">
        <label for="globalLinkColor">Link Color:</label>
        <input type="color" id="globalLinkColor" value="#4A88F6" />
      </div>
      <div class="field">
        <label for="globalBgImage">Background Image URL (Optional):</label>
        <input type="text" id="globalBgImage" placeholder="https://example.com/bg.jpg" />
      </div>
      <div class="field">
        <label for="globalCustomCSS">Custom CSS (Optional):</label>
        <textarea id="globalCustomCSS" rows="4" placeholder="Additional custom CSS..."></textarea>
      </div>
    </div>

    <!-- PAGES & NAVIGATION TAB -->
    <div id="pagesTab" class="tab-content">
      <h2>Pages & Navigation</h2>
      <p>Add pages (and optional sub-pages). Sub-pages become dropdown items under their parent in the nav.</p>
      <div class="buttons">
        <button id="addPageBtn" style="background:#28A745;">Add New Top-Level Page</button>
      </div>
      <div id="pagesContainer"></div>
    </div>

    <!-- REFERENCE LAYOUT TAB -->
    <div id="referenceTab" class="tab-content">
      <h2>Reference Layout via Paste</h2>
      <p>Copy HTML code from another siteâ€™s source and paste it here to extract its parts.</p>
      <div class="field">
        <label for="manualHtmlInput">Paste HTML Code Here:</label>
        <textarea id="manualHtmlInput" rows="10" placeholder="Copy &amp; paste HTML source from another site..."></textarea>
      </div>
      <div class="buttons">
        <button id="importHtmlBtn">Import Layout from Pasted HTML</button>
      </div>
    </div>

    <!-- IMAGES & MEDIA TAB -->
    <div id="imagesTab" class="tab-content">
      <h2>Royalty-Free Images</h2>
      <p>Search for royalty-free images (e.g., from Pexels or Unsplash) and assign them to your sections.</p>
      <div class="field">
        <label for="imageSearchInput">Search Query:</label>
        <input type="text" id="imageSearchInput" placeholder="e.g. 'nature', 'city'..." />
      </div>
      <div class="buttons">
        <button id="imageSearchBtn">Search Images</button>
      </div>
      <div id="imageResults" class="results-grid"></div>
    </div>

    <!-- PREVIEW & CODE TAB (Combined) -->
    <div id="previewCodeTab" class="tab-content">
      <!-- Preview Section -->
      <h2>Live Preview (Home Page)</h2>
      <p>This preview shows only the first top-level page. Nav links are intercepted so you can click sub-pages too.</p>
      <button id="previewBtn" style="margin-bottom:20px;">Update Preview</button>
      <button id="toggleViewSourceBtn">Enable View Source</button>
      <iframe id="previewFrame"></iframe>
      <div id="viewSourcePanel"></div>
      <!-- Editable Panel for Selected Element HTML -->
      <div id="editElementPanel" style="display: none; margin-top: 10px; background: #1f1f1f; padding: 10px; border: 1px solid #3a3a3a; border-radius: 4px;">
        <textarea id="editElementTextarea" style="width:100%; height:150px; font-family:'Courier New', monospace; font-size:0.8rem;"></textarea>
        <button id="updateElementBtn" style="margin-top: 5px;">Update Element</button>
        <button id="pushUpdatesBtn" style="margin-top: 5px;">Push Updates</button>
        <button id="deleteElementBtn" style="margin-top: 5px; background: #e74c3c;">Delete Element</button>
      </div>
      <hr style="margin:20px 0;">
      <!-- Generated Code Section -->
      <h2>Generated Code (All Pages)</h2>
      <p>Each top-level page has exactly one nav bar. Sub-pages appear in a dropdown. Copy each block to a separate .html file.</p>
      <div class="buttons">
        <button id="generateBtn">Generate Site Code</button>
        <button id="clearBtn" style="background:#d9534f;">Clear All</button>
      </div>
      <!-- Search/Replace and Navigation Buttons -->
      <div class="field">
        <label for="codeSearchInput">Search Code:</label>
        <input type="text" id="codeSearchInput" placeholder="Enter search term..." />
        <button id="prevBtn">Previous</button>
        <button id="nextBtn">Next</button>
      </div>
      <div class="field">
        <label for="codeReplaceInput">Replace With:</label>
        <input type="text" id="codeReplaceInput" placeholder="Replacement text" />
      </div>
      <div class="buttons">
        <button id="replaceAllBtn">Replace All</button>
        <button id="exportHTMLBtn">Export as HTML</button>
      </div>
      <textarea id="generatedCode"></textarea>
    </div>
  </div>

  <!-- Modal Styles for Import Options -->
  <style>
    .import-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000;
    }
    .import-modal {
      background: #fff; padding: 20px; border-radius: 5px; max-width: 400px; width: 100%; color: #000;
    }
    .import-modal h3 { margin-bottom: 15px; }
    .import-modal div { margin-bottom: 10px; }
    .import-modal button { padding: 6px 12px; }
  </style>

  <script>
    // TAB FUNCTIONALITY
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-tab');
        tabButtons.forEach(b => b.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(target).classList.add('active');
      });
    });
    document.getElementById('basicTab').classList.add('active');
    tabButtons[0].classList.add('active');

    // GLOBAL / BASIC SETTINGS (elements already defined in HTML)

    // FONT SELECTION FUNCTIONALITY
    const fontsList = [
      { name: "Arial", category: "sans-serif" },
      { name: "Helvetica Neue", category: "sans-serif" },
      { name: "Montserrat", category: "sans-serif" },
      { name: "Times New Roman", category: "serif" },
      { name: "Georgia", category: "serif" },
      { name: "Roboto", category: "sans-serif" },
      { name: "Open Sans", category: "sans-serif" },
      { name: "Lato", category: "sans-serif" },
      { name: "Oswald", category: "sans-serif" },
      { name: "Raleway", category: "sans-serif" },
      { name: "Merriweather", category: "serif" },
      { name: "Ubuntu", category: "sans-serif" },
      { name: "PT Sans", category: "sans-serif" },
      { name: "Source Sans Pro", category: "sans-serif" },
      { name: "Poppins", category: "sans-serif" },
      { name: "Noto Sans", category: "sans-serif" },
      { name: "Noto Serif", category: "serif" },
      { name: "Roboto Condensed", category: "sans-serif" },
      { name: "Dancing Script", category: "script" },
      { name: "Inconsolata", category: "monospace" }
    ];
    let selectedFont = "'Montserrat', sans-serif";
    const fontFamilySearchInput = document.getElementById('fontFamilySearch');
    const fontFamilyContainer = document.getElementById('fontFamilyContainer');
    
    function renderFontList(filter = "") {
      fontFamilyContainer.innerHTML = "";
      const filtered = fontsList.filter(f => f.name.toLowerCase().includes(filter.toLowerCase()));
      filtered.forEach(f => {
        const fontDiv = document.createElement('div');
        fontDiv.textContent = f.name;
        fontDiv.style.fontFamily = f.name + ", sans-serif";
        fontDiv.style.padding = "5px";
        fontDiv.style.cursor = "pointer";
        if (selectedFont.indexOf(f.name) !== -1) {
          fontDiv.style.backgroundColor = "#4A88F6";
          fontDiv.style.color = "#fff";
        }
        fontDiv.addEventListener('click', () => {
          selectedFont = f.name + ", sans-serif";
          renderFontList(fontFamilySearchInput.value);
        });
        fontFamilyContainer.appendChild(fontDiv);
      });
    }
    
    fontFamilySearchInput.addEventListener('input', function() {
      renderFontList(this.value);
    });
    
    renderFontList();

    // PAGE & NAVIGATION
    const pagesContainer = document.getElementById('pagesContainer');
    const addPageBtn = document.getElementById('addPageBtn');
    let pageCount = 0;
    let pages = [];
    addPageBtn.addEventListener('click', () => { createPageEditor(null); });

    function createPageEditor(parentPage) {
      const pageId = pageCount++;
      const pageObj = { id: pageId, title: "Untitled Page", layout: "single", sections: [], subPages: [], importedParts: null };
      if (parentPage) { parentPage.subPages.push(pageObj); }
      else { pages.push(pageObj); }
      const pageDiv = document.createElement('div');
      pageDiv.classList.add('pageItem');
      pageDiv.setAttribute('data-pageid', pageId);
      const pageLevel = parentPage ? "Sub-page" : "Page";
      pageDiv.innerHTML = `
        <div class="pageHeader">
          <h3>${pageLevel} Editor (ID: ${pageId})</h3>
          <button class="removePageBtn">Remove</button>
        </div>
        <div class="field">
          <label>Page Title (used for navigation label):</label>
          <input type="text" class="pageTitleInput" value="${pageLevel} ${pageId}" />
        </div>
        <div class="field">
          <label>Layout Style:</label>
          <select class="pageLayoutSelect">
            <option value="single">Single Column</option>
            <option value="two">Two Columns</option>
            <option value="grid">Grid</option>
            <option value="masonry">Masonry</option>
            <option value="cards">Cards</option>
            <option value="three">Three Columns</option>
            <option value="heroGrid">Hero + Grid</option>
            <option value="splitBanner">Split Banner</option>
            <option value="minimalist">Minimalist</option>
            <option value="ReferencedSiteLayout">ReferencedSiteLayout</option>
          </select>
        </div>
        <h4 style="margin:10px 0; color:#fff;">Sections</h4>
        <div class="sectionContainer"></div>
        <div class="buttons">
          <button class="addSectionBtn" style="background:#28A745;">Add Section</button>
          ${!parentPage ? '<button class="addSubPageBtn" style="background:#5bc0de;">Add Sub-Page</button>' : ''}
        </div>
      `;
      if (parentPage) {
        const parentDiv = pagesContainer.querySelector(`.pageItem[data-pageid="${parentPage.id}"]`);
        if (!parentDiv) { pagesContainer.appendChild(pageDiv); }
        else { parentDiv.insertAdjacentElement('afterend', pageDiv); }
      } else { pagesContainer.appendChild(pageDiv); }
      pageDiv.querySelector('.removePageBtn').addEventListener('click', () => { removePage(pageObj, pageDiv); });
      const titleInput = pageDiv.querySelector('.pageTitleInput');
      titleInput.addEventListener('input', (e) => { pageObj.title = e.target.value.trim(); });
      pageObj.title = titleInput.value;
      const layoutSelect = pageDiv.querySelector('.pageLayoutSelect');
      layoutSelect.addEventListener('change', (e) => { pageObj.layout = e.target.value; });
      pageObj.layout = layoutSelect.value;
      const sectionContainer = pageDiv.querySelector('.sectionContainer');
      pageDiv.querySelector('.addSectionBtn').addEventListener('click', () => { createSectionEditor(pageObj, sectionContainer); });
      if (!parentPage) {
        const addSubPageBtn = pageDiv.querySelector('.addSubPageBtn');
        if(addSubPageBtn) { addSubPageBtn.addEventListener('click', () => { createPageEditor(pageObj); }); }
      }
    }

    function removePage(pageObj, pageDiv) {
      if (pageObj) { pageObjSubSearch(pageObj.id, pages); }
      pageDiv.remove();
    }

    function pageObjSubSearch(id, pageArr) {
      for (let i = 0; i < pageArr.length; i++) {
        if (pageArr[i].id === id) { pageArr.splice(i, 1); return true; }
        else if (pageArr[i].subPages.length > 0) {
          const found = pageObjSubSearch(id, pageArr[i].subPages);
          if (found) return true;
        }
      }
      return false;
    }

    // SECTION EDITOR
    function createSectionEditor(pageObj, containerEl, fetchedSectionData = null) {
      const sectionData = fetchedSectionData || {
        heading: "", paragraph: "", iconLibrary: "none", iconValue: "",
        art: "", image: "", bgType: "none", bgColor: "#ffffff", bgImage: "",
        headingColor: "", paragraphColor: "", breakCount: 0, paragraphIndent: 0, customHTML: null
      };
      pageObj.sections.push(sectionData);
      const secDiv = document.createElement('div');
      secDiv.classList.add('sectionItem');
      secDiv.innerHTML = `
        <div class="reorder-btns">
          <button class="moveUpBtn">&#9650;</button>
          <button class="moveDownBtn">&#9660;</button>
        </div>
        <div class="field">
          <label>Section Heading (leave blank if desired):</label>
          <input type="text" class="secHeading" placeholder="Enter heading (optional)" />
        </div>
        <div class="field">
          <label>Section Paragraph:</label>
          <textarea rows="4" class="secParagraph" placeholder="Enter paragraph"></textarea>
        </div>
        <div class="field">
          <label>Breaks after Heading (number of breaks):</label>
          <input type="number" class="secBreakCount" value="0" min="0" />
        </div>
        <div class="field">
          <label>Paragraph Indentation (px):</label>
          <input type="number" class="secParagraphIndent" value="0" min="0" />
        </div>
        <div class="field">
          <label>Icon Library:</label>
          <select class="iconLibrarySelect">
            <option value="none">No Icon</option>
            <option value="fontAwesome">Font Awesome</option>
            <option value="materialIcons">Google Material Icons</option>
            <option value="nounProject">Noun Project (URL)</option>
          </select>
        </div>
        <div class="field">
          <div class="iconValueContainer" style="margin: 5px 0;"><div class="iconValueFields"></div></div>
        </div>
        <div class="field">
          <label>Royalty-Free Art/Image URL (Optional):</label>
          <input type="text" class="secArt" placeholder="https://example.com/art.jpg" />
        </div>
        <div class="field">
          <label>Image URL (Optional):</label>
          <input type="text" class="secImage" placeholder="Another optional image URL" />
        </div>
        <hr style="margin:10px 0; border:none; border-top:1px solid #444;" />
        <div class="field">
          <label>Section Background Type:</label>
          <select class="bgTypeSelect">
            <option value="none">No Override</option>
            <option value="color">Color</option>
            <option value="graphic">Graphic</option>
          </select>
        </div>
        <div class="field bgColorField" style="display:none;">
          <label>Section Background Color:</label>
          <input type="color" class="secBgColor" value="#ffffff" />
        </div>
        <div class="field bgImageField" style="display:none;">
          <label>Section Background Image URL:</label>
          <input type="text" class="secBgImage" placeholder="https://example.com/background.jpg" />
        </div>
        <div class="field">
          <label>Heading Text Color (optional):</label>
          <input type="color" class="secHeadingColor" value="" />
        </div>
        <div class="field">
          <label>Paragraph Text Color (optional):</label>
          <input type="color" class="secParagraphColor" value="" />
        </div>
        <button class="removeSectionBtn" style="background:#d9534f; margin-top:8px;">Remove Section</button>
      `;
      containerEl.appendChild(secDiv);
      const headingInput = secDiv.querySelector('.secHeading');
      const paragraphInput = secDiv.querySelector('.secParagraph');
      const breakCountInput = secDiv.querySelector('.secBreakCount');
      const paragraphIndentInput = secDiv.querySelector('.secParagraphIndent');
      const iconLibrarySelect = secDiv.querySelector('.iconLibrarySelect');
      const iconValueContainer = secDiv.querySelector('.iconValueContainer .iconValueFields');
      const artInput = secDiv.querySelector('.secArt');
      const imageInput = secDiv.querySelector('.secImage');
      const bgTypeSelect = secDiv.querySelector('.bgTypeSelect');
      const bgColorField = secDiv.querySelector('.bgColorField');
      const bgImageField = secDiv.querySelector('.bgImageField');
      const secBgColor = secDiv.querySelector('.secBgColor');
      const secBgImage = secDiv.querySelector('.secBgImage');
      const secHeadingColor = secDiv.querySelector('.secHeadingColor');
      const secParagraphColor = secDiv.querySelector('.secParagraphColor');
      const removeSectionBtn = secDiv.querySelector('.removeSectionBtn');
      const moveUpBtn = secDiv.querySelector('.moveUpBtn');
      const moveDownBtn = secDiv.querySelector('.moveDownBtn');
      headingInput.value = sectionData.heading;
      paragraphInput.value = sectionData.paragraph;
      breakCountInput.value = sectionData.breakCount;
      paragraphIndentInput.value = sectionData.paragraphIndent;
      iconLibrarySelect.value = sectionData.iconLibrary;
      artInput.value = sectionData.art;
      imageInput.value = sectionData.image;
      bgTypeSelect.value = sectionData.bgType;
      secBgColor.value = sectionData.bgColor;
      secBgImage.value = sectionData.bgImage;
      secHeadingColor.value = sectionData.headingColor;
      secParagraphColor.value = sectionData.paragraphColor;
      function updateBgFields() {
        if (bgTypeSelect.value === "color") { bgColorField.style.display = "block"; bgImageField.style.display = "none"; }
        else if (bgTypeSelect.value === "graphic") { bgColorField.style.display = "none"; bgImageField.style.display = "block"; }
        else { bgColorField.style.display = "none"; bgImageField.style.display = "none"; }
      }
      updateBgFields();
      bgTypeSelect.addEventListener('change', () => { sectionData.bgType = bgTypeSelect.value; updateBgFields(); });
      secBgColor.addEventListener('input', e => { sectionData.bgColor = e.target.value; });
      secBgImage.addEventListener('input', e => { sectionData.bgImage = e.target.value.trim(); });
      secHeadingColor.addEventListener('input', e => { sectionData.headingColor = e.target.value; });
      secParagraphColor.addEventListener('input', e => { sectionData.paragraphColor = e.target.value; });
      headingInput.addEventListener('input', e => { sectionData.heading = e.target.value; });
      paragraphInput.addEventListener('input', e => { sectionData.paragraph = e.target.value; });
      breakCountInput.addEventListener('input', e => { sectionData.breakCount = parseInt(e.target.value, 10) || 0; });
      paragraphIndentInput.addEventListener('input', e => { sectionData.paragraphIndent = parseInt(e.target.value, 10) || 0; });
      artInput.addEventListener('input', e => { sectionData.art = e.target.value.trim(); });
      imageInput.addEventListener('input', e => { sectionData.image = e.target.value.trim(); });
      iconLibrarySelect.addEventListener('change', () => { sectionData.iconLibrary = iconLibrarySelect.value; renderIconField(); });
      function renderIconField() {
        iconValueContainer.innerHTML = "";
        const currentLib = iconLibrarySelect.value;
        if (currentLib === "none") { sectionData.iconValue = ""; return; }
        else if (currentLib === "fontAwesome") {
          const selectEl = document.createElement('select');
          selectEl.innerHTML = `
            <option value="">(Select an icon)</option>
            <option value="fa fa-user">User</option>
            <option value="fa fa-star">Star</option>
            <option value="fa fa-heart">Heart</option>
            <option value="fa fa-check">Check</option>
            <option value="fa fa-cog">Cog</option>
          `;
          selectEl.value = sectionData.iconValue;
          selectEl.addEventListener('change', e => { sectionData.iconValue = e.target.value; });
          iconValueContainer.appendChild(selectEl);
        } else if (currentLib === "materialIcons") {
          const inputEl = document.createElement('input');
          inputEl.type = "text"; inputEl.placeholder = "e.g. 'face', 'home', etc.";
          inputEl.value = sectionData.iconValue || "";
          inputEl.addEventListener('input', e => { sectionData.iconValue = e.target.value.trim(); });
          iconValueContainer.appendChild(inputEl);
        } else if (currentLib === "nounProject") {
          const inputEl = document.createElement('input');
          inputEl.type = "text"; inputEl.placeholder = "e.g. https://thenounproject.com/.../icon.svg";
          inputEl.value = sectionData.iconValue || "";
          inputEl.addEventListener('input', e => { sectionData.iconValue = e.target.value.trim(); });
          iconValueContainer.appendChild(inputEl);
        }
      }
      renderIconField();
      removeSectionBtn.addEventListener('click', () => {
        const idx = pageObj.sections.indexOf(sectionData);
        if (idx !== -1) { pageObj.sections.splice(idx, 1); }
        secDiv.remove();
      });
      moveUpBtn.addEventListener('click', () => {
        const idx = pageObj.sections.indexOf(sectionData);
        if (idx > 0) {
          [pageObj.sections[idx - 1], pageObj.sections[idx]] = [pageObj.sections[idx], pageObj.sections[idx - 1]];
          containerEl.insertBefore(secDiv, containerEl.children[idx - 1]);
        }
      });
      moveDownBtn.addEventListener('click', () => {
        const idx = pageObj.sections.indexOf(sectionData);
        if (idx < pageObj.sections.length - 1) {
          [pageObj.sections[idx], pageObj.sections[idx + 1]] = [pageObj.sections[idx + 1], pageObj.sections[idx]];
          containerEl.insertBefore(secDiv, containerEl.children[idx + 2]);
        }
      });
    }

    // IMPORT LAYOUT FUNCTIONALITY
    const importHtmlBtn = document.getElementById('importHtmlBtn');
    const manualHtmlInput = document.getElementById('manualHtmlInput');
    importHtmlBtn.addEventListener('click', () => {
      const htmlString = manualHtmlInput.value.trim();
      if (!htmlString) { alert("Please paste some HTML code first."); return; }
      const parts = separateHTMLParts(htmlString);
      showImportOptions(parts, (selectedParts) => {
        const pageId = prompt("Enter the Page ID to insert these imported parts (e.g., 0, 1, etc.):");
        if (pageId === null) return;
        const targetPage = findPageById(parseInt(pageId, 10), pages);
        if (!targetPage) { alert("Page not found."); return; }
        targetPage.importedParts = selectedParts;
        targetPage.layout = "ReferencedSiteLayout";
        const pageDiv = document.querySelector(`.pageItem[data-pageid="${targetPage.id}"]`);
        const layoutSelect = pageDiv.querySelector('.pageLayoutSelect');
        if (layoutSelect) { layoutSelect.value = "ReferencedSiteLayout"; }
        alert("Imported selected HTML parts into the page!");
      });
    });
    function separateHTMLParts(htmlString) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlString, "text/html");
      let headContent = doc.head ? doc.head.innerHTML : "";
      let bodyContent = doc.body ? doc.body.innerHTML : "";
      let styleContent = "";
      let scriptContent = "";
      const styleElements = doc.head ? doc.head.querySelectorAll("style") : [];
      styleElements.forEach(styleEl => { styleContent += styleEl.outerHTML; headContent = headContent.replace(styleEl.outerHTML, ""); });
      const scriptElements = doc.querySelectorAll("script");
      scriptElements.forEach(scriptEl => {
        scriptContent += scriptEl.outerHTML;
        if (scriptEl.parentNode.tagName.toLowerCase() === "head") { headContent = headContent.replace(scriptEl.outerHTML, ""); }
        else if (scriptEl.parentNode.tagName.toLowerCase() === "body") { bodyContent = bodyContent.replace(scriptEl.outerHTML, ""); }
      });
      return { head: headContent.trim(), style: styleContent.trim(), body: bodyContent.trim(), scripts: scriptContent.trim() };
    }
    function showImportOptions(parts, callback) {
      const overlay = document.createElement('div');
      overlay.className = "import-overlay";
      const modal = document.createElement('div');
      modal.className = "import-modal";
      modal.innerHTML = `
        <h3>Select HTML Parts to Import</h3>
        <div><input type="checkbox" id="importHead" checked> <label for="importHead">Head (meta, title, etc.)</label></div>
        <div><input type="checkbox" id="importStyle" checked> <label for="importStyle">Style (CSS)</label></div>
        <div><input type="checkbox" id="importBody" checked> <label for="importBody">Body (Content)</label></div>
        <div><input type="checkbox" id="importScripts" checked> <label for="importScripts">Scripts (JS)</label></div>
        <div style="margin-top: 15px; text-align: right;">
          <button id="cancelImport">Cancel</button>
          <button id="confirmImport" style="margin-left: 10px;">Confirm</button>
        </div>
      `;
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      document.getElementById('cancelImport').addEventListener('click', () => { document.body.removeChild(overlay); });
      document.getElementById('confirmImport').addEventListener('click', () => {
        const selectedParts = {};
        if (document.getElementById('importHead').checked) { selectedParts.head = parts.head; }
        if (document.getElementById('importStyle').checked) { selectedParts.style = parts.style; }
        if (document.getElementById('importBody').checked) { selectedParts.body = parts.body; }
        if (document.getElementById('importScripts').checked) { selectedParts.scripts = parts.scripts; }
        document.body.removeChild(overlay);
        callback(selectedParts);
      });
    }
    function findPageById(id, pageArr) {
      for (let p of pageArr) {
        if (p.id === id) return p;
        if (p.subPages && p.subPages.length > 0) {
          const found = findPageById(id, p.subPages);
          if (found) return found;
        }
      }
      return null;
    }

    // IMAGES & MEDIA
    const imageSearchInput = document.getElementById('imageSearchInput');
    const imageSearchBtn = document.getElementById('imageSearchBtn');
    const imageResults = document.getElementById('imageResults');
    imageSearchBtn.addEventListener('click', async () => {
      const query = imageSearchInput.value.trim();
      if (!query) { imageResults.innerHTML = "<p style='color:red;'>Please enter a search term.</p>"; return; }
      imageResults.innerHTML = "Searching...";
      try {
        let response = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=77`, {
          headers: { Authorization: "2mxS3gi2IIXAmd4anXuVaaNs5k98X0F6KaTpszZYFCJstNfWXVH71gN1" }
        });
        if (!response.ok) { imageResults.innerHTML = "<p style='color:red;'>Error fetching images.</p>"; return; }
        const data = await response.json();
        const images = data.photos || [];
        if (!images.length) { imageResults.innerHTML = "<p style='color:#bbb;'>No results found.</p>"; return; }
        imageResults.innerHTML = "";
        images.forEach(imgObj => {
          const imgUrl = imgObj.src.small;
          const altText = imgObj.alt || "No description";
          const wrapper = document.createElement('div');
          wrapper.classList.add('imageResult');
          wrapper.innerHTML = `
            <img src="${imgUrl}" alt="${altText}" />
            <div class="assign-btns">
              <button class="assignArtBtn">Assign as Art</button>
              <button class="assignImageBtn">Assign as Image</button>
            </div>
          `;
          imageResults.appendChild(wrapper);
          const assignArtBtn = wrapper.querySelector('.assignArtBtn');
          const assignImageBtn = wrapper.querySelector('.assignImageBtn');
          assignArtBtn.addEventListener('click', () => openAssignModal(imgUrl, "art"));
          assignImageBtn.addEventListener('click', () => openAssignModal(imgUrl, "image"));
        });
      } catch (err) {
        console.error(err);
        imageResults.innerHTML = "<p style='color:red;'>Failed to retrieve images.</p>";
      }
    });
    function openAssignModal(imgUrl, targetField) {
      const allPages = flattenPages(pages);
      if (!allPages.length) { alert("No pages/sections available. Please add some pages first."); return; }
      const sectionSelectData = [];
      allPages.forEach(pg => { pg.sections.forEach((sec, idx) => { sectionSelectData.push({ pageId: pg.id, pageTitle: pg.title, sectionIndex: idx }); }); });
      if (!sectionSelectData.length) { alert("No sections available. Please add a section first."); return; }
      let msg = "Select a section to assign the image:\n";
      sectionSelectData.forEach((sd, i) => { msg += `${i}) Page "${sd.pageTitle}" - Section ${sd.sectionIndex}\n`; });
      const choice = prompt(msg + "\nEnter the index number:", "0");
      const idx = parseInt(choice, 10);
      if (isNaN(idx) || idx < 0 || idx >= sectionSelectData.length) { alert("Invalid selection."); return; }
      const chosen = sectionSelectData[idx];
      const targetPage = findPageById(chosen.pageId, pages);
      if (!targetPage || !targetPage.sections[chosen.sectionIndex]) { alert("Could not find chosen section."); return; }
      if (targetField === "art") { targetPage.sections[chosen.sectionIndex].art = imgUrl; }
      else { targetPage.sections[chosen.sectionIndex].image = imgUrl; }
      const pageDiv = document.querySelector(`.pageItem[data-pageid="${targetPage.id}"]`);
      if (pageDiv) {
        const sectionContainer = pageDiv.querySelector('.sectionContainer');
        const allSectionItems = sectionContainer.querySelectorAll('.sectionItem');
        const secItem = allSectionItems[chosen.sectionIndex];
        if (secItem) {
          if (targetField === "art") { secItem.querySelector('.secArt').value = imgUrl; }
          else { secItem.querySelector('.secImage').value = imgUrl; }
        }
      }
      alert(`Assigned image to Page "${targetPage.title}", Section ${chosen.sectionIndex}, Field: ${targetField}.`);
    }

    // PREVIEW & CODE GENERATION
    function buildPageHTML(pageObj, isPreviewNav) {
      const gFont = selectedFont || "Arial, sans-serif";
      const fontName = gFont.split(',')[0].replace(/['"]/g, '').trim();
      const googleFonts = {
        "Montserrat": "https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap",
        "Roboto": "https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap",
        "Open Sans": "https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap",
        "Lato": "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",
        "Oswald": "https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&display=swap",
        "Raleway": "https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700&display=swap",
        "Merriweather": "https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap",
        "Ubuntu": "https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap",
        "PT Sans": "https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap",
        "Source Sans Pro": "https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap",
        "Poppins": "https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap",
        "Noto Sans": "https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;700&display=swap",
        "Noto Serif": "https://fonts.googleapis.com/css2?family=Noto+Serif:wght@300;400;600;700&display=swap",
        "Roboto Condensed": "https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap",
        "Dancing Script": "https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;700&display=swap",
        "Inconsolata": "https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap"
      };
      let fontLink = "";
      if (googleFonts[fontName]) {
          fontLink = `<link href="${googleFonts[fontName]}" rel="stylesheet">`;
      }

      const pageTitle = pageObj.title.trim() || "Untitled Page";
      if (pageObj.layout === "ReferencedSiteLayout" && pageObj.importedParts) {
        return `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>${pageTitle}</title>
  ${ checkIconUse(pageObj, "fontAwesome") ? `<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">` : "" }
  ${ checkIconUse(pageObj, "materialIcons") ? `<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />` : "" }
  ${fontLink}
  <style>
    body {
      background-color: ${globalBgColor.value};
      ${globalBgImage.value ? `background-image: url('${globalBgImage.value}'); background-size: cover; background-repeat: no-repeat;` : ''}
      color: ${globalTextColor.value};
      font-family: ${gFont};
      font-size: ${globalFontSize.value}px;
      line-height: ${globalLineHeight.value};
      margin: 0; padding: 0;
    }
    a { color: ${globalLinkColor.value}; }
    ${ pageObj.importedParts.style || '' }
  </style>
  ${ pageObj.importedParts.head || '' }
</head>
<body>
  ${ includeNav.checked && isTopLevel(pageObj) ? buildNavHTML(pages, isPreviewNav) : '' }
  ${ pageObj.importedParts.body || '' }
  ${ pageObj.importedParts.scripts || '' }
</body>
</html>`.trim();
      }
      const sectionsHTML = buildSectionsHTML(pageObj.sections, pageObj.id);
      let navHTML = "";
      if (includeNav.checked && isTopLevel(pageObj)) { navHTML = buildNavHTML(pages, isPreviewNav); }
      let layoutCSS = (pageObj.layout === "ReferencedSiteLayout") ? getReferencedLayoutCSS(pageObj) : getLayoutCSS(pageObj.layout);
      const usedFA = checkIconUse(pageObj, "fontAwesome");
      const usedMI = checkIconUse(pageObj, "materialIcons");
      const faLink = usedFA ? `<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">\n` : "";
      const materialIconsLink = usedMI ? `<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />\n` : "";
      const gBg = globalBgColor.value;
      const gTxt = globalTextColor.value;
      const gHead = globalHeadingColor.value;
      const gFontSize = globalFontSize.value;
      const gLineHeight = globalLineHeight.value;
      const gLinkColor = globalLinkColor.value;
      const gBgImage = globalBgImage.value.trim();
      const customCSS = globalCustomCSS.value;
      const metaDesc = "Page: " + pageTitle;
      return `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title data-page-id="${pageObj.id}">${pageTitle}</title>
  <meta name="description" content="${metaDesc}">
  ${faLink}${materialIconsLink}${fontLink}
  <style>
    body {
      background-color: ${gBg};
      ${gBgImage ? `background-image: url('${gBgImage}'); background-size: cover; background-repeat: no-repeat;` : ''}
      color: ${gTxt};
      font-family: ${gFont};
      font-size: ${gFontSize}px;
      line-height: ${gLineHeight};
      margin: 0; padding: 0;
    }
    a { color: ${gLinkColor}; }
    .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
    h1, h2, h3 { color: ${gHead}; margin-bottom: 15px; }
    p { margin-bottom: 15px; }
    ${layoutCSS}
    nav { background: ${gHead}; padding: 15px; }
    nav ul {
      list-style: none; display: flex; gap: 20px; margin: 0; padding: 0; align-items: center; position: relative;
    }
    nav li { position: relative; }
    nav a { color: ${gBg}; text-decoration: none; font-weight: bold; }
    .submenu {
      position: absolute; display: none; top: 50px; left: 0; flex-direction: column;
      background-color: ${gHead}; padding: 10px; border-radius: 5px;
    }
    .submenu li { margin: 5px 0; }
    .has-submenu:hover .submenu { display: flex; }
    .has-submenu > a::after { content: " \\25BC"; margin-left: 5px; font-size: 0.8em; }
    .layout-container {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; padding: 20px;
    }
    .layout-container .layout-item {
      background-color: ${gBg}; color: ${gTxt}; padding: 20px; border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .layout-container .layout-item:hover {
      transform: translateY(-3px); box-shadow: 0 8px 12px rgba(0,0,0,0.15);
    }
    ${customCSS}
  </style>
</head>
<body>
  ${navHTML}
  <div class="container">
    <h1>${pageTitle}</h1>
    <div class="layout-container">
      ${sectionsHTML}
    </div>
  </div>
</body>
</html>`.trim();
    }
    function buildSectionsHTML(sections, pageId) {
      let html = "";
      sections.forEach((sec, index) => {
        if (sec.customHTML) {
          html += `<div class="layout-item" data-page-id="${pageId}" data-section-index="${index}">${sec.customHTML}</div>`;
        } else {
          const heading = sec.heading || "";
          const paragraph = sec.paragraph || "Lorem ipsum dolor sit amet.";
          let iconHTML = "";
          if (sec.iconLibrary === "fontAwesome" && sec.iconValue) {
            iconHTML = `<i class="${sec.iconValue}" style="margin-right:8px;"></i>`;
          } else if (sec.iconLibrary === "materialIcons" && sec.iconValue) {
            iconHTML = `<span class="material-symbols-outlined" style="vertical-align: middle; margin-right:4px;">${sec.iconValue}</span>`;
          } else if (sec.iconLibrary === "nounProject" && sec.iconValue) {
            iconHTML = `<img src="${sec.iconValue}" alt="Icon" style="width:24px; height:auto; margin-right:8px; vertical-align:middle;" />`;
          }
          let artHTML = sec.art ? `<img src="${sec.art}" alt="Art" style="max-width:100%; height:auto; margin:15px 0;" />` : "";
          let imageHTML = sec.image ? `<img src="${sec.image}" alt="Section" style="max-width:100%; height:auto; margin:15px 0;" />` : "";
          let headingHTML = "";
          if (heading.trim() !== "") {
            headingHTML = `<h2 style="${sec.headingColor ? `color:${sec.headingColor};` : ''} margin-bottom:15px;">${iconHTML}${heading}</h2>`;
            if (sec.breakCount && sec.breakCount > 0) {
              let breaksHTML = "";
              for (let i = 0; i < sec.breakCount; i++) { breaksHTML += "<br>"; }
              headingHTML += breaksHTML;
            }
          }
          let paragraphStyleContent = sec.paragraphColor ? `color:${sec.paragraphColor};` : "";
          paragraphStyleContent += " margin-bottom:15px;";
          if (sec.paragraphIndent && sec.paragraphIndent > 0) {
            paragraphStyleContent += ` text-indent:${sec.paragraphIndent}px;`;
          }
          const paragraphStyle = `style="${paragraphStyleContent}"`;
          const bgStyle = sec.bgType === "color" ? `background:${sec.bgColor};` : sec.bgType === "graphic" ? `background:url('${sec.bgImage}') center center / cover no-repeat;` : '';
          html += `
          <div class="layout-item" data-page-id="${pageId}" data-section-index="${index}" style="${bgStyle}">
            ${headingHTML}
            <p ${paragraphStyle}>${paragraph}</p>
            ${artHTML}
            ${imageHTML}
          </div>
        `;
        }
      });
      return html;
    }
    function buildNavHTML(pageArr, isPreviewNav) {
      if (!pageArr.length) return "";
      let nav = `<nav><ul>`;
      pageArr.forEach(pageObj => {
        const fname = pageFilename(pageObj);
        const label = pageObj.title || "Untitled";
        if (pageObj.subPages && pageObj.subPages.length) {
          nav += `
          <li class="has-submenu">
            ${buildNavLink(fname, label, isPreviewNav)}
            <ul class="submenu">`;
          pageObj.subPages.forEach(sp => {
            const sfname = pageFilename(sp);
            const slabel = sp.title || "Untitled";
            nav += `<li>${buildNavLink(sfname, slabel, isPreviewNav)}</li>`;
          });
          nav += `</ul></li>`;
        } else {
          nav += `<li>${buildNavLink(fname, label, isPreviewNav)}</li>`;
        }
      });
      nav += `</ul></nav>`;
      return nav;
    }
    function buildNavLink(filename, label, isPreviewNav) {
      if (isPreviewNav) {
        return `<a href="${filename}" onclick="if(window.parent && window.parent.openPageInPreview){window.parent.openPageInPreview('${filename}');return false;}">${label}</a>`;
      } else { return `<a href="${filename}">${label}</a>`; }
    }
    function getReferencedLayoutCSS(pageObj) {
      const bg = "#ffffff", txt = "#000000";
      return `
.layout-container { display: block; background-color: ${bg}; color: ${txt}; padding: 20px; border-radius: 5px; }
.layout-item { margin-bottom: 40px; }
      `;
    }
    function getLayoutCSS(layoutValue) {
      if (layoutValue === 'single') {
        return `
.layout-container { display: block; }
.layout-item { margin-bottom: 40px; }
        `;
      } else if (layoutValue === 'two') {
        return `
.layout-container { display: flex; flex-wrap: wrap; gap: 20px; }
.layout-item { flex: 1 1 calc(50% - 20px); margin-bottom: 20px; background: #f8f8f8; color: #000; padding: 20px; border-radius: 5px; }
@media (max-width: 768px) { .layout-item { flex: 1 1 100%; } }
        `;
      } else if (layoutValue === 'grid') {
        return `
.layout-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
.layout-item { background: #f8f8f8; color: #000; padding: 20px; border-radius: 5px; }
        `;
      } else if (layoutValue === 'masonry') {
        return `
.layout-container { column-count: 3; column-gap: 20px; }
.layout-item { display: inline-block; width: 100%; margin-bottom: 20px; background: #f8f8f8; color: #000; padding: 20px; border-radius: 5px; }
@media (max-width: 992px) { .layout-container { column-count: 2; } }
@media (max-width: 576px) { .layout-container { column-count: 1; } }
        `;
      } else if (layoutValue === 'cards') {
        return `
.layout-container { display: flex; flex-wrap: wrap; gap: 20px; }
.layout-item { background: #f8f8f8; color: #000; border-radius: 5px; padding: 20px; width: 100%; max-width: 300px; }
        `;
      } else if (layoutValue === 'three') {
        return `
.layout-container { display: flex; gap: 20px; }
.layout-item { flex: 1; background: #f8f8f8; color: #000; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
@media (max-width: 768px) { .layout-container { flex-direction: column; } }
        `;
      } else if (layoutValue === 'heroGrid') {
        return `
.layout-container { display: grid; grid-template-rows: 300px auto; gap: 20px; }
.layout-container .layout-item:first-child { grid-row: 1; background: #4A88F6; color: #fff; display: flex; align-items: center; justify-content: center; }
.layout-container .layout-item:first-child h2 { margin-bottom: 0; }
.layout-container .layout-item:not(:first-child) { background: #f8f8f8; color: #000; padding: 20px; border-radius: 5px; }
@media (max-width: 768px) { .layout-container { grid-template-rows: 200px auto; } }
        `;
      } else if (layoutValue === 'splitBanner') {
        return `
.layout-container { display: flex; flex-wrap: wrap; gap: 20px; }
.layout-item { background: #f8f8f8; color: #000; padding: 20px; border-radius: 5px; width: 100%; }
.layout-item:first-child { display: flex; flex: 1 1 100%; background: #4A88F6; color: #ffffff; margin-bottom: 0; align-items: center; justify-content: center; }
.layout-item:first-child h2 { margin: 0; }
@media (max-width: 768px) { .layout-item:first-child { flex-direction: column; text-align: center; height: auto; } }
        `;
      } else if (layoutValue === 'minimalist') {
        return `
.layout-container { display: block; padding: 20px; }
.layout-item { border-bottom: 1px solid #ccc; padding: 20px 0; background: #fff; color: #000; }
.layout-item:last-child { border-bottom: none; }
        `;
      } else {
        return `
.layout-container { display: block; }
.layout-item { margin-bottom: 40px; }
        `;
      }
    }
    function checkIconUse(pageObj, libraryType) {
      const pageHasIcons = pageObj.sections.some(s => s.iconLibrary === libraryType && s.iconValue);
      if (pageHasIcons) return true;
      if (pageObj.subPages && pageObj.subPages.length > 0) {
        for (let sp of pageObj.subPages) { if (checkIconUse(sp, libraryType)) return true; }
      }
      return false;
    }
    // VIEW SOURCE FUNCTIONALITY & UPDATE ELEMENT
    let viewSourceEnabled = false;
    const toggleViewSourceBtn = document.getElementById('toggleViewSourceBtn');
    const viewSourcePanel = document.getElementById('viewSourcePanel');
    toggleViewSourceBtn.addEventListener('click', function() {
      viewSourceEnabled = !viewSourceEnabled;
      this.textContent = viewSourceEnabled ? "Disable View Source" : "Enable View Source";
      const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
      if (viewSourceEnabled) { attachViewSourceListeners(iframeDoc); }
      else { detachViewSourceListeners(iframeDoc); removeHighlight(); viewSourcePanel.style.display = "none"; }
    });
    function attachViewSourceListeners(doc) {
      if (!doc) return;
      doc.addEventListener('mouseover', handleElementMouseOver);
      doc.addEventListener('mouseout', handleElementMouseOut);
      doc.addEventListener('click', handleElementClick);
      if (doc.head) {
        const titleElem = doc.head.querySelector('title');
        if (titleElem) {
          titleElem.style.cursor = 'pointer';
          titleElem.addEventListener('click', handleElementClick);
        }
      }
    }
    function detachViewSourceListeners(doc) {
      if (!doc) return;
      doc.removeEventListener('mouseover', handleElementMouseOver);
      doc.removeEventListener('mouseout', handleElementMouseOut);
      doc.removeEventListener('click', handleElementClick);
      if (doc.head) {
        const titleElem = doc.head.querySelector('title');
        if (titleElem) {
          titleElem.removeEventListener('click', handleElementClick);
        }
      }
    }
    function handleElementMouseOver(e) {
      e.stopPropagation();
      const target = e.target;
      target.style.outline = "2px solid red";
      viewSourcePanel.textContent = target.outerHTML;
      viewSourcePanel.style.top = (e.clientY + 10) + "px";
      viewSourcePanel.style.left = (e.clientX + 10) + "px";
      viewSourcePanel.style.display = "block";
    }
    function handleElementMouseOut(e) {
      e.stopPropagation();
      const target = e.target;
      target.style.outline = "";
      viewSourcePanel.style.display = "none";
    }
    function handleElementClick(e) {
      e.preventDefault();
      e.stopPropagation();
      const target = e.target;
      const elementHTML = target.outerHTML;
      const editPanel = document.getElementById('editElementPanel');
      const editTextarea = document.getElementById('editElementTextarea');
      editTextarea.value = elementHTML;
      editTextarea.select();
      editPanel.style.display = 'block';
      window.currentlySelectedElement = target;
    }
    function removeHighlight() {
      const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
      if (iframeDoc) { iframeDoc.querySelectorAll('*').forEach(elem => { elem.style.outline = ""; }); }
    }
    function performUpdateElement() {
      const newHTML = document.getElementById('editElementTextarea').value;
      // If newHTML is empty, delete the element (if it's not a title)
      if (!newHTML.trim()) {
        if (window.currentlySelectedElement) {
          if (window.currentlySelectedElement.tagName.toLowerCase() === 'title') {
            alert("Deleting the title element is not allowed.");
            return false;
          }
          const pageId = window.currentlySelectedElement.getAttribute('data-page-id');
          const sectionIndex = window.currentlySelectedElement.getAttribute('data-section-index');
          if (pageId !== null && sectionIndex !== null) {
            const targetPage = findPageById(parseInt(pageId, 10), pages);
            if (targetPage) {
              targetPage.sections.splice(parseInt(sectionIndex, 10), 1);
            }
          }
          window.currentlySelectedElement.parentNode.removeChild(window.currentlySelectedElement);
          window.currentlySelectedElement = null;
          document.getElementById('editElementPanel').style.display = 'none';
          return true;
        }
        return false;
      }
      if (window.currentlySelectedElement) {
        if (window.currentlySelectedElement.tagName.toLowerCase() === 'title') {
          const pageId = window.currentlySelectedElement.getAttribute('data-page-id');
          if (pageId !== null) {
            const targetPage = findPageById(parseInt(pageId, 10), pages);
            if (targetPage) {
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = newHTML;
              const newTitleElem = tempDiv.querySelector('title');
              if (newTitleElem) {
                const newTitleText = newTitleElem.textContent;
                targetPage.title = newTitleText;
                const pageDiv = document.querySelector(`.pageItem[data-pageid="${pageId}"]`);
                if (pageDiv) {
                  const titleInput = pageDiv.querySelector('.pageTitleInput');
                  if (titleInput) { titleInput.value = newTitleText; }
                }
                document.getElementById('editElementPanel').style.display = 'none';
                window.currentlySelectedElement = null;
                return true;
              } else {
                alert("Invalid Title HTML. Please try again.");
                return false;
              }
            }
          }
        } else {
          const pageId = window.currentlySelectedElement.getAttribute('data-page-id');
          const sectionIndex = window.currentlySelectedElement.getAttribute('data-section-index');
          if (pageId !== null && sectionIndex !== null) {
            const targetPage = findPageById(parseInt(pageId, 10), pages);
            if (targetPage && targetPage.sections[parseInt(sectionIndex, 10)]) {
              targetPage.sections[parseInt(sectionIndex, 10)].customHTML = newHTML;
              console.log(`Updated customHTML for page ${pageId}, section ${sectionIndex}:`, newHTML);
            }
          }
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = newHTML;
          const newElem = tempDiv.firstElementChild;
          if (newElem) {
            if (pageId !== null && sectionIndex !== null) {
              newElem.setAttribute('data-page-id', pageId);
              newElem.setAttribute('data-section-index', sectionIndex);
            }
            window.currentlySelectedElement.parentNode.replaceChild(newElem, window.currentlySelectedElement);
            window.currentlySelectedElement = null;
            document.getElementById('editElementPanel').style.display = 'none';
            return true;
          } else { alert("Invalid HTML. Please try again."); return false; }
        }
      }
      return false;
    }
    // Modified Push Updates Event Listener:
    // If the element update is successful, remove any red outline styles from the previewFrame,
    // retrieve the updated HTML from the previewFrame, and push that to the generated code window.
    document.getElementById('pushUpdatesBtn').addEventListener('click', function() {
      if (performUpdateElement()) {
        try {
          // Remove any inline red outlines before retrieving the HTML
          removeHighlight();
          const updatedHTML = previewFrame.contentDocument.documentElement.outerHTML;
          generatedCode.value = updatedHTML;
        } catch (err) {
          console.error("Error retrieving updated HTML from previewFrame:", err);
        }
      }
    });
    document.getElementById('updateElementBtn').addEventListener('click', function() {
      performUpdateElement();
    });
    // NEW DELETE ELEMENT BUTTON EVENT LISTENER
    document.getElementById('deleteElementBtn').addEventListener('click', function() {
      if (window.currentlySelectedElement) {
        // Prevent deletion of critical elements like the title.
        if (window.currentlySelectedElement.tagName.toLowerCase() === 'title') {
          alert("Deleting the title element is not allowed.");
          return;
        }
        // Check for data attributes to update the corresponding data model.
        const pageId = window.currentlySelectedElement.getAttribute('data-page-id');
        const sectionIndex = window.currentlySelectedElement.getAttribute('data-section-index');
        if (pageId !== null && sectionIndex !== null) {
          const targetPage = findPageById(parseInt(pageId, 10), pages);
          if (targetPage) {
            targetPage.sections.splice(parseInt(sectionIndex, 10), 1);
          }
        }
        // Remove the selected element from the DOM.
        window.currentlySelectedElement.parentNode.removeChild(window.currentlySelectedElement);
        window.currentlySelectedElement = null;
        document.getElementById('editElementPanel').style.display = 'none';
        alert("Element deleted successfully.");
      } else {
        alert("No element selected.");
      }
    });
    const previewFrame = document.getElementById('previewFrame');
    previewFrame.addEventListener('load', function() {
      const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
      if (viewSourceEnabled) {
        attachViewSourceListeners(iframeDoc);
      }
    });

    const previewBtn = document.getElementById('previewBtn');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const generatedCode = document.getElementById('generatedCode');
    let siteMap = {};
    previewBtn.addEventListener('click', () => {
      if (pages.length === 0) { previewFrame.srcdoc = "<p style='color:red;'>No pages found. Please add a page.</p>"; return; }
      siteMap = {};
      const flatList = flattenPages(pages);
      flatList.forEach(pg => { const code = buildPageHTML(pg, true); const fname = pageFilename(pg); siteMap[fname] = code; });
      const homePage = pages[0];
      const homeFilename = pageFilename(homePage);
      previewFrame.srcdoc = siteMap[homeFilename];
    });
    window.openPageInPreview = function(filename) {
      if (siteMap[filename]) { previewFrame.srcdoc = siteMap[filename]; }
    };
    generateBtn.addEventListener('click', () => {
      let allCode = "";
      if (pages.length === 0) { allCode = "<!-- No pages defined -->"; }
      else {
        siteMap = {};
        const flatList = flattenPages(pages);
        flatList.forEach(pg => {
          const pgCode = buildPageHTML(pg, false);
          const fname = pageFilename(pg);
          pg.filename = fname;
          siteMap[fname] = pgCode;
          allCode += `<!-- PAGE: ${fname} -->\n${pgCode}\n\n`;
        });
      }
      generatedCode.value = allCode.trim();
    });
    clearBtn.addEventListener('click', () => {
      selectedFont = "'Montserrat', sans-serif";
      fontFamilySearchInput.value = "";
      renderFontList();
      globalBgColor.value = "#ffffff";
      globalTextColor.value = "#000000";
      globalHeadingColor.value = "#000000";
      includeNav.checked = false;
      globalFontSize.value = "16";
      globalLineHeight.value = "1.6";
      globalLinkColor.value = "#4A88F6";
      globalBgImage.value = "";
      globalCustomCSS.value = "";
      pageCount = 0; pages = [];
      pagesContainer.innerHTML = "";
      manualHtmlInput.value = "";
      imageResults.innerHTML = "";
      previewFrame.srcdoc = "";
      generatedCode.value = "";
      siteMap = {};
      tabButtons.forEach(b => b.classList.remove('active'));
      tabContents.forEach(tc => tc.classList.remove('active'));
      tabButtons[0].classList.add('active');
      tabContents[0].classList.add('active');
    });
    const codeSearchInput = document.getElementById('codeSearchInput');
    const codeReplaceInput = document.getElementById('codeReplaceInput');
    const replaceAllBtn = document.getElementById('replaceAllBtn');
    const exportHTMLBtn = document.getElementById('exportHTMLBtn');
    let searchIndex = 0;
    document.getElementById('nextBtn').addEventListener('click', function() {
      const query = codeSearchInput.value;
      if (!query) {
        alert("Please enter a search term.");
        return;
      }
      const codeText = generatedCode.value;
      const foundIndex = codeText.indexOf(query, searchIndex);
      if (foundIndex === -1) {
        alert("No more matches found. Starting from beginning.");
        searchIndex = 0;
      } else {
        generatedCode.focus();
        generatedCode.setSelectionRange(foundIndex, foundIndex + query.length);
        const computedStyle = window.getComputedStyle(generatedCode);
        const lineHeight = parseFloat(computedStyle.lineHeight) || parseFloat(computedStyle.fontSize) * 1.2;
        const substring = generatedCode.value.substring(0, foundIndex);
        const lineNumber = substring.split("\n").length - 1;
        generatedCode.scrollTop = lineNumber * lineHeight;
        searchIndex = foundIndex + query.length;
      }
    });
    document.getElementById('prevBtn').addEventListener('click', function() {
      const query = codeSearchInput.value;
      if (!query) {
        alert("Please enter a search term.");
        return;
      }
      const codeText = generatedCode.value;
      const currentStart = generatedCode.selectionStart;
      const foundIndex = codeText.lastIndexOf(query, currentStart - 1);
      if (foundIndex === -1) {
        alert("No previous matches found.");
      } else {
        generatedCode.focus();
        generatedCode.setSelectionRange(foundIndex, foundIndex + query.length);
        const computedStyle = window.getComputedStyle(generatedCode);
        const lineHeight = parseFloat(computedStyle.lineHeight) || parseFloat(computedStyle.fontSize) * 1.2;
        const substring = generatedCode.value.substring(0, foundIndex);
        const lineNumber = substring.split("\n").length - 1;
        generatedCode.scrollTop = lineNumber * lineHeight;
        searchIndex = foundIndex;
      }
    });
    replaceAllBtn.addEventListener('click', function() {
      const searchText = codeSearchInput.value;
      const replaceText = codeReplaceInput.value;
      if (!searchText) { alert("Please enter text to search for."); return; }
      const codeContent = generatedCode.value;
      const updatedCode = codeContent.split(searchText).join(replaceText);
      generatedCode.value = updatedCode;
    });
    exportHTMLBtn.addEventListener('click', function() {
      const codeContent = generatedCode.value;
      if (!codeContent) { alert("There is no generated code to export."); return; }
      const blob = new Blob([codeContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = "exported_site.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
    function flattenPages(pageArr) {
      let result = [];
      for (let p of pageArr) {
        result.push(p);
        if (p.subPages && p.subPages.length > 0) { result = result.concat(flattenPages(p.subPages)); }
      }
      return result;
    }
    function pageFilename(pg) {
      const t = pg.title.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/gi, '');
      return t ? t + ".html" : "page-" + pg.id + ".html";
    }
    function isTopLevel(pageObj) { return pages.includes(pageObj); }
  </script>
</body>
</html>
