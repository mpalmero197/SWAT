<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dark Mode Multi-Page Site Builder - Single Nav + Click Dropdown</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap');

    /* Basic Reset & Body */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: linear-gradient(135deg, #141416 0%, #1F1F22 100%);
      color: #ffffff;
      font-family: 'Montserrat', sans-serif;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .wrapper {
      background: #1E1E22;
      border-radius: 10px;
      max-width: 1200px;
      width: 100%;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      margin-top: 40px;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 700;
      letter-spacing: 1px;
      color: #EAEAEA;
    }
    h1 {
      margin-top: 0;
      font-size: 2rem;
    }
    h2 {
      font-size: 1.3rem;
      margin-top: 10px;
      color: #ccc;
    }
    p {
      font-size: 0.95rem;
      color: #bbb;
      line-height: 1.4;
    }
    /* Tabs */
    .tab-nav {
      display: flex;
      border-bottom: 1px solid #333;
      margin-bottom: 20px;
    }
    .tab-btn {
      flex: 1;
      background: #2A2A2E;
      border: none;
      padding: 15px;
      color: #fff;
      font-weight: 500;
      text-align: center;
      transition: background 0.3s, color 0.3s;
      border-right: 1px solid #333;
      font-size: 0.95rem;
      cursor: pointer;
    }
    .tab-btn:last-child {
      border-right: none;
    }
    .tab-btn:hover {
      background: #3A3A40;
    }
    .tab-btn.active {
      background: #4A88F6;
      font-weight: 700;
      color: #ffffff;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* Fields & Buttons */
    .field {
      margin-bottom: 15px;
    }
    .field label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      font-size: 0.95rem;
    }
    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: none;
      outline: none;
      background: #2A2A2E;
      color: #ffffff;
      font-size: 0.95rem;
      transition: background 0.2s;
    }
    .field input[type="color"] {
      height: 40px;
      cursor: pointer;
      padding: 0;
    }
    .field input:hover,
    .field select:hover,
    .field textarea:hover {
      background: #343438;
    }
    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    button {
      cursor: pointer;
      background: #4A88F6;
      color: #fff;
      padding: 12px 20px;
      border: none;
      border-radius: 5px;
      font-size: 0.95rem;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    button:hover {
      background: #3C74D4;
      transform: translateY(-1px);
    }
    /* Page Editor UI */
    .pageItem {
      background: #2A2A2E;
      border-radius: 6px;
      padding: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
      margin-bottom: 15px;
      transition: background 0.3s;
    }
    .pageItem:hover {
      background: #343438;
    }
    .pageItem .pageHeader {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .pageItem h3 {
      font-size: 1rem;
      margin: 0;
      flex: 1;
    }
    .sectionContainer {
      margin-top: 15px;
    }
    .sectionItem {
      background: #36363A;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .sectionItem label {
      font-size: 0.85rem;
    }
    /* Preview & Generated Code */
    #previewFrame {
      width: 100%;
      height: 500px;
      border: 1px solid #333333;
      border-radius: 5px;
      background: #ffffff;
    }
    #generatedCode {
      margin-top: 20px;
      background: #0E0E10;
      color: #ffffff;
      border: 1px solid #333333;
      border-radius: 5px;
      padding: 15px;
      width: 100%;
      height: 400px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      resize: none;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Dark Mode Multi-Page Site Builder</h1>
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="basicTab">Basic Settings</button>
      <button class="tab-btn" data-tab="pagesTab">Pages & Navigation</button>
      <button class="tab-btn" data-tab="referenceTab">Reference Layout</button>
      <button class="tab-btn" data-tab="previewTab">Preview</button>
      <button class="tab-btn" data-tab="codeTab">Generated Code</button>
    </div>

    <!-- BASIC SETTINGS TAB -->
    <div id="basicTab" class="tab-content active">
      <h2>Global Settings</h2>
      <div class="field">
        <label for="fontFamily">Font Family:</label>
        <select id="fontFamily">
          <option value="Arial, sans-serif">Arial</option>
          <option value="'Helvetica Neue', sans-serif">Helvetica Neue</option>
          <option value="'Montserrat', sans-serif" selected>Montserrat</option>
          <option value="'Times New Roman', serif">Times New Roman</option>
          <option value="Georgia, serif">Georgia</option>
        </select>
      </div>
      <div class="field">
        <label for="globalBgColor">Background Color:</label>
        <input type="color" id="globalBgColor" value="#ffffff" />
      </div>
      <div class="field">
        <label for="globalTextColor">Text Color:</label>
        <input type="color" id="globalTextColor" value="#000000" />
      </div>
      <div class="field">
        <label for="globalHeadingColor">Heading Color:</label>
        <input type="color" id="globalHeadingColor" value="#000000" />
      </div>
      <div class="field">
        <label for="includeNav">Include Navigation Bar:</label>
        <input type="checkbox" id="includeNav" />
      </div>
    </div>

    <!-- PAGES & NAVIGATION TAB -->
    <div id="pagesTab" class="tab-content">
      <h2>Pages & Navigation</h2>
      <p>
        Add pages (and optional sub-pages). Sub-pages appear as a click-dropdown under their parent.
      </p>
      <div class="buttons">
        <button id="addPageBtn" style="background:#28A745;">Add New Top-Level Page</button>
      </div>
      <div id="pagesContainer"></div>
    </div>

    <!-- REFERENCE LAYOUT TAB -->
    <div id="referenceTab" class="tab-content">
      <h2>Reference Layout</h2>
      <p>Fetch layout data from an external site and apply it to one of your pages.</p>
      <div class="field">
        <label for="referencePageSelect">Select Page to Import Layout Into:</label>
        <select id="referencePageSelect">
          <option value="">(No pages yet)</option>
        </select>
      </div>
      <div class="field">
        <label for="referenceURL">External Site URL:</label>
        <input type="text" id="referenceURL" placeholder="https://example.com" />
      </div>
      <div class="buttons">
        <button id="fetchLayoutBtn">Fetch Layout</button>
      </div>
      <p id="referenceStatus" style="margin-top:10px; color:#bbb;"></p>
    </div>

    <!-- PREVIEW TAB -->
    <div id="previewTab" class="tab-content">
      <h2>Live Preview (Home Page)</h2>
      <p>
        Shows only one nav bar at the top. Sub-pages get an arrow (▼). Click to toggle their dropdown.
      </p>
      <button id="previewBtn" style="margin-bottom:20px;">Update Preview</button>
      <iframe id="previewFrame"></iframe>
    </div>

    <!-- GENERATED CODE TAB -->
    <div id="codeTab" class="tab-content">
      <h2>Generated Code (All Pages)</h2>
      <p>
        Each page has exactly one nav. Sub-pages appear in a click dropdown under their parent. 
        Copy each code block into its own <code>.html</code> file.
      </p>
      <div class="buttons">
        <button id="generateBtn">Generate Site Code</button>
        <button id="clearBtn" style="background:#d9534f;">Clear All</button>
      </div>
      <textarea id="generatedCode" readonly></textarea>
    </div>
  </div>

  <script>
    // --------------------------
    // TAB FUNCTIONALITY
    // --------------------------
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-tab');
        tabButtons.forEach(b => b.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(target).classList.add('active');
      });
    });

    // Make the first tab visible by default
    document.getElementById('basicTab').classList.add('active');
    tabButtons[0].classList.add('active');

    // --------------------------
    // GLOBAL SETTINGS
    // --------------------------
    const fontFamily = document.getElementById('fontFamily');
    const globalBgColor = document.getElementById('globalBgColor');
    const globalTextColor = document.getElementById('globalTextColor');
    const globalHeadingColor = document.getElementById('globalHeadingColor');
    const includeNav = document.getElementById('includeNav');

    // If you want a favicon, you could store it here:
    let faviconURL = "";

    // --------------------------
    // PAGES / NAVIGATION
    // --------------------------
    const pagesContainer = document.getElementById('pagesContainer');
    const addPageBtn = document.getElementById('addPageBtn');
    let pageCount = 0;
    let pages = [];

    addPageBtn.addEventListener('click', () => {
      createPageEditor(null);
      refreshReferencePageSelect();
    });

    function createPageEditor(parentPage) {
      const pageId = pageCount++;
      const pageObj = {
        id: pageId,
        title: "Untitled Page",
        layout: "single",
        sections: [],
        subPages: []
      };

      if (parentPage) {
        parentPage.subPages.push(pageObj);
      } else {
        pages.push(pageObj);
      }

      const pageDiv = document.createElement('div');
      pageDiv.classList.add('pageItem');
      pageDiv.setAttribute('data-pageid', pageId);

      const pageLevel = parentPage ? "Sub-page" : "Page";
      pageDiv.innerHTML = `
        <div class="pageHeader">
          <h3>${pageLevel} Editor (ID: ${pageId})</h3>
          <button class="removePageBtn" style="background:#d9534f;">Remove</button>
        </div>
        <div class="field">
          <label>Page Title (used for navigation label):</label>
          <input type="text" class="pageTitleInput" value="${pageLevel} ${pageId}" />
        </div>
        <div class="field">
          <label>Layout Style:</label>
          <select class="pageLayoutSelect">
            <option value="single">Single Column</option>
            <option value="two">Two Columns</option>
            <option value="grid">Grid</option>
            <option value="masonry">Masonry</option>
            <option value="cards">Cards</option>
            <option value="three">Three Columns</option>
            <option value="heroGrid">Hero + Grid</option>
            <option value="splitBanner">Split Banner</option>
            <option value="minimalist">Minimalist</option>
          </select>
        </div>
        <h4 style="margin:10px 0;">Sections</h4>
        <div class="sectionContainer"></div>
        <div class="buttons">
          <button class="addSectionBtn" style="background:#28A745;">Add Section</button>
          ${!parentPage ? '<button class="addSubPageBtn" style="background:#5bc0de;">Add Sub-Page</button>' : ''}
        </div>
      `;

      // Insert in DOM
      if (parentPage) {
        const parentDiv = pagesContainer.querySelector(`.pageItem[data-pageid="${parentPage.id}"]`);
        if (!parentDiv) {
          pagesContainer.appendChild(pageDiv);
        } else {
          parentDiv.insertAdjacentElement('afterend', pageDiv);
        }
      } else {
        pagesContainer.appendChild(pageDiv);
      }

      // Handlers
      pageDiv.querySelector('.removePageBtn').addEventListener('click', () => {
        removePage(pageObj, pageDiv);
        refreshReferencePageSelect();
      });

      const titleInput = pageDiv.querySelector('.pageTitleInput');
      titleInput.addEventListener('input', (e) => {
        pageObj.title = e.target.value.trim();
      });
      pageObj.title = titleInput.value;

      const layoutSelect = pageDiv.querySelector('.pageLayoutSelect');
      layoutSelect.addEventListener('change', (e) => {
        pageObj.layout = e.target.value;
      });
      pageObj.layout = layoutSelect.value;

      const sectionContainer = pageDiv.querySelector('.sectionContainer');
      pageDiv.querySelector('.addSectionBtn').addEventListener('click', () => {
        createSectionEditor(pageObj, sectionContainer);
      });

      if (!parentPage) {
        const addSubPageBtn = pageDiv.querySelector('.addSubPageBtn');
        addSubPageBtn?.addEventListener('click', () => {
          createPageEditor(pageObj);
          refreshReferencePageSelect();
        });
      }
    }

    function removePage(pageObj, pageDiv) {
      if (pageObj) pageObjSubSearch(pageObj.id, pages);
      pageDiv.remove();
    }

    function pageObjSubSearch(id, pageArr) {
      for (let i = 0; i < pageArr.length; i++) {
        if (pageArr[i].id === id) {
          pageArr.splice(i, 1);
          return true;
        } else if (pageArr[i].subPages.length > 0) {
          const found = pageObjSubSearch(id, pageArr[i].subPages);
          if (found) return true;
        }
      }
      return false;
    }

    function createSectionEditor(pageObj, containerEl) {
      const sectionId = pageObj.sections.length;
      const sectionData = {
        id: sectionId,
        heading: "",
        paragraph: "",
        icon: "none",
        art: "",
        image: ""
      };
      pageObj.sections.push(sectionData);

      const secDiv = document.createElement('div');
      secDiv.classList.add('sectionItem');
      secDiv.innerHTML = `
        <label>Section Heading:</label>
        <input type="text" class="secHeading" placeholder="Enter heading" />
        <label>Section Paragraph:</label>
        <textarea rows="2" class="secParagraph" placeholder="Enter paragraph"></textarea>
        <label>Choose an Icon (Font Awesome):</label>
        <select class="iconSelect">
          <option value="none" selected>No Icon</option>
          <option value="fa fa-user">User</option>
          <option value="fa fa-star">Star</option>
          <option value="fa fa-heart">Heart</option>
          <option value="fa fa-check">Check</option>
          <option value="fa fa-cog">Cog</option>
        </select>
        <label>Royalty-Free Art/Image URL (Optional):</label>
        <input type="text" class="secArt" placeholder="https://example.com/art.jpg" />
        <label>Image URL (Optional):</label>
        <input type="text" class="secImage" placeholder="Another optional image URL" />
        <button class="removeSectionBtn" style="background:#d9534f; margin-top:8px;">Remove Section</button>
      `;
      containerEl.appendChild(secDiv);

      // Link data
      secDiv.querySelector('.secHeading').addEventListener('input', e => {
        sectionData.heading = e.target.value.trim();
      });
      secDiv.querySelector('.secParagraph').addEventListener('input', e => {
        sectionData.paragraph = e.target.value.trim();
      });
      secDiv.querySelector('.iconSelect').addEventListener('change', e => {
        sectionData.icon = e.target.value;
      });
      secDiv.querySelector('.secArt').addEventListener('input', e => {
        sectionData.art = e.target.value.trim();
      });
      secDiv.querySelector('.secImage').addEventListener('input', e => {
        sectionData.image = e.target.value.trim();
      });

      secDiv.querySelector('.removeSectionBtn').addEventListener('click', () => {
        const idx = pageObj.sections.indexOf(sectionData);
        if (idx !== -1) pageObj.sections.splice(idx, 1);
        secDiv.remove();
      });
    }

    // --------------------------
    // REFERENCE LAYOUT
    // --------------------------
    const referencePageSelect = document.getElementById('referencePageSelect');
    const referenceURL = document.getElementById('referenceURL');
    const fetchLayoutBtn = document.getElementById('fetchLayoutBtn');
    const referenceStatus = document.getElementById('referenceStatus');

    fetchLayoutBtn.addEventListener('click', async () => {
      const pageId = referencePageSelect.value.trim();
      if (!pageId) {
        referenceStatus.textContent = "Please select a page to import into.";
        return;
      }
      const urlValue = referenceURL.value.trim();
      if (!urlValue) {
        referenceStatus.textContent = "Please enter a valid URL.";
        return;
      }
      try {
        referenceStatus.textContent = "Fetching layout...";

        // Example fetch to your backend
        const response = await fetch("https://your-backend.example.com/api/fetch-layout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url: urlValue })
        });

        if (!response.ok) {
          referenceStatus.textContent = "Error fetching layout from the server.";
          return;
        }

        const layoutData = await response.json();
        // e.g. layoutData = [{ heading, paragraph, icon, art, image }, ...]

        const targetPage = findPageById(parseInt(pageId, 10), pages);
        if (!targetPage) {
          referenceStatus.textContent = "Selected page not found in data.";
          return;
        }

        // Clear existing
        targetPage.sections = [];
        const pageDiv = document.querySelector(`.pageItem[data-pageid="${targetPage.id}"]`);
        if (pageDiv) {
          const sectionContainer = pageDiv.querySelector('.sectionContainer');
          sectionContainer.innerHTML = "";
        }

        if (Array.isArray(layoutData)) {
          layoutData.forEach(ld => {
            const newSection = {
              id: targetPage.sections.length,
              heading: ld.heading || "",
              paragraph: ld.paragraph || "",
              icon: ld.icon || "none",
              art: ld.art || "",
              image: ld.image || ""
            };
            targetPage.sections.push(newSection);
          });
        }

        if (pageDiv) {
          const sectionContainer = pageDiv.querySelector('.sectionContainer');
          sectionContainer.innerHTML = "";
          targetPage.sections.forEach(secObj => {
            createFetchedSectionUI(targetPage, sectionContainer, secObj);
          });
        }

        referenceStatus.textContent = "Layout imported successfully!";
      } catch (error) {
        console.error(error);
        referenceStatus.textContent = "An error occurred while fetching layout.";
      }
    });

    function findPageById(id, pageArr) {
      for (let p of pageArr) {
        if (p.id === id) return p;
        if (p.subPages && p.subPages.length) {
          const found = findPageById(id, p.subPages);
          if (found) return found;
        }
      }
      return null;
    }

    function createFetchedSectionUI(pageObj, containerEl, secData) {
      const secDiv = document.createElement('div');
      secDiv.classList.add('sectionItem');
      secDiv.innerHTML = `
        <label>Section Heading:</label>
        <input type="text" class="secHeading" />
        <label>Section Paragraph:</label>
        <textarea rows="2" class="secParagraph"></textarea>
        <label>Choose an Icon (Font Awesome):</label>
        <select class="iconSelect">
          <option value="none">No Icon</option>
          <option value="fa fa-user">User</option>
          <option value="fa fa-star">Star</option>
          <option value="fa fa-heart">Heart</option>
          <option value="fa fa-check">Check</option>
          <option value="fa fa-cog">Cog</option>
        </select>
        <label>Royalty-Free Art/Image URL (Optional):</label>
        <input type="text" class="secArt" />
        <label>Image URL (Optional):</label>
        <input type="text" class="secImage" />
        <button class="removeSectionBtn" style="background:#d9534f; margin-top:8px;">Remove Section</button>
      `;
      containerEl.appendChild(secDiv);

      secDiv.querySelector('.secHeading').value = secData.heading;
      secDiv.querySelector('.secParagraph').value = secData.paragraph;
      secDiv.querySelector('.iconSelect').value = secData.icon;
      secDiv.querySelector('.secArt').value = secData.art;
      secDiv.querySelector('.secImage').value = secData.image;

      secDiv.querySelector('.secHeading').addEventListener('input', e => {
        secData.heading = e.target.value.trim();
      });
      secDiv.querySelector('.secParagraph').addEventListener('input', e => {
        secData.paragraph = e.target.value.trim();
      });
      secDiv.querySelector('.iconSelect').addEventListener('change', e => {
        secData.icon = e.target.value;
      });
      secDiv.querySelector('.secArt').addEventListener('input', e => {
        secData.art = e.target.value.trim();
      });
      secDiv.querySelector('.secImage').addEventListener('input', e => {
        secData.image = e.target.value.trim();
      });

      secDiv.querySelector('.removeSectionBtn').addEventListener('click', () => {
        const idx = pageObj.sections.indexOf(secData);
        if (idx !== -1) pageObj.sections.splice(idx, 1);
        secDiv.remove();
      });
    }

    function refreshReferencePageSelect() {
      const allPages = flattenPages(pages);
      referencePageSelect.innerHTML = "";
      if (!allPages.length) {
        referencePageSelect.innerHTML = '<option value="">(No pages yet)</option>';
      } else {
        allPages.forEach(pg => {
          const opt = document.createElement('option');
          opt.value = pg.id;
          opt.textContent = pg.title || `Page ${pg.id}`;
          referencePageSelect.appendChild(opt);
        });
      }
    }

    // --------------------------
    // PREVIEW & CODE GENERATION
    // --------------------------
    const previewBtn = document.getElementById('previewBtn');
    const previewFrame = document.getElementById('previewFrame');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const generatedCode = document.getElementById('generatedCode');

    let siteMap = {}; // For preview

    previewBtn.addEventListener('click', () => {
      if (!pages.length) {
        previewFrame.srcdoc = "<p style='color:red;'>No pages found. Please add a page.</p>";
        return;
      }
      siteMap = {};
      const flatList = flattenPages(pages);
      flatList.forEach(pg => {
        const code = buildPageHTML(pg, false, true);
        siteMap[pageFilename(pg)] = code;
      });
      // Show the first top-level page
      const homePage = pages[0];
      previewFrame.srcdoc = siteMap[pageFilename(homePage)];
    });

    // Called by <a> in the nav to load a new page in the same iframe
    window.openPageInPreview = function(filename) {
      // Safeguard if user opens sub-page in a new tab
      if (typeof previewFrame === 'undefined' || !siteMap[filename]) return;
      previewFrame.srcdoc = siteMap[filename];
    };

    generateBtn.addEventListener('click', () => {
      let allCode = "";
      if (!pages.length) {
        allCode = "<!-- No pages defined -->";
      } else {
        siteMap = {};
        const flatList = flattenPages(pages);
        flatList.forEach(pg => {
          const pgCode = buildPageHTML(pg, false, false);
          const fname = pageFilename(pg);
          siteMap[fname] = pgCode;
          allCode += `<!-- PAGE: ${fname} -->\n${pgCode}\n\n`;
        });
      }
      generatedCode.value = allCode.trim();
    });

    clearBtn.addEventListener('click', () => {
      fontFamily.value = "'Montserrat', sans-serif";
      globalBgColor.value = "#ffffff";
      globalTextColor.value = "#000000";
      globalHeadingColor.value = "#000000";
      includeNav.checked = false;
      pageCount = 0;
      pages = [];
      pagesContainer.innerHTML = "";
      referencePageSelect.innerHTML = '<option value="">(No pages yet)</option>';
      previewFrame.srcdoc = "";
      generatedCode.value = "";
      siteMap = {};
      // Reset tabs
      tabButtons.forEach(b => b.classList.remove('active'));
      tabContents.forEach(tc => tc.classList.remove('active'));
      tabButtons[0].classList.add('active');
      document.getElementById('basicTab').classList.add('active');
    });

    function flattenPages(pageArr) {
      let result = [];
      for (let p of pageArr) {
        result.push(p);
        if (p.subPages && p.subPages.length) {
          result = result.concat(flattenPages(p.subPages));
        }
      }
      return result;
    }

    function pageFilename(pg) {
      let t = pg.title.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/gi, '');
      if (!t) t = "page-" + pg.id;
      return t + ".html";
    }

    // The main page-building function
    // isPreviewNav -> if true, we attach onclick for links
    function buildPageHTML(pageObj, isPreview, isPreviewNav) {
      const pageTitle = pageObj.title.trim() || "Untitled Page";
      const sectionsHTML = buildSectionsHTML(pageObj.sections);

      let navHTML = "";
      if (includeNav.checked) {
        navHTML = buildNavHTML(pages, isPreviewNav);
      }

      let layoutCSS = getLayoutCSS(pageObj.layout);
      const usesFA = checkAnyIconUse(pageObj) || checkSubPageIconUse(pageObj);
      const faLink = usesFA ? `<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">` : "";

      const gBg = globalBgColor.value;
      const gTxt = globalTextColor.value;
      const gHead = globalHeadingColor.value;
      const gFont = fontFamily.value.trim() || "Arial, sans-serif";

      // We'll add a small script to handle the .dropdownToggle click
      // so that sub-pages expand/collapse
      const toggleDropScript = `
<script>
document.addEventListener('DOMContentLoaded', () => {
  // For each .dropdownToggle in nav, toggle .open on click
  document.querySelectorAll('.dropdownToggle').forEach(toggleLink => {
    toggleLink.addEventListener('click', e => {
      // If the user just wants to expand/collapse the submenu,
      // we prevent default only if it has sub-pages
      if (toggleLink.closest('.has-submenu')) {
        e.preventDefault();
        const parentLi = toggleLink.closest('.has-submenu');
        parentLi.classList.toggle('open');
      }
    });
  });
});
</script>
      `;

      return `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>${pageTitle}</title>
  ${faLink}
  <style>
    body {
      background-color: ${gBg};
      color: ${gTxt};
      font-family: ${gFont};
      margin: 0; 
      padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    h1, h2, h3 {
      color: ${gHead};
      margin-bottom: 15px;
    }
    p {
      margin-bottom: 15px;
      line-height: 1.6;
    }
    ${layoutCSS}

    /* Single nav at top */
    nav {
      background: ${gHead};
      padding: 15px;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
      align-items: center;
      position: relative;
    }
    nav li {
      position: relative;
    }
    nav a {
      color: ${gBg};
      text-decoration: none;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .submenu {
      display: none;
      position: absolute;
      top: 50px;
      left: 0;
      flex-direction: column;
      background-color: ${gHead};
      padding: 10px;
      border-radius: 5px;
      min-width: 150px;
    }
    .submenu li {
      margin: 5px 0;
    }
    /* Use .open class for toggling visible */
    .has-submenu.open .submenu {
      display: flex;
    }
    /* Little arrow next to items with sub-pages */
    .arrow {
      font-size: 0.8rem;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  ${navHTML}
  <div class="container">
    <h1>${pageTitle}</h1>
    <div class="layout-container">
      ${sectionsHTML}
    </div>
  </div>
  ${toggleDropScript}
</body>
</html>
      `.trim();
    }

    function buildSectionsHTML(sections) {
      let html = "";
      sections.forEach(sec => {
        const heading = sec.heading || "Section Heading";
        const paragraph = sec.paragraph || "Lorem ipsum dolor sit amet.";
        let iconHTML = "";
        if (sec.icon && sec.icon !== "none") {
          iconHTML = `<i class="${sec.icon}" style="margin-right:8px;"></i>`;
        }
        let artHTML = sec.art ? `<img src="${sec.art}" alt="Art" style="max-width:100%; height:auto; margin:15px 0;" />` : "";
        let imgHTML = sec.image ? `<img src="${sec.image}" alt="Section" style="max-width:100%; height:auto; margin:15px 0;" />` : "";
        html += `
          <div class="layout-item">
            <h2>${iconHTML}${heading}</h2>
            <p>${paragraph}</p>
            ${artHTML}
            ${imgHTML}
          </div>
        `;
      });
      return html;
    }

    function buildNavHTML(pageArr, isPreviewNav) {
      if (!pageArr.length) return "";
      let nav = `<nav><ul>`;
      pageArr.forEach(pageObj => {
        const fname = pageFilename(pageObj);
        const label = pageObj.title || "Untitled";
        // If sub-pages exist, we add an arrow (▼) and the .dropdownToggle
        if (pageObj.subPages && pageObj.subPages.length > 0) {
          nav += `
          <li class="has-submenu">
            ${buildNavLink(fname, label + ' <span class="arrow">▼</span>', isPreviewNav, true)}
            <ul class="submenu">`;
          pageObj.subPages.forEach(sp => {
            const sfname = pageFilename(sp);
            const slabel = sp.title || "Untitled";
            nav += `<li>${buildNavLink(sfname, slabel, isPreviewNav, false)}</li>`;
          });
          nav += `</ul>
          </li>`;
        } else {
          nav += `<li>${buildNavLink(fname, label, isPreviewNav, false)}</li>`;
        }
      });
      nav += `</ul></nav>`;
      return nav;
    }

    // If hasDropdown=true, we give the link a .dropdownToggle class 
    // so clicking it toggles the parent .has-submenu
    function buildNavLink(filename, labelHTML, isPreviewNav, hasDropdown) {
      const toggleClass = hasDropdown ? 'dropdownToggle' : '';
      if (isPreviewNav) {
        // In preview, intercept link
        return `
<a href="${filename}" class="${toggleClass}" 
   onclick="if(window.parent && window.parent.openPageInPreview){ 
     window.parent.openPageInPreview('${filename}'); 
     // If it has sub-pages, we also toggle them:
     if(${hasDropdown}){ 
       const li = this.closest('.has-submenu');
       li.classList.toggle('open'); 
     }
     return false; 
   }">
   ${labelHTML}
</a>
        `.trim();
      } else {
        // In final offline usage, normal anchor. 
        // For sub-pages, we cancel the link if user just wants to open sub-menu:
        return `
<a href="${filename}" class="${toggleClass}" 
   onclick="if(${hasDropdown}){ 
     // Toggle open if the user is just clicking arrow
     const li = this.closest('.has-submenu');
     li.classList.toggle('open');
     return false; 
   }">
   ${labelHTML}
</a>
        `.trim();
      }
    }

    function getLayoutCSS(layoutValue) {
      switch (layoutValue) {
        case 'single':
          return `
.layout-container { display: block; }
.layout-item { margin-bottom: 40px; }
          `;
        case 'two':
          return `
.layout-container {
  display: flex; flex-wrap: wrap; gap: 20px;
}
.layout-item {
  flex: 1 1 calc(50% - 20px);
  margin-bottom: 20px; background: #f8f8f8; color: #000;
  padding: 20px; border-radius: 5px;
}
@media (max-width: 768px) {
  .layout-item { flex: 1 1 100%; }
}
          `;
        case 'grid':
          return `
.layout-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}
.layout-item {
  background: #f8f8f8; color: #000;
  padding: 20px; border-radius: 5px;
}
          `;
        case 'masonry':
          return `
.layout-container { column-count: 3; column-gap: 20px; }
.layout-item {
  display: inline-block; width: 100%; margin-bottom: 20px;
  background: #f8f8f8; color: #000; padding: 20px; border-radius: 5px;
}
@media (max-width: 992px) {
  .layout-container { column-count: 2; }
}
@media (max-width: 576px) {
  .layout-container { column-count: 1; }
}
          `;
        case 'cards':
          return `
.layout-container {
  display: flex; flex-wrap: wrap; gap: 20px;
}
.layout-item {
  background: #f8f8f8; color: #000; border-radius: 5px;
  padding: 20px; width: 100%; max-width: 300px;
}
          `;
        case 'three':
          return `
.layout-container { display: flex; gap: 20px; }
.layout-item {
  flex: 1; background: #f8f8f8; color: #000;
  padding: 20px; border-radius: 5px; margin-bottom: 20px;
}
@media (max-width: 768px) {
  .layout-container { flex-direction: column; }
}
          `;
        case 'heroGrid':
          return `
.layout-container {
  display: grid; grid-template-rows: 300px auto; gap: 20px;
}
.layout-container .layout-item:first-child {
  grid-row: 1; background: #4A88F6; color: #fff;
  display: flex; align-items: center; justify-content: center;
}
.layout-container .layout-item:first-child h2 { margin-bottom: 0; }
.layout-container .layout-item:not(:first-child) {
  background: #f8f8f8; color: #000; padding: 20px; border-radius: 5px;
}
@media (max-width: 768px) {
  .layout-container { grid-template-rows: 200px auto; }
}
          `;
        case 'splitBanner':
          return `
.layout-container {
  display: flex; flex-wrap: wrap; gap: 20px;
}
.layout-item {
  background: #f8f8f8; color: #000;
  padding: 20px; border-radius: 5px; width: 100%;
}
.layout-item:first-child {
  display: flex; flex: 1 1 100%; background: #4A88F6; color: #fff;
  margin-bottom: 0; align-items: center; justify-content: center;
}
.layout-item:first-child h2 { margin: 0; }
@media (max-width: 768px) {
  .layout-item:first-child { flex-direction: column; text-align: center; height: auto; }
}
          `;
        case 'minimalist':
          return `
.layout-container { display: block; padding: 20px; }
.layout-item {
  border-bottom: 1px solid #ccc; padding: 20px 0;
  background: #fff; color: #000;
}
.layout-item:last-child { border-bottom: none; }
          `;
        default:
          return `
.layout-container { display: block; }
.layout-item { margin-bottom: 40px; }
          `;
      }
    }

    function checkAnyIconUse(pageObj) {
      return pageObj.sections.some(s => s.icon && s.icon !== 'none');
    }
    function checkSubPageIconUse(pageObj) {
      if (!pageObj.subPages?.length) return false;
      for (let sp of pageObj.subPages) {
        if (checkAnyIconUse(sp)) return true;
        if (checkSubPageIconUse(sp)) return true;
      }
      return false;
    }
  </script>
</body>
</html>
