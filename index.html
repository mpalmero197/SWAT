<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dark Mode Multi-Page Site Builder (with Royalty-Free Images)</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap');

    /* Basic Reset & Body */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: linear-gradient(135deg, #141416 0%, #1F1F22 100%);
      color: #ffffff;
      font-family: 'Montserrat', sans-serif;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .wrapper {
      background: #1E1E22;
      border-radius: 10px;
      max-width: 1200px;
      width: 100%;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      margin-top: 40px;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 700;
      letter-spacing: 1px;
      color: #EAEAEA;
    }
    h1 {
      margin-top: 0;
      font-size: 2rem;
    }
    h2 {
      font-size: 1.3rem;
      margin-top: 10px;
      color: #ccc;
    }
    p {
      font-size: 0.95rem;
      color: #bbb;
      line-height: 1.4;
    }

    /* Tabs */
    .tab-nav {
      display: flex;
      border-bottom: 1px solid #333;
      margin-bottom: 20px;
    }
    .tab-btn {
      flex: 1;
      background: #2A2A2E;
      border: none;
      padding: 15px;
      color: #fff;
      font-weight: 500;
      text-align: center;
      transition: background 0.3s, color 0.3s;
      border-right: 1px solid #333;
      font-size: 0.95rem;
      cursor: pointer;
    }
    .tab-btn:last-child {
      border-right: none;
    }
    .tab-btn:hover {
      background: #3A3A40;
    }
    .tab-btn.active {
      background: #4A88F6;
      font-weight: 700;
      color: #ffffff;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* Fields & Buttons */
    .field {
      margin-bottom: 15px;
    }
    .field label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      font-size: 0.95rem;
    }
    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: none;
      outline: none;
      background: #2A2A2E;
      color: #ffffff;
      font-size: 0.95rem;
      transition: background 0.2s;
    }
    .field input[type="color"] {
      height: 40px;
      cursor: pointer;
      padding: 0;
    }
    .field input:hover,
    .field select:hover,
    .field textarea:hover {
      background: #343438;
    }

    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    button {
      cursor: pointer;
      background: #4A88F6;
      color: #fff;
      padding: 12px 20px;
      border: none;
      border-radius: 5px;
      font-size: 0.95rem;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    button:hover {
      background: #3C74D4;
      transform: translateY(-1px);
    }

    /* Page Editor UI */
    .pageItem {
      background: #2A2A2E;
      border-radius: 6px;
      padding: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
      margin-bottom: 15px;
      transition: background 0.3s;
    }
    .pageItem:hover {
      background: #343438;
    }
    .pageItem .pageHeader {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .pageItem h3 {
      font-size: 1rem;
      margin: 0;
      flex: 1;
    }
    .sectionContainer {
      margin-top: 15px;
    }
    .sectionItem {
      background: #36363A;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .sectionItem label {
      font-size: 0.85rem;
    }

    /* Preview & Generated Code */
    #previewFrame {
      width: 100%;
      height: 500px;
      border: 1px solid #333333;
      border-radius: 5px;
      background: #ffffff;
    }
    #generatedCode {
      margin-top: 20px;
      background: #0E0E10;
      color: #ffffff;
      border: 1px solid #333333;
      border-radius: 5px;
      padding: 15px;
      width: 100%;
      height: 400px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      resize: none;
    }

    /* Simple nav + submenu style (improved) */
    nav {
      background: #000;
      padding: 15px;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
      align-items: center;
      position: relative;
    }
    nav li {
      position: relative;
    }
    nav a {
      color: #fff;
      text-decoration: none;
      font-weight: bold;
    }
    .submenu {
      position: absolute;
      display: none;
      top: 50px;
      left: 0;
      flex-direction: column;
      background-color: #222;
      padding: 10px;
      border-radius: 5px;
    }
    .submenu li {
      margin: 5px 0;
    }
    .has-submenu:hover .submenu {
      display: flex;
    }
    /* Dropdown arrow for parent item */
    .has-submenu > a::after {
      content: " \25BC";
      margin-left: 5px;
      font-size: 0.8em;
    }

    /* Image Results Grid */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .imageResult {
      position: relative;
      background: #2A2A2E;
      padding: 10px;
      border-radius: 5px;
    }
    .imageResult img {
      width: 100%;
      border-radius: 5px;
    }
    .assign-btns {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    @media (max-width: 768px) {
      .tab-btn {
        font-size: 0.85rem;
        padding: 12px;
      }
      .pageItem {
        padding: 12px;
      }
      button {
        font-size: 0.85rem;
      }
      nav ul {
        flex-wrap: wrap;
      }
      .submenu {
        position: static;
        display: none;
      }
      .has-submenu:hover .submenu {
        display: none; /* On small screens, hover can be confusing; you'd typically toggle via JS here */
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Dark Mode Multi-Page Site Builder</h1>
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="basicTab">Basic Settings</button>
      <button class="tab-btn" data-tab="pagesTab">Pages & Navigation</button>
      <button class="tab-btn" data-tab="referenceTab">Reference Layout</button>
      <button class="tab-btn" data-tab="imagesTab">Images & Media</button>
      <button class="tab-btn" data-tab="previewTab">Preview</button>
      <button class="tab-btn" data-tab="codeTab">Generated Code</button>
    </div>

    <!-- BASIC SETTINGS TAB -->
    <div id="basicTab" class="tab-content active">
      <h2>Global Settings</h2>
      <div class="field">
        <label for="fontFamily">Font Family:</label>
        <select id="fontFamily">
          <option value="Arial, sans-serif">Arial</option>
          <option value="'Helvetica Neue', sans-serif">Helvetica Neue</option>
          <option value="'Montserrat', sans-serif" selected>Montserrat</option>
          <option value="'Times New Roman', serif">Times New Roman</option>
          <option value="Georgia, serif">Georgia</option>
        </select>
      </div>
      <div class="field">
        <label for="globalBgColor">Background Color:</label>
        <input type="color" id="globalBgColor" value="#ffffff" />
      </div>
      <div class="field">
        <label for="globalTextColor">Text Color:</label>
        <input type="color" id="globalTextColor" value="#000000" />
      </div>
      <div class="field">
        <label for="globalHeadingColor">Heading Color:</label>
        <input type="color" id="globalHeadingColor" value="#000000" />
      </div>
      <div class="field">
        <label for="includeNav">Include Navigation Bar:</label>
        <input type="checkbox" id="includeNav" />
      </div>
    </div>

    <!-- PAGES & NAVIGATION TAB -->
    <div id="pagesTab" class="tab-content">
      <h2>Pages & Navigation</h2>
      <p>Add pages (and optional sub-pages). Sub-pages become dropdown items under their parent in the nav.</p>
      <div class="buttons">
        <button id="addPageBtn" style="background:#28A745;">Add New Top-Level Page</button>
      </div>
      <div id="pagesContainer"></div>
    </div>

    <!-- REFERENCE LAYOUT TAB -->
    <div id="referenceTab" class="tab-content">
      <h2>Reference Layout</h2>
      <p>Fetch layout data from an external site and apply it to one of your pages.</p>
      <div class="field">
        <label for="referencePageSelect">Select Page to Import Layout Into:</label>
        <select id="referencePageSelect">
          <option value="">(No pages yet)</option>
        </select>
      </div>
      <div class="field">
        <label for="referenceURL">External Site URL:</label>
        <input type="text" id="referenceURL" placeholder="https://example.com" />
      </div>
      <div class="buttons">
        <button id="fetchLayoutBtn">Fetch Layout</button>
      </div>
      <p id="referenceStatus" style="margin-top:10px; color:#bbb;"></p>
    </div>

    <!-- IMAGES & MEDIA TAB -->
    <div id="imagesTab" class="tab-content">
      <h2>Royalty-Free Images</h2>
      <p>Search for royalty-free images (e.g., from Pexels or Unsplash) and assign them to your sections.</p>
      <div class="field">
        <label for="imageSearchInput">Search Query:</label>
        <input type="text" id="imageSearchInput" placeholder="e.g. 'nature', 'city'..." />
      </div>
      <div class="buttons">
        <button id="imageSearchBtn">Search Images</button>
      </div>
      <p style="font-size:0.85rem; color:#bbb;">
        Replace the placeholder fetch URL and API key in the code with your actual Pexels/Unsplash endpoint.
      </p>
      <div id="imageResults" class="results-grid"></div>
    </div>

    <!-- PREVIEW TAB -->
    <div id="previewTab" class="tab-content">
      <h2>Live Preview (Home Page)</h2>
      <p>
        This preview shows only the first top-level page. Nav links are intercepted so you can click sub-pages too.
      </p>
      <button id="previewBtn" style="margin-bottom:20px;">Update Preview</button>
      <iframe id="previewFrame"></iframe>
    </div>

    <!-- GENERATED CODE TAB -->
    <div id="codeTab" class="tab-content">
      <h2>Generated Code (All Pages)</h2>
      <p>
        Each top-level page has exactly one nav bar. Sub-pages appear in a dropdown. Copy each block to a separate .html file.
      </p>
      <div class="buttons">
        <button id="generateBtn">Generate Site Code</button>
        <button id="clearBtn" style="background:#d9534f;">Clear All</button>
      </div>
      <textarea id="generatedCode" readonly></textarea>
    </div>
  </div>

  <script>
    // --------------------------
    // TAB FUNCTIONALITY
    // --------------------------
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-tab');
        tabButtons.forEach(b => b.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(target).classList.add('active');
      });
    });

    // Default tab
    document.getElementById('basicTab').classList.add('active');
    tabButtons[0].classList.add('active');

    // --------------------------
    // GLOBAL / BASIC SETTINGS
    // --------------------------
    const fontFamily = document.getElementById('fontFamily');
    const globalBgColor = document.getElementById('globalBgColor');
    const globalTextColor = document.getElementById('globalTextColor');
    const globalHeadingColor = document.getElementById('globalHeadingColor');
    const includeNav = document.getElementById('includeNav');

    // --------------------------
    // PAGE & NAVIGATION
    // --------------------------
    const pagesContainer = document.getElementById('pagesContainer');
    const addPageBtn = document.getElementById('addPageBtn');
    let pageCount = 0;
    let pages = [];

    addPageBtn.addEventListener('click', () => {
      createPageEditor(null);
      refreshReferencePageSelect();
    });

    function createPageEditor(parentPage) {
      const pageId = pageCount++;
      const pageObj = {
        id: pageId,
        title: "Untitled Page",
        layout: "single",
        sections: [],
        subPages: []
      };

      if (parentPage) {
        parentPage.subPages.push(pageObj);
      } else {
        pages.push(pageObj);
      }

      const pageDiv = document.createElement('div');
      pageDiv.classList.add('pageItem');
      pageDiv.setAttribute('data-pageid', pageId);

      const pageLevel = parentPage ? "Sub-page" : "Page";
      pageDiv.innerHTML = `
        <div class="pageHeader">
          <h3>${pageLevel} Editor (ID: ${pageId})</h3>
          <button class="removePageBtn" style="background:#d9534f;">Remove</button>
        </div>
        <div class="field">
          <label>Page Title (used for navigation label):</label>
          <input type="text" class="pageTitleInput" value="${pageLevel} ${pageId}" />
        </div>
        <div class="field">
          <label>Layout Style:</label>
          <select class="pageLayoutSelect">
            <option value="single">Single Column</option>
            <option value="two">Two Columns</option>
            <option value="grid">Grid</option>
            <option value="masonry">Masonry</option>
            <option value="cards">Cards</option>
            <option value="three">Three Columns</option>
            <option value="heroGrid">Hero + Grid</option>
            <option value="splitBanner">Split Banner</option>
            <option value="minimalist">Minimalist</option>
          </select>
        </div>
        <h4 style="margin:10px 0;">Sections</h4>
        <div class="sectionContainer"></div>
        <div class="buttons">
          <button class="addSectionBtn" style="background:#28A745;">Add Section</button>
          ${!parentPage ? '<button class="addSubPageBtn" style="background:#5bc0de;">Add Sub-Page</button>' : ''}
        </div>
      `;

      // Place in DOM
      if (parentPage) {
        const parentDiv = pagesContainer.querySelector(`.pageItem[data-pageid="${parentPage.id}"]`);
        if (!parentDiv) {
          pagesContainer.appendChild(pageDiv);
        } else {
          parentDiv.insertAdjacentElement('afterend', pageDiv);
        }
      } else {
        pagesContainer.appendChild(pageDiv);
      }

      // Handlers
      const removeBtn = pageDiv.querySelector('.removePageBtn');
      removeBtn.addEventListener('click', () => {
        removePage(pageObj, pageDiv);
        refreshReferencePageSelect();
      });

      const titleInput = pageDiv.querySelector('.pageTitleInput');
      titleInput.addEventListener('input', (e) => {
        pageObj.title = e.target.value.trim();
      });
      pageObj.title = titleInput.value;

      const layoutSelect = pageDiv.querySelector('.pageLayoutSelect');
      layoutSelect.addEventListener('change', (e) => {
        pageObj.layout = e.target.value;
      });
      pageObj.layout = layoutSelect.value;

      const sectionContainer = pageDiv.querySelector('.sectionContainer');
      const addSectionButton = pageDiv.querySelector('.addSectionBtn');
      addSectionButton.addEventListener('click', () => {
        createSectionEditor(pageObj, sectionContainer);
      });

      if (!parentPage) {
        const addSubPageBtn = pageDiv.querySelector('.addSubPageBtn');
        addSubPageBtn?.addEventListener('click', () => {
          createPageEditor(pageObj);
          refreshReferencePageSelect();
        });
      }
    }

    function removePage(pageObj, pageDiv) {
      if (pageObj) {
        pageObjSubSearch(pageObj.id, pages);
      }
      pageDiv.remove();
    }

    function pageObjSubSearch(id, pageArr) {
      for (let i = 0; i < pageArr.length; i++) {
        if (pageArr[i].id === id) {
          pageArr.splice(i, 1);
          return true;
        } else if (pageArr[i].subPages.length > 0) {
          const found = pageObjSubSearch(id, pageArr[i].subPages);
          if (found) return true;
        }
      }
      return false;
    }

    // Create a single Section Editor
    function createSectionEditor(pageObj, containerEl, fetchedSectionData = null) {
      // If a fetched section is provided, pre-populate from that data
      const sectionData = fetchedSectionData || {
        heading: "",
        paragraph: "",
        iconLibrary: "none",   // none, fontAwesome, materialIcons, nounProject
        iconValue: "",         // "fa fa-user", "face", or a URL
        art: "",
        image: ""
      };

      // Keep track of sections in pageObj
      pageObj.sections.push(sectionData);

      const secDiv = document.createElement('div');
      secDiv.classList.add('sectionItem');
      secDiv.innerHTML = `
        <label>Section Heading:</label>
        <input type="text" class="secHeading" placeholder="Enter heading" />

        <label>Section Paragraph:</label>
        <textarea rows="2" class="secParagraph" placeholder="Enter paragraph"></textarea>

        <label>Icon Library:</label>
        <select class="iconLibrarySelect">
          <option value="none">No Icon</option>
          <option value="fontAwesome">Font Awesome</option>
          <option value="materialIcons">Google Material Icons</option>
          <option value="nounProject">Noun Project (URL)</option>
        </select>

        <div class="iconValueContainer" style="margin: 5px 0;">
          <!-- We'll dynamically show the relevant input based on library selection -->
          <div class="iconValueFields"></div>
        </div>

        <label>Royalty-Free Art/Image URL (Optional):</label>
        <input type="text" class="secArt" placeholder="https://example.com/art.jpg" />

        <label>Image URL (Optional):</label>
        <input type="text" class="secImage" placeholder="Another optional image URL" />

        <button class="removeSectionBtn" style="background:#d9534f; margin-top:8px;">Remove Section</button>
      `;

      containerEl.appendChild(secDiv);

      const headingInput = secDiv.querySelector('.secHeading');
      const paragraphInput = secDiv.querySelector('.secParagraph');
      const iconLibrarySelect = secDiv.querySelector('.iconLibrarySelect');
      const iconValueContainer = secDiv.querySelector('.iconValueContainer .iconValueFields');
      const artInput = secDiv.querySelector('.secArt');
      const imageInput = secDiv.querySelector('.secImage');

      // Initialize from data
      headingInput.value = sectionData.heading || "";
      paragraphInput.value = sectionData.paragraph || "";
      iconLibrarySelect.value = sectionData.iconLibrary || "none";
      artInput.value = sectionData.art || "";
      imageInput.value = sectionData.image || "";

      // Rendering logic for the icon input(s)
      function renderIconField() {
        iconValueContainer.innerHTML = "";
        const currentLib = iconLibrarySelect.value;

        if (currentLib === "none") {
          sectionData.iconValue = "";
          return;
        } else if (currentLib === "fontAwesome") {
          const selectEl = document.createElement('select');
          selectEl.innerHTML = `
            <option value="">(Select an icon)</option>
            <option value="fa fa-user">User</option>
            <option value="fa fa-star">Star</option>
            <option value="fa fa-heart">Heart</option>
            <option value="fa fa-check">Check</option>
            <option value="fa fa-cog">Cog</option>
          `;
          selectEl.value = sectionData.iconValue;
          selectEl.addEventListener('change', e => {
            sectionData.iconValue = e.target.value;
          });
          iconValueContainer.appendChild(selectEl);

        } else if (currentLib === "materialIcons") {
          const inputEl = document.createElement('input');
          inputEl.type = "text";
          inputEl.placeholder = "e.g. 'face', 'home', etc.";
          inputEl.value = sectionData.iconValue || "";
          inputEl.addEventListener('input', e => {
            sectionData.iconValue = e.target.value.trim();
          });
          iconValueContainer.appendChild(inputEl);

        } else if (currentLib === "nounProject") {
          const inputEl = document.createElement('input');
          inputEl.type = "text";
          inputEl.placeholder = "e.g. https://thenounproject.com/.../icon.svg";
          inputEl.value = sectionData.iconValue || "";
          inputEl.addEventListener('input', e => {
            sectionData.iconValue = e.target.value.trim();
          });
          iconValueContainer.appendChild(inputEl);
        }
      }

      // Initial render
      renderIconField();

      // Handlers
      headingInput.addEventListener('input', e => {
        sectionData.heading = e.target.value.trim();
      });
      paragraphInput.addEventListener('input', e => {
        sectionData.paragraph = e.target.value.trim();
      });
      artInput.addEventListener('input', e => {
        sectionData.art = e.target.value.trim();
      });
      imageInput.addEventListener('input', e => {
        sectionData.image = e.target.value.trim();
      });
      iconLibrarySelect.addEventListener('change', () => {
        sectionData.iconLibrary = iconLibrarySelect.value;
        renderIconField();
      });

      const removeSectionBtn = secDiv.querySelector('.removeSectionBtn');
      removeSectionBtn.addEventListener('click', () => {
        const idx = pageObj.sections.indexOf(sectionData);
        if (idx !== -1) {
          pageObj.sections.splice(idx, 1);
        }
        secDiv.remove();
      });
    }

    // --------------------------
    // REFERENCE LAYOUT
    // --------------------------
    const referencePageSelect = document.getElementById('referencePageSelect');
    const referenceURL = document.getElementById('referenceURL');
    const fetchLayoutBtn = document.getElementById('fetchLayoutBtn');
    const referenceStatus = document.getElementById('referenceStatus');

    fetchLayoutBtn.addEventListener('click', async () => {
      const pageId = referencePageSelect.value.trim();
      if (!pageId) {
        referenceStatus.textContent = "Please select a page to import into.";
        return;
      }
      const urlValue = referenceURL.value.trim();
      if (!urlValue) {
        referenceStatus.textContent = "Please enter a valid URL.";
        return;
      }
      try {
        referenceStatus.textContent = "Fetching layout...";

        // Example fetch to your actual backend
        // Replace the URL below with your own server endpoint
        const response = await fetch("https://your-backend.example.com/api/fetch-layout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url: urlValue })
        });

        if (!response.ok) {
          referenceStatus.textContent = "Error fetching layout from the server.";
          return;
        }

        const layoutData = await response.json();
        // e.g. layoutData = [{ heading, paragraph, iconLibrary, iconValue, art, image }, ...]

        const targetPage = findPageById(parseInt(pageId, 10), pages);
        if (!targetPage) {
          referenceStatus.textContent = "Selected page not found in data.";
          return;
        }

        // Clear existing
        targetPage.sections = [];
        const pageDiv = document.querySelector(`.pageItem[data-pageid="${targetPage.id}"]`);
        if (pageDiv) {
          const sectionContainer = pageDiv.querySelector('.sectionContainer');
          sectionContainer.innerHTML = "";
        }

        if (Array.isArray(layoutData)) {
          layoutData.forEach(ld => {
            const newSection = {
              heading: ld.heading || "",
              paragraph: ld.paragraph || "",
              iconLibrary: ld.iconLibrary || "none",
              iconValue: ld.iconValue || "",
              art: ld.art || "",
              image: ld.image || ""
            };
            targetPage.sections.push(newSection);
          });
        }

        if (pageDiv) {
          const sectionContainer = pageDiv.querySelector('.sectionContainer');
          sectionContainer.innerHTML = "";
          targetPage.sections.forEach(secObj => {
            createSectionEditor(targetPage, sectionContainer, secObj);
          });
        }

        referenceStatus.textContent = "Layout imported successfully!";
      } catch (error) {
        console.error(error);
        referenceStatus.textContent = "An error occurred while fetching layout.";
      }
    });

    function findPageById(id, pageArr) {
      for (let p of pageArr) {
        if (p.id === id) return p;
        if (p.subPages && p.subPages.length > 0) {
          const found = findPageById(id, p.subPages);
          if (found) return found;
        }
      }
      return null;
    }

    function refreshReferencePageSelect() {
      const allPages = flattenPages(pages);
      referencePageSelect.innerHTML = "";
      if (allPages.length === 0) {
        referencePageSelect.innerHTML = '<option value="">(No pages yet)</option>';
      } else {
        allPages.forEach(pg => {
          const opt = document.createElement('option');
          opt.value = pg.id;
          opt.textContent = pg.title || `Page ${pg.id}`;
          referencePageSelect.appendChild(opt);
        });
      }
    }

    // --------------------------
    // IMAGES & MEDIA TAB
    // --------------------------
    const imageSearchInput = document.getElementById('imageSearchInput');
    const imageSearchBtn = document.getElementById('imageSearchBtn');
    const imageResults = document.getElementById('imageResults');

    imageSearchBtn.addEventListener('click', async () => {
      const query = imageSearchInput.value.trim();
      if (!query) {
        imageResults.innerHTML = "<p style='color:red;'>Please enter a search term.</p>";
        return;
      }
      // Clear old results
      imageResults.innerHTML = "Searching...";

      try {
        // EXAMPLE for Pexels:
        // let response = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}`, {
        //   headers: {
        //     Authorization: "Bearer YOUR_PEXELS_API_KEY"
        //   }
        // });

        // EXAMPLE for Unsplash (search photos endpoint):
        // let response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&client_id=YOUR_UNSPLASH_ACCESS_KEY`);

        // For demonstration, we just simulate a response object:
        let response = {
          ok: true,
          json: async () => ({
            // Mock data with 'photos' array to simulate Unsplash or Pexels
            results: [
              {
                id: "img1",
                urls: { small: "https://via.placeholder.com/300?text=Sample+1" },
                alt_description: "Sample Image 1"
              },
              {
                id: "img2",
                urls: { small: "https://via.placeholder.com/300?text=Sample+2" },
                alt_description: "Sample Image 2"
              },
              {
                id: "img3",
                urls: { small: "https://via.placeholder.com/300?text=Sample+3" },
                alt_description: "Sample Image 3"
              }
            ]
          })
        };

        if (!response.ok) {
          imageResults.innerHTML = "<p style='color:red;'>Error fetching images.</p>";
          return;
        }

        // If using Unsplash in real code:
        // const data = await response.json();
        // const images = data.results || [];

        // For Pexels in real code: data.photos
        // For this mock, we do:
        const data = await response.json();
        const images = data.results || [];

        if (!images.length) {
          imageResults.innerHTML = "<p style='color:#ccc;'>No results found.</p>";
          return;
        }

        // Render the images
        imageResults.innerHTML = "";
        images.forEach(imgObj => {
          // For Unsplash, you'd use imgObj.urls.small
          // For Pexels, you'd use imgObj.src.small
          // We'll assume .urls.small in this mock
          const imgUrl = imgObj.urls.small;
          const altText = imgObj.alt_description || "No description";

          const wrapper = document.createElement('div');
          wrapper.classList.add('imageResult');
          wrapper.innerHTML = `
            <img src="${imgUrl}" alt="${altText}" />
            <div class="assign-btns">
              <button class="assignArtBtn">Assign as Art</button>
              <button class="assignImageBtn">Assign as Image</button>
            </div>
          `;
          imageResults.appendChild(wrapper);

          // Handlers for assigning images
          const assignArtBtn = wrapper.querySelector('.assignArtBtn');
          const assignImageBtn = wrapper.querySelector('.assignImageBtn');
          assignArtBtn.addEventListener('click', () => openAssignModal(imgUrl, "art"));
          assignImageBtn.addEventListener('click', () => openAssignModal(imgUrl, "image"));
        });
      } catch (err) {
        console.error(err);
        imageResults.innerHTML = "<p style='color:red;'>Failed to retrieve images.</p>";
      }
    });

    function openAssignModal(imgUrl, targetField) {
      // This opens a small prompt: pick which page/section to assign to
      // We'll keep it simple: we generate a small overlay or do a window.prompt approach
      // For more advanced usage, you'd create a custom modal, etc.

      const allPages = flattenPages(pages);
      if (!allPages.length) {
        alert("No pages/sections available to assign images. Please add some pages first.");
        return;
      }

      // Build a quick selection prompt
      const sectionSelectData = [];
      allPages.forEach(pg => {
        pg.sections.forEach((sec, idx) => {
          sectionSelectData.push({
            pageId: pg.id,
            pageTitle: pg.title,
            sectionIndex: idx
          });
        });
      });
      if (!sectionSelectData.length) {
        alert("No sections available to assign images. Please add a section first.");
        return;
      }

      // We’ll create a quick user prompt. You can also do a real modal if you prefer.
      let msg = "Select a section to assign the image:\n";
      sectionSelectData.forEach((sd, i) => {
        msg += `${i}) Page "${sd.pageTitle}" - Section ${sd.sectionIndex}\n`;
      });
      const choice = prompt(msg + "\nEnter the index number:", "0");
      const idx = parseInt(choice, 10);
      if (isNaN(idx) || idx < 0 || idx >= sectionSelectData.length) {
        alert("Invalid selection.");
        return;
      }

      const chosen = sectionSelectData[idx];
      const targetPage = findPageById(chosen.pageId, pages);
      if (!targetPage) {
        alert("Could not find chosen page.");
        return;
      }
      if (!targetPage.sections[chosen.sectionIndex]) {
        alert("Could not find chosen section.");
        return;
      }

      // Assign the image URL
      if (targetField === "art") {
        targetPage.sections[chosen.sectionIndex].art = imgUrl;
      } else {
        targetPage.sections[chosen.sectionIndex].image = imgUrl;
      }

      // Update the UI input field as well
      const pageDiv = document.querySelector(`.pageItem[data-pageid="${targetPage.id}"]`);
      if (pageDiv) {
        const sectionContainer = pageDiv.querySelector('.sectionContainer');
        // We have to find the correct .sectionItem
        const allSectionItems = sectionContainer.querySelectorAll('.sectionItem');
        const secItem = allSectionItems[chosen.sectionIndex];
        if (secItem) {
          if (targetField === "art") {
            secItem.querySelector('.secArt').value = imgUrl;
          } else {
            secItem.querySelector('.secImage').value = imgUrl;
          }
        }
      }

      alert(`Assigned image to Page "${targetPage.title}", Section ${chosen.sectionIndex}, Field: ${targetField}.`);
    }

    // --------------------------
    // PREVIEW & CODE GENERATION
    // --------------------------
    const previewBtn = document.getElementById('previewBtn');
    const previewFrame = document.getElementById('previewFrame');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const generatedCode = document.getElementById('generatedCode');
    let siteMap = {};

    previewBtn.addEventListener('click', () => {
      if (pages.length === 0) {
        previewFrame.srcdoc = "<p style='color:red;'>No pages found. Please add a page.</p>";
        return;
      }
      siteMap = {};
      const flatList = flattenPages(pages);
      flatList.forEach(pg => {
        const code = buildPageHTML(pg, true);
        const fname = pageFilename(pg);
        siteMap[fname] = code;
      });
      // Show the first top-level page
      const homePage = pages[0];
      const homeFilename = pageFilename(homePage);
      previewFrame.srcdoc = siteMap[homeFilename];
    });

    // Intercept nav links in the preview
    window.openPageInPreview = function(filename) {
      if (siteMap[filename]) {
        previewFrame.srcdoc = siteMap[filename];
      }
    };

    generateBtn.addEventListener('click', () => {
      let allCode = "";
      if (pages.length === 0) {
        allCode = "<!-- No pages defined -->";
      } else {
        siteMap = {};
        const flatList = flattenPages(pages);
        flatList.forEach(pg => {
          const pgCode = buildPageHTML(pg, false);
          const fname = pageFilename(pg);
          pg.filename = fname;
          siteMap[fname] = pgCode;
          allCode += `<!-- PAGE: ${fname} -->\n${pgCode}\n\n`;
        });
      }
      generatedCode.value = allCode.trim();
    });

    clearBtn.addEventListener('click', () => {
      fontFamily.value = "'Montserrat', sans-serif";
      globalBgColor.value = "#ffffff";
      globalTextColor.value = "#000000";
      globalHeadingColor.value = "#000000";
      includeNav.checked = false;
      pageCount = 0;
      pages = [];
      pagesContainer.innerHTML = "";
      referencePageSelect.innerHTML = '<option value="">(No pages yet)</option>';
      imageResults.innerHTML = "";
      previewFrame.srcdoc = "";
      generatedCode.value = "";
      siteMap = {};
      tabButtons.forEach(b => b.classList.remove('active'));
      tabContents.forEach(tc => tc.classList.remove('active'));
      tabButtons[0].classList.add('active');
      tabContents[0].classList.add('active');
    });

    function flattenPages(pageArr) {
      let result = [];
      for (let p of pageArr) {
        result.push(p);
        if (p.subPages && p.subPages.length > 0) {
          result = result.concat(flattenPages(p.subPages));
        }
      }
      return result;
    }

    function pageFilename(pg) {
      const t = pg.title.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/gi, '');
      if (!t) return "page-" + pg.id + ".html";
      return t + ".html";
    }

    // Check if page is top-level
    function isTopLevel(pageObj) {
      return pages.includes(pageObj);
    }

    // Build final HTML for a page
    function buildPageHTML(pageObj, isPreviewNav) {
      const pageTitle = pageObj.title.trim() || "Untitled Page";
      const sectionsHTML = buildSectionsHTML(pageObj.sections);

      let navHTML = "";
      // Only build a nav if it's a top-level page
      if (includeNav.checked && isTopLevel(pageObj)) {
        navHTML = buildNavHTML(pages, isPreviewNav);
      }

      let layoutCSS = getLayoutCSS(pageObj.layout);

      // We detect usage of FA or Material Icons
      const usedFA = checkIconUse(pageObj, "fontAwesome");
      const usedMI = checkIconUse(pageObj, "materialIcons");

      const faLink = usedFA
        ? `<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">\n`
        : "";

      const materialIconsLink = usedMI
        ? `<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />\n`
        : "";

      const gBg = globalBgColor.value;
      const gTxt = globalTextColor.value;
      const gHead = globalHeadingColor.value;
      const gFont = fontFamily.value.trim() || "Arial, sans-serif";
      const metaDesc = "Page: " + pageTitle;

      return `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>${pageTitle}</title>
  <meta name="description" content="${metaDesc}">
  ${faLink}${materialIconsLink}
  <style>
    body {
      background-color: ${gBg};
      color: ${gTxt};
      font-family: ${gFont};
      margin: 0; 
      padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    h1, h2, h3 {
      color: ${gHead};
      margin-bottom: 15px;
    }
    p {
      margin-bottom: 15px;
      line-height: 1.6;
    }
    ${layoutCSS}
    nav {
      background: ${gHead};
      padding: 15px;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
      align-items: center;
      position: relative;
    }
    nav li {
      position: relative;
    }
    nav a {
      color: ${gBg};
      text-decoration: none;
      font-weight: bold;
    }
    .submenu {
      position: absolute;
      display: none;
      top: 50px;
      left: 0;
      flex-direction: column;
      background-color: ${gHead};
      padding: 10px;
      border-radius: 5px;
    }
    .submenu li {
      margin: 5px 0;
    }
    .has-submenu:hover .submenu {
      display: flex;
    }
    .has-submenu > a::after {
      content: " \\25BC";
      margin-left: 5px;
      font-size: 0.8em;
    }
  </style>
</head>
<body>
  ${navHTML}
  <div class="container">
    <h1>${pageTitle}</h1>
    <div class="layout-container">
      ${sectionsHTML}
    </div>
  </div>
</body>
</html>
      `.trim();
    }

    function buildSectionsHTML(sections) {
      let html = "";
      sections.forEach(sec => {
        const heading = sec.heading || "Section Heading";
        const paragraph = sec.paragraph || "Lorem ipsum dolor sit amet.";
        let iconHTML = "";

        if (sec.iconLibrary === "fontAwesome" && sec.iconValue) {
          iconHTML = `<i class="${sec.iconValue}" style="margin-right:8px;"></i>`;
        } else if (sec.iconLibrary === "materialIcons" && sec.iconValue) {
          iconHTML = `<span class="material-symbols-outlined" style="vertical-align: middle; margin-right:4px;">${sec.iconValue}</span>`;
        } else if (sec.iconLibrary === "nounProject" && sec.iconValue) {
          iconHTML = `<img src="${sec.iconValue}" alt="Icon" style="width:24px; height:auto; margin-right:8px; vertical-align:middle;" />`;
        }

        let artHTML = sec.art 
          ? `<img src="${sec.art}" alt="Art" style="max-width:100%; height:auto; margin:15px 0;" />` 
          : "";
        let imageHTML = sec.image
          ? `<img src="${sec.image}" alt="Section" style="max-width:100%; height:auto; margin:15px 0;" />` 
          : "";

        html += `
          <div class="layout-item">
            <h2>${iconHTML}${heading}</h2>
            <p>${paragraph}</p>
            ${artHTML}
            ${imageHTML}
          </div>
        `;
      });
      return html;
    }

    function buildNavHTML(pageArr, isPreviewNav) {
      if (!pageArr.length) return "";
      let nav = `<nav><ul>`;
      pageArr.forEach(pageObj => {
        const fname = pageFilename(pageObj);
        const label = pageObj.title || "Untitled";
        if (pageObj.subPages && pageObj.subPages.length) {
          nav += `
          <li class="has-submenu">
            ${buildNavLink(fname, label, isPreviewNav)}
            <ul class="submenu">`;
          pageObj.subPages.forEach(sp => {
            const sfname = pageFilename(sp);
            const slabel = sp.title || "Untitled";
            nav += `<li>${buildNavLink(sfname, slabel, isPreviewNav)}</li>`;
          });
          nav += `</ul>
          </li>`;
        } else {
          nav += `<li>${buildNavLink(fname, label, isPreviewNav)}</li>`;
        }
      });
      nav += `</ul></nav>`;
      return nav;
    }

    function buildNavLink(filename, label, isPreviewNav) {
      if (isPreviewNav) {
        return `<a href="${filename}" onclick="if(window.parent && window.parent.openPageInPreview){window.parent.openPageInPreview('${filename}');return false;}">${label}</a>`;
      } else {
        return `<a href="${filename}">${label}</a>`;
      }
    }

    function getLayoutCSS(layoutValue) {
      if (layoutValue === 'single') {
        return `
.layout-container {
  display: block;
}
.layout-item {
  margin-bottom: 40px;
}
        `;
      } else if (layoutValue === 'two') {
        return `
.layout-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}
.layout-item {
  flex: 1 1 calc(50% - 20px);
  margin-bottom: 20px;
  background: #f8f8f8;
  color: #000;
  padding: 20px;
  border-radius: 5px;
}
@media (max-width: 768px) {
  .layout-item {
    flex: 1 1 100%;
  }
}
        `;
      } else if (layoutValue === 'grid') {
        return `
.layout-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}
.layout-item {
  background: #f8f8f8;
  color: #000;
  padding: 20px;
  border-radius: 5px;
}
        `;
      } else if (layoutValue === 'masonry') {
        return `
.layout-container {
  column-count: 3;
  column-gap: 20px;
}
.layout-item {
  display: inline-block;
  width: 100%;
  margin-bottom: 20px;
  background: #f8f8f8;
  color: #000;
  padding: 20px;
  border-radius: 5px;
}
@media (max-width: 992px) {
  .layout-container {
    column-count: 2;
  }
}
@media (max-width: 576px) {
  .layout-container {
    column-count: 1;
  }
}
        `;
      } else if (layoutValue === 'cards') {
        return `
.layout-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}
.layout-item {
  background: #f8f8f8;
  color: #000;
  border-radius: 5px;
  padding: 20px;
  width: 100%;
  max-width: 300px;
}
        `;
      } else if (layoutValue === 'three') {
        return `
.layout-container {
  display: flex;
  gap: 20px;
}
.layout-item {
  flex: 1;
  background: #f8f8f8;
  color: #000;
  padding: 20px;
  border-radius: 5px;
  margin-bottom: 20px;
}
@media (max-width: 768px) {
  .layout-container {
    flex-direction: column;
  }
}
        `;
      } else if (layoutValue === 'heroGrid') {
        return `
.layout-container {
  display: grid;
  grid-template-rows: 300px auto;
  gap: 20px;
}
.layout-container .layout-item:first-child {
  grid-row: 1;
  background: #4A88F6;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
}
.layout-container .layout-item:first-child h2 {
  margin-bottom: 0;
}
.layout-container .layout-item:not(:first-child) {
  background: #f8f8f8;
  color: #000;
  padding: 20px;
  border-radius: 5px;
}
@media (max-width: 768px) {
  .layout-container {
    grid-template-rows: 200px auto;
  }
}
        `;
      } else if (layoutValue === 'splitBanner') {
        return `
.layout-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}
.layout-item {
  background: #f8f8f8;
  color: #000;
  padding: 20px;
  border-radius: 5px;
  width: 100%;
}
.layout-item:first-child {
  display: flex;
  flex: 1 1 100%;
  background: #4A88F6;
  color: #ffffff;
  margin-bottom: 0;
  align-items: center;
  justify-content: center;
}
.layout-item:first-child h2 {
  margin: 0;
}
@media (max-width: 768px) {
  .layout-item:first-child {
    flex-direction: column;
    text-align: center;
    height: auto;
  }
}
        `;
      } else if (layoutValue === 'minimalist') {
        return `
.layout-container {
  display: block;
  padding: 20px;
}
.layout-item {
  border-bottom: 1px solid #ccc;
  padding: 20px 0;
  background: #fff;
  color: #000;
}
.layout-item:last-child {
  border-bottom: none;
}
        `;
      } else {
        // Default fallback
        return `
.layout-container {
  display: block;
}
.layout-item {
  margin-bottom: 40px;
}
        `;
      }
    }

    function checkIconUse(pageObj, libraryType) {
      // Check current page sections for this library
      const pageHasIcons = pageObj.sections.some(s => s.iconLibrary === libraryType && s.iconValue);
      if (pageHasIcons) return true;

      // Check sub-pages recursively
      if (pageObj.subPages && pageObj.subPages.length > 0) {
        for (let sp of pageObj.subPages) {
          if (checkIconUse(sp, libraryType)) return true;
        }
      }
      return false;
    }
  </script>
</body>
</html>
