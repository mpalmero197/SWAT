<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Web Builder - Dark Mode</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap');

    /* Basic Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #181818; /* Dark background */
      color: #cfcfcf;           /* Light text */
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background-color: #202020; /* Slightly lighter dark for contrast */
      border-right: 1px solid #2a2a2a;
      display: flex;
      flex-direction: column;
    }
    .sidebar h1 {
      padding: 20px;
      font-size: 1.5rem;
      font-weight: 700;
      border-bottom: 1px solid #2a2a2a;
      margin-bottom: 0;
      text-align: center;
      color: #fff; /* Stand out in the sidebar */
    }

    .tab-nav {
      display: flex;
      flex-direction: column;
    }
    .tab-btn {
      background: none;
      border: none;
      padding: 15px 20px;
      text-align: left;
      font-size: 1rem;
      cursor: pointer;
      border-bottom: 1px solid #2a2a2a;
      transition: background 0.3s;
      color: #cfcfcf;
    }
    .tab-btn:hover {
      background-color: #2e2e2e;
    }
    .tab-btn.active {
      background-color: #4A88F6;
      border-left: 4px solid #4A88F6;
      font-weight: 600;
      color: #fff;
    }

    /* Main Content Wrapper */
    .main-content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      background-color: #181818;
    }
    .main-content h2 {
      margin-bottom: 10px;
      font-weight: 600;
      font-size: 1.2rem;
      color: #fff;
    }
    .main-content p {
      color: #bbb;
      line-height: 1.5;
      margin-bottom: 15px;
    }

    /* Tab Contents */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* Fields & Buttons */
    .field {
      margin-bottom: 15px;
    }
    .field label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      font-size: 0.95rem;
      color: #ccc;
    }
    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #3a3a3a;
      background-color: #2a2a2a;
      outline: none;
      font-size: 0.95rem;
      color: #cfcfcf;
      transition: border-color 0.2s, background-color 0.2s;
    }
    .field input[type="color"] {
      height: 40px;
      cursor: pointer;
      border: none;
    }
    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: #4A88F6;
      background-color: #333;
    }

    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    button {
      cursor: pointer;
      background: #4A88F6;
      color: #fff;
      padding: 10px 18px;
      border: none;
      border-radius: 4px;
      font-size: 0.95rem;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    button:hover {
      background: #3c74d4;
      transform: translateY(-1px);
    }
    button.removePageBtn {
      background-color: #d9534f;
    }
    button.removePageBtn:hover {
      background-color: #c9302c;
    }

    /* Page Editor UI */
    .pageItem {
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
      transition: box-shadow 0.3s;
    }
    .pageItem:hover {
      box-shadow: 0 2px 6px rgba(255, 255, 255, 0.03);
    }
    .pageItem .pageHeader {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .pageItem h3 {
      font-size: 1rem;
      margin: 0;
      flex: 1;
      color: #fff;
    }

    /* Section Container */
    .sectionContainer {
      margin-top: 15px;
    }
    .sectionItem {
      background: #1f1f1f;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 10px;
      position: relative;
      border: 1px solid #333;
    }
    .sectionItem label {
      font-size: 0.85rem;
      color: #ccc;
    }

    .reorder-btns {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .reorder-btns button {
      background-color: #444;
      color: #eee;
      padding: 3px;
      width: 28px;
      height: 28px;
      border-radius: 4px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
    }
    .reorder-btns button:hover {
      background-color: #555;
    }

    /* Preview & Generated Code */
    #previewFrame {
      width: 100%;
      height: 500px;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      background: #2a2a2a;
    }
    #generatedCode {
      margin-top: 20px;
      background: #1f1f1f;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      padding: 15px;
      width: 100%;
      height: 400px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      resize: none;
      color: #ccc;
    }

    /* Submenu Style */
    nav {
      background: #111;
      padding: 15px;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
      align-items: center;
      position: relative;
    }
    nav li {
      position: relative;
    }
    nav a {
      color: #fff;
      text-decoration: none;
      font-weight: bold;
    }
    .submenu {
      position: absolute;
      display: none;
      top: 50px;
      left: 0;
      flex-direction: column;
      background-color: #222;
      padding: 10px;
      border-radius: 5px;
    }
    .submenu li {
      margin: 5px 0;
    }
    .has-submenu:hover .submenu {
      display: flex;
    }
    .has-submenu > a::after {
      content: " \25BC";
      margin-left: 5px;
      font-size: 0.8em;
    }

    /* Image Results Grid */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .imageResult {
      position: relative;
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      padding: 10px;
      border-radius: 5px;
      transition: box-shadow 0.3s;
    }
    .imageResult:hover {
      box-shadow: 0 2px 6px rgba(255, 255, 255, 0.03);
    }
    .imageResult img {
      width: 100%;
      border-radius: 3px;
    }
    .assign-btns {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* Responsive Layout */
    @media (max-width: 900px) {
      .sidebar {
        width: 180px;
      }
      .tab-btn {
        padding: 10px 15px;
      }
    }
    @media (max-width: 600px) {
      .sidebar {
        position: fixed;
        width: 60px;
        z-index: 999;
      }
      .sidebar h1 {
        display: none;
      }
      .tab-btn {
        font-size: 0;
        text-align: center;
        border-left: none;
      }
      .tab-btn::after {
        content: attr(data-label);
        font-size: 1rem;
        color: #cfcfcf;
      }
      .main-content {
        margin-left: 60px;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar Navigation -->
  <div class="sidebar">
    <h1>Web Builder</h1>
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="basicTab" data-label="Basic">Basic Settings</button>
      <button class="tab-btn" data-tab="pagesTab" data-label="Pages">Pages & Navigation</button>
      <button class="tab-btn" data-tab="referenceTab" data-label="Reference">Reference Layout</button>
      <button class="tab-btn" data-tab="imagesTab" data-label="Images">Images & Media</button>
      <button class="tab-btn" data-tab="previewTab" data-label="Preview">Preview</button>
      <button class="tab-btn" data-tab="codeTab" data-label="Code">Generated Code</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- BASIC SETTINGS TAB -->
    <div id="basicTab" class="tab-content active">
      <h2>Global Settings</h2>
      <div class="field">
        <label for="fontFamily">Font Family:</label>
        <select id="fontFamily">
          <option value="Arial, sans-serif">Arial</option>
          <option value="'Helvetica Neue', sans-serif">Helvetica Neue</option>
          <option value="'Montserrat', sans-serif" selected>Montserrat</option>
          <option value="'Times New Roman', serif">Times New Roman</option>
          <option value="Georgia, serif">Georgia</option>
        </select>
      </div>
      <div class="field">
        <label for="globalBgColor">Background Color:</label>
        <input type="color" id="globalBgColor" value="#ffffff" />
      </div>
      <div class="field">
        <label for="globalTextColor">Text Color:</label>
        <input type="color" id="globalTextColor" value="#000000" />
      </div>
      <div class="field">
        <label for="globalHeadingColor">Heading Color:</label>
        <input type="color" id="globalHeadingColor" value="#000000" />
      </div>
      <div class="field">
        <label for="includeNav">Include Navigation Bar:</label>
        <input type="checkbox" id="includeNav" />
      </div>
    </div>

    <!-- PAGES & NAVIGATION TAB -->
    <div id="pagesTab" class="tab-content">
      <h2>Pages & Navigation</h2>
      <p>Add pages (and optional sub-pages). Sub-pages become dropdown items under their parent in the nav.</p>
      <div class="buttons">
        <button id="addPageBtn" style="background:#28A745;">Add New Top-Level Page</button>
      </div>
      <div id="pagesContainer"></div>
    </div>

    <!-- REFERENCE LAYOUT TAB -->
    <div id="referenceTab" class="tab-content">
      <h2>Reference Layout via Paste</h2>
      <p>Copy HTML code from another siteâ€™s source and paste it here to extract headings/paragraphs as sections.</p>
      <div class="field">
        <label for="manualHtmlInput">Paste HTML Code Here:</label>
        <textarea id="manualHtmlInput" rows="10" placeholder="Copy &amp; paste HTML source from another site..."></textarea>
      </div>
      <div class="buttons">
        <button id="importHtmlBtn">Import Layout from Pasted HTML</button>
      </div>
      <p style="font-size:0.85rem; color:#999;">
        This bypasses CORS since you, the user, provide the HTML manually.
      </p>
    </div>

    <!-- IMAGES & MEDIA TAB -->
    <div id="imagesTab" class="tab-content">
      <h2>Royalty-Free Images</h2>
      <p>Search for royalty-free images (e.g., from Pexels or Unsplash) and assign them to your sections.</p>
      <div class="field">
        <label for="imageSearchInput">Search Query:</label>
        <input type="text" id="imageSearchInput" placeholder="e.g. 'nature', 'city'..." />
      </div>
      <div class="buttons">
        <button id="imageSearchBtn">Search Images</button>
      </div>
      <p style="font-size:0.85rem; color:#999;">
        Replace the placeholder fetch URL and API key in the code with your actual Pexels/Unsplash credentials.
      </p>
      <div id="imageResults" class="results-grid"></div>
    </div>

    <!-- PREVIEW TAB -->
    <div id="previewTab" class="tab-content">
      <h2>Live Preview (Home Page)</h2>
      <p>This preview shows only the first top-level page. Nav links are intercepted so you can click sub-pages too.</p>
      <button id="previewBtn" style="margin-bottom:20px;">Update Preview</button>
      <iframe id="previewFrame"></iframe>
    </div>

    <!-- GENERATED CODE TAB -->
    <div id="codeTab" class="tab-content">
      <h2>Generated Code (All Pages)</h2>
      <p>Each top-level page has exactly one nav bar. Sub-pages appear in a dropdown. Copy each block to a separate .html file.</p>
      <div class="buttons">
        <button id="generateBtn">Generate Site Code</button>
        <button id="clearBtn" style="background:#d9534f;">Clear All</button>
      </div>
      <textarea id="generatedCode" readonly></textarea>
    </div>
  </div>

  <script>
    // --------------------------
    // TAB FUNCTIONALITY
    // --------------------------
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-tab');
        tabButtons.forEach(b => b.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(target).classList.add('active');
      });
    });

    // Default tab
    document.getElementById('basicTab').classList.add('active');
    tabButtons[0].classList.add('active');

    // --------------------------
    // GLOBAL / BASIC SETTINGS
    // --------------------------
    const fontFamily = document.getElementById('fontFamily');
    const globalBgColor = document.getElementById('globalBgColor');
    const globalTextColor = document.getElementById('globalTextColor');
    const globalHeadingColor = document.getElementById('globalHeadingColor');
    const includeNav = document.getElementById('includeNav');

    // --------------------------
    // PAGE & NAVIGATION
    // --------------------------
    const pagesContainer = document.getElementById('pagesContainer');
    const addPageBtn = document.getElementById('addPageBtn');
    let pageCount = 0;
    let pages = [];

    addPageBtn.addEventListener('click', () => {
      createPageEditor(null);
    });

    function createPageEditor(parentPage) {
      const pageId = pageCount++;
      const pageObj = {
        id: pageId,
        title: "Untitled Page",
        layout: "single",
        sections: [],
        subPages: [],
        importedLayoutColors: {
          background: "",
          textColor: "",
        }
      };

      if (parentPage) {
        parentPage.subPages.push(pageObj);
      } else {
        pages.push(pageObj);
      }

      const pageDiv = document.createElement('div');
      pageDiv.classList.add('pageItem');
      pageDiv.setAttribute('data-pageid', pageId);

      const pageLevel = parentPage ? "Sub-page" : "Page";
      pageDiv.innerHTML = `
        <div class="pageHeader">
          <h3>${pageLevel} Editor (ID: ${pageId})</h3>
          <button class="removePageBtn">Remove</button>
        </div>
        <div class="field">
          <label>Page Title (used for navigation label):</label>
          <input type="text" class="pageTitleInput" value="${pageLevel} ${pageId}" />
        </div>
        <div class="field">
          <label>Layout Style:</label>
          <select class="pageLayoutSelect">
            <option value="single">Single Column</option>
            <option value="two">Two Columns</option>
            <option value="grid">Grid</option>
            <option value="masonry">Masonry</option>
            <option value="cards">Cards</option>
            <option value="three">Three Columns</option>
            <option value="heroGrid">Hero + Grid</option>
            <option value="splitBanner">Split Banner</option>
            <option value="minimalist">Minimalist</option>
            <option value="ReferencedSiteLayout">ReferencedSiteLayout</option>
          </select>
        </div>
        <h4 style="margin:10px 0; color:#fff;">Sections</h4>
        <div class="sectionContainer"></div>
        <div class="buttons">
          <button class="addSectionBtn" style="background:#28A745;">Add Section</button>
          ${!parentPage ? '<button class="addSubPageBtn" style="background:#5bc0de;">Add Sub-Page</button>' : ''}
        </div>
      `;

      if (parentPage) {
        const parentDiv = pagesContainer.querySelector(`.pageItem[data-pageid="${parentPage.id}"]`);
        if (!parentDiv) {
          pagesContainer.appendChild(pageDiv);
        } else {
          parentDiv.insertAdjacentElement('afterend', pageDiv);
        }
      } else {
        pagesContainer.appendChild(pageDiv);
      }

      // Handlers
      const removeBtn = pageDiv.querySelector('.removePageBtn');
      removeBtn.addEventListener('click', () => {
        removePage(pageObj, pageDiv);
      });

      const titleInput = pageDiv.querySelector('.pageTitleInput');
      titleInput.addEventListener('input', (e) => {
        pageObj.title = e.target.value.trim();
      });
      pageObj.title = titleInput.value;

      const layoutSelect = pageDiv.querySelector('.pageLayoutSelect');
      layoutSelect.addEventListener('change', (e) => {
        pageObj.layout = e.target.value;
      });
      pageObj.layout = layoutSelect.value;

      const sectionContainer = pageDiv.querySelector('.sectionContainer');
      const addSectionButton = pageDiv.querySelector('.addSectionBtn');
      addSectionButton.addEventListener('click', () => {
        createSectionEditor(pageObj, sectionContainer);
      });

      if (!parentPage) {
        const addSubPageBtn = pageDiv.querySelector('.addSubPageBtn');
        addSubPageBtn?.addEventListener('click', () => {
          createPageEditor(pageObj);
        });
      }
    }

    function removePage(pageObj, pageDiv) {
      if (pageObj) {
        pageObjSubSearch(pageObj.id, pages);
      }
      pageDiv.remove();
    }

    function pageObjSubSearch(id, pageArr) {
      for (let i = 0; i < pageArr.length; i++) {
        if (pageArr[i].id === id) {
          pageArr.splice(i, 1);
          return true;
        } else if (pageArr[i].subPages.length > 0) {
          const found = pageObjSubSearch(id, pageArr[i].subPages);
          if (found) return true;
        }
      }
      return false;
    }

    // --------------------------
    // SECTION EDITOR (With color/graphic background + text color + reorder)
    // --------------------------
    function createSectionEditor(pageObj, containerEl, fetchedSectionData = null) {
      const sectionData = fetchedSectionData || {
        heading: "",
        paragraph: "",
        iconLibrary: "none",
        iconValue: "",
        art: "",
        image: "",
        bgType: "none",        // "none", "color", "graphic"
        bgColor: "#ffffff",
        bgImage: "",
        headingColor: "",
        paragraphColor: ""
      };

      pageObj.sections.push(sectionData);

      const secDiv = document.createElement('div');
      secDiv.classList.add('sectionItem');
      secDiv.innerHTML = `
        <div class="reorder-btns">
          <button class="moveUpBtn">&#9650;</button>
          <button class="moveDownBtn">&#9660;</button>
        </div>
        <label>Section Heading:</label>
        <input type="text" class="secHeading" placeholder="Enter heading" />

        <label>Section Paragraph:</label>
        <textarea rows="2" class="secParagraph" placeholder="Enter paragraph"></textarea>

        <label>Icon Library:</label>
        <select class="iconLibrarySelect">
          <option value="none">No Icon</option>
          <option value="fontAwesome">Font Awesome</option>
          <option value="materialIcons">Google Material Icons</option>
          <option value="nounProject">Noun Project (URL)</option>
        </select>

        <div class="iconValueContainer" style="margin: 5px 0;">
          <div class="iconValueFields"></div>
        </div>

        <label>Royalty-Free Art/Image URL (Optional):</label>
        <input type="text" class="secArt" placeholder="https://example.com/art.jpg" />

        <label>Image URL (Optional):</label>
        <input type="text" class="secImage" placeholder="Another optional image URL" />

        <hr style="margin:10px 0; border:none; border-top:1px solid #444;" />

        <label>Section Background Type:</label>
        <select class="bgTypeSelect">
          <option value="none">No Override</option>
          <option value="color">Color</option>
          <option value="graphic">Graphic</option>
        </select>

        <div class="field bgColorField" style="display:none;">
          <label>Section Background Color:</label>
          <input type="color" class="secBgColor" value="#ffffff" />
        </div>
        <div class="field bgImageField" style="display:none;">
          <label>Section Background Image URL:</label>
          <input type="text" class="secBgImage" placeholder="https://example.com/background.jpg" />
        </div>

        <label>Heading Text Color (optional):</label>
        <input type="color" class="secHeadingColor" value="" />

        <label>Paragraph Text Color (optional):</label>
        <input type="color" class="secParagraphColor" value="" />

        <button class="removeSectionBtn" style="background:#d9534f; margin-top:8px;">Remove Section</button>
      `;

      containerEl.appendChild(secDiv);

      // DOM References
      const headingInput = secDiv.querySelector('.secHeading');
      const paragraphInput = secDiv.querySelector('.secParagraph');
      const iconLibrarySelect = secDiv.querySelector('.iconLibrarySelect');
      const iconValueContainer = secDiv.querySelector('.iconValueContainer .iconValueFields');
      const artInput = secDiv.querySelector('.secArt');
      const imageInput = secDiv.querySelector('.secImage');
      const bgTypeSelect = secDiv.querySelector('.bgTypeSelect');
      const bgColorField = secDiv.querySelector('.bgColorField');
      const bgImageField = secDiv.querySelector('.bgImageField');
      const secBgColor = secDiv.querySelector('.secBgColor');
      const secBgImage = secDiv.querySelector('.secBgImage');
      const secHeadingColor = secDiv.querySelector('.secHeadingColor');
      const secParagraphColor = secDiv.querySelector('.secParagraphColor');
      const removeSectionBtn = secDiv.querySelector('.removeSectionBtn');
      const moveUpBtn = secDiv.querySelector('.moveUpBtn');
      const moveDownBtn = secDiv.querySelector('.moveDownBtn');

      // Initialize values
      headingInput.value = sectionData.heading || "";
      paragraphInput.value = sectionData.paragraph || "";
      iconLibrarySelect.value = sectionData.iconLibrary || "none";
      artInput.value = sectionData.art || "";
      imageInput.value = sectionData.image || "";
      bgTypeSelect.value = sectionData.bgType || "none";
      secBgColor.value = sectionData.bgColor || "#ffffff";
      secBgImage.value = sectionData.bgImage || "";
      secHeadingColor.value = sectionData.headingColor || "";
      secParagraphColor.value = sectionData.paragraphColor || "";

      // Show/hide color/image fields based on bgType
      function updateBgFields() {
        if (bgTypeSelect.value === "color") {
          bgColorField.style.display = "block";
          bgImageField.style.display = "none";
        } else if (bgTypeSelect.value === "graphic") {
          bgColorField.style.display = "none";
          bgImageField.style.display = "block";
        } else {
          bgColorField.style.display = "none";
          bgImageField.style.display = "none";
        }
      }
      updateBgFields();

      // Events
      bgTypeSelect.addEventListener('change', () => {
        sectionData.bgType = bgTypeSelect.value;
        updateBgFields();
      });
      secBgColor.addEventListener('input', (e) => {
        sectionData.bgColor = e.target.value;
      });
      secBgImage.addEventListener('input', (e) => {
        sectionData.bgImage = e.target.value.trim();
      });
      secHeadingColor.addEventListener('input', (e) => {
        sectionData.headingColor = e.target.value;
      });
      secParagraphColor.addEventListener('input', (e) => {
        sectionData.paragraphColor = e.target.value;
      });
      headingInput.addEventListener('input', e => {
        sectionData.heading = e.target.value.trim();
      });
      paragraphInput.addEventListener('input', e => {
        sectionData.paragraph = e.target.value.trim();
      });
      artInput.addEventListener('input', e => {
        sectionData.art = e.target.value.trim();
      });
      imageInput.addEventListener('input', e => {
        sectionData.image = e.target.value.trim();
      });

      iconLibrarySelect.addEventListener('change', () => {
        sectionData.iconLibrary = iconLibrarySelect.value;
        renderIconField();
      });
      function renderIconField() {
        iconValueContainer.innerHTML = "";
        const currentLib = iconLibrarySelect.value;

        if (currentLib === "none") {
          sectionData.iconValue = "";
          return;
        } else if (currentLib === "fontAwesome") {
          const selectEl = document.createElement('select');
          selectEl.innerHTML = `
            <option value="">(Select an icon)</option>
            <option value="fa fa-user">User</option>
            <option value="fa fa-star">Star</option>
            <option value="fa fa-heart">Heart</option>
            <option value="fa fa-check">Check</option>
            <option value="fa fa-cog">Cog</option>
          `;
          selectEl.value = sectionData.iconValue;
          selectEl.addEventListener('change', e => {
            sectionData.iconValue = e.target.value;
          });
          iconValueContainer.appendChild(selectEl);

        } else if (currentLib === "materialIcons") {
          const inputEl = document.createElement('input');
          inputEl.type = "text";
          inputEl.placeholder = "e.g. 'face', 'home', etc.";
          inputEl.value = sectionData.iconValue || "";
          inputEl.addEventListener('input', e => {
            sectionData.iconValue = e.target.value.trim();
          });
          iconValueContainer.appendChild(inputEl);

        } else if (currentLib === "nounProject") {
          const inputEl = document.createElement('input');
          inputEl.type = "text";
          inputEl.placeholder = "e.g. https://thenounproject.com/.../icon.svg";
          inputEl.value = sectionData.iconValue || "";
          inputEl.addEventListener('input', e => {
            sectionData.iconValue = e.target.value.trim();
          });
          iconValueContainer.appendChild(inputEl);
        }
      }
      renderIconField();

      removeSectionBtn.addEventListener('click', () => {
        const idx = pageObj.sections.indexOf(sectionData);
        if (idx !== -1) {
          pageObj.sections.splice(idx, 1);
        }
        secDiv.remove();
      });

      // Reorder button events
      moveUpBtn.addEventListener('click', () => {
        const idx = pageObj.sections.indexOf(sectionData);
        if (idx > 0) {
          [pageObj.sections[idx - 1], pageObj.sections[idx]] = [pageObj.sections[idx], pageObj.sections[idx - 1]];
          containerEl.insertBefore(secDiv, containerEl.children[idx - 1]);
        }
      });
      moveDownBtn.addEventListener('click', () => {
        const idx = pageObj.sections.indexOf(sectionData);
        if (idx < pageObj.sections.length - 1) {
          [pageObj.sections[idx], pageObj.sections[idx + 1]] = [pageObj.sections[idx + 1], pageObj.sections[idx]];
          containerEl.insertBefore(secDiv, containerEl.children[idx + 2]);
        }
      });
    }

    // --------------------------
    // IMPORT LAYOUT BY PASTING HTML
    // --------------------------
    const importHtmlBtn = document.getElementById('importHtmlBtn');
    const manualHtmlInput = document.getElementById('manualHtmlInput');

    importHtmlBtn.addEventListener('click', () => {
      const htmlString = manualHtmlInput.value.trim();
      if (!htmlString) {
        alert("Please paste some HTML code first.");
        return;
      }

      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlString, "text/html");

      // Example: find <h2> and <p> tags
      const foundHeadings = doc.querySelectorAll('h2');
      const foundParagraphs = doc.querySelectorAll('p');

      const sections = [];
      foundHeadings.forEach((h2El, index) => {
        const headingText = h2El.textContent.trim();
        const paragraphText = foundParagraphs[index]
          ? foundParagraphs[index].textContent.trim()
          : "";

        sections.push({
          heading: headingText,
          paragraph: paragraphText,
          iconLibrary: "none",
          iconValue: "",
          art: "",
          image: "",
          bgType: "none",
          bgColor: "#ffffff",
          bgImage: "",
          headingColor: "",
          paragraphColor: ""
        });
      });

      if (!sections.length) {
        alert("No <h2> tags found or no matching paragraphs. Try adjusting your HTML or parsing logic.");
      }

      const pageId = prompt("Enter the Page ID to insert these sections (e.g., 0, 1, etc.):");
      if (pageId === null) return; // user cancelled

      const targetPage = findPageById(parseInt(pageId, 10), pages);
      if (!targetPage) {
        alert("Page not found.");
        return;
      }

      const pageDiv = document.querySelector(`.pageItem[data-pageid="${targetPage.id}"]`);
      const sectionContainer = pageDiv?.querySelector('.sectionContainer');

      sections.forEach(secObj => {
        targetPage.sections.push(secObj);
        if (sectionContainer) {
          createSectionEditor(targetPage, sectionContainer, secObj);
        }
      });

      // Set layout to ReferencedSiteLayout:
      targetPage.layout = "ReferencedSiteLayout";
      const layoutSelect = pageDiv.querySelector('.pageLayoutSelect');
      if (layoutSelect) {
        layoutSelect.value = "ReferencedSiteLayout";
      }

      alert("Layout imported from pasted HTML!");
    });

    function findPageById(id, pageArr) {
      for (let p of pageArr) {
        if (p.id === id) return p;
        if (p.subPages && p.subPages.length > 0) {
          const found = findPageById(id, p.subPages);
          if (found) return found;
        }
      }
      return null;
    }

    // --------------------------
    // IMAGES & MEDIA TAB
    // --------------------------
    const imageSearchInput = document.getElementById('imageSearchInput');
    const imageSearchBtn = document.getElementById('imageSearchBtn');
    const imageResults = document.getElementById('imageResults');

    imageSearchBtn.addEventListener('click', async () => {
      const query = imageSearchInput.value.trim();
      if (!query) {
        imageResults.innerHTML = "<p style='color:red;'>Please enter a search term.</p>";
        return;
      }
      imageResults.innerHTML = "Searching...";

      try {
        // Replace with your real endpoint / valid API key
        let response = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=12`, {
          headers: {
            Authorization: "2mxS3gi2IIXAmd4anXuVaaNs5k98X0F6KaTpszZYFCJstNfWXVH71gN1"
          }
        });

        if (!response.ok) {
          imageResults.innerHTML = "<p style='color:red;'>Error fetching images.</p>";
          return;
        }

        const data = await response.json();
        const images = data.photos || [];

        if (!images.length) {
          imageResults.innerHTML = "<p style='color:#bbb;'>No results found.</p>";
          return;
        }

        imageResults.innerHTML = "";
        images.forEach(imgObj => {
          const imgUrl = imgObj.src.small;
          const altText = imgObj.alt || "No description";

          const wrapper = document.createElement('div');
          wrapper.classList.add('imageResult');
          wrapper.innerHTML = `
            <img src="${imgUrl}" alt="${altText}" />
            <div class="assign-btns">
              <button class="assignArtBtn">Assign as Art</button>
              <button class="assignImageBtn">Assign as Image</button>
            </div>
          `;
          imageResults.appendChild(wrapper);

          const assignArtBtn = wrapper.querySelector('.assignArtBtn');
          const assignImageBtn = wrapper.querySelector('.assignImageBtn');
          assignArtBtn.addEventListener('click', () => openAssignModal(imgUrl, "art"));
          assignImageBtn.addEventListener('click', () => openAssignModal(imgUrl, "image"));
        });
      } catch (err) {
        console.error(err);
        imageResults.innerHTML = "<p style='color:red;'>Failed to retrieve images.</p>";
      }
    });

    function openAssignModal(imgUrl, targetField) {
      const allPages = flattenPages(pages);
      if (!allPages.length) {
        alert("No pages/sections available. Please add some pages first.");
        return;
      }

      const sectionSelectData = [];
      allPages.forEach(pg => {
        pg.sections.forEach((sec, idx) => {
          sectionSelectData.push({
            pageId: pg.id,
            pageTitle: pg.title,
            sectionIndex: idx
          });
        });
      });
      if (!sectionSelectData.length) {
        alert("No sections available. Please add a section first.");
        return;
      }

      let msg = "Select a section to assign the image:\n";
      sectionSelectData.forEach((sd, i) => {
        msg += `${i}) Page "${sd.pageTitle}" - Section ${sd.sectionIndex}\n`;
      });
      const choice = prompt(msg + "\nEnter the index number:", "0");
      const idx = parseInt(choice, 10);
      if (isNaN(idx) || idx < 0 || idx >= sectionSelectData.length) {
        alert("Invalid selection.");
        return;
      }

      const chosen = sectionSelectData[idx];
      const targetPage = findPageById(chosen.pageId, pages);
      if (!targetPage) {
        alert("Could not find chosen page.");
        return;
      }
      if (!targetPage.sections[chosen.sectionIndex]) {
        alert("Could not find chosen section.");
        return;
      }

      if (targetField === "art") {
        targetPage.sections[chosen.sectionIndex].art = imgUrl;
      } else {
        targetPage.sections[chosen.sectionIndex].image = imgUrl;
      }

      // Update the UI fields if that section is visible
      const pageDiv = document.querySelector(`.pageItem[data-pageid="${targetPage.id}"]`);
      if (pageDiv) {
        const sectionContainer = pageDiv.querySelector('.sectionContainer');
        const allSectionItems = sectionContainer.querySelectorAll('.sectionItem');
        const secItem = allSectionItems[chosen.sectionIndex];
        if (secItem) {
          if (targetField === "art") {
            secItem.querySelector('.secArt').value = imgUrl;
          } else {
            secItem.querySelector('.secImage').value = imgUrl;
          }
        }
      }

      alert(`Assigned image to Page "${targetPage.title}", Section ${chosen.sectionIndex}, Field: ${targetField}.`);
    }

    // --------------------------
    // PREVIEW & CODE GENERATION
    // --------------------------
    const previewBtn = document.getElementById('previewBtn');
    const previewFrame = document.getElementById('previewFrame');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const generatedCode = document.getElementById('generatedCode');
    let siteMap = {};

    previewBtn.addEventListener('click', () => {
      if (pages.length === 0) {
        previewFrame.srcdoc = "<p style='color:red;'>No pages found. Please add a page.</p>";
        return;
      }
      siteMap = {};
      const flatList = flattenPages(pages);
      flatList.forEach(pg => {
        const code = buildPageHTML(pg, true);
        const fname = pageFilename(pg);
        siteMap[fname] = code;
      });
      const homePage = pages[0];
      const homeFilename = pageFilename(homePage);
      previewFrame.srcdoc = siteMap[homeFilename];
    });

    window.openPageInPreview = function(filename) {
      if (siteMap[filename]) {
        previewFrame.srcdoc = siteMap[filename];
      }
    };

    generateBtn.addEventListener('click', () => {
      let allCode = "";
      if (pages.length === 0) {
        allCode = "<!-- No pages defined -->";
      } else {
        siteMap = {};
        const flatList = flattenPages(pages);
        flatList.forEach(pg => {
          const pgCode = buildPageHTML(pg, false);
          const fname = pageFilename(pg);
          pg.filename = fname;
          siteMap[fname] = pgCode;
          allCode += `<!-- PAGE: ${fname} -->\n${pgCode}\n\n`;
        });
      }
      generatedCode.value = allCode.trim();
    });

    clearBtn.addEventListener('click', () => {
      fontFamily.value = "'Montserrat', sans-serif";
      globalBgColor.value = "#ffffff";
      globalTextColor.value = "#000000";
      globalHeadingColor.value = "#000000";
      includeNav.checked = false;
      pageCount = 0;
      pages = [];
      pagesContainer.innerHTML = "";
      manualHtmlInput.value = "";
      imageResults.innerHTML = "";
      previewFrame.srcdoc = "";
      generatedCode.value = "";
      siteMap = {};
      tabButtons.forEach(b => b.classList.remove('active'));
      tabContents.forEach(tc => tc.classList.remove('active'));
      tabButtons[0].classList.add('active');
      tabContents[0].classList.add('active');
    });

    function flattenPages(pageArr) {
      let result = [];
      for (let p of pageArr) {
        result.push(p);
        if (p.subPages && p.subPages.length > 0) {
          result = result.concat(flattenPages(p.subPages));
        }
      }
      return result;
    }

    function pageFilename(pg) {
      const t = pg.title.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/gi, '');
      if (!t) return "page-" + pg.id + ".html";
      return t + ".html";
    }

    function isTopLevel(pageObj) {
      return pages.includes(pageObj);
    }

    function buildPageHTML(pageObj, isPreviewNav) {
      const pageTitle = pageObj.title.trim() || "Untitled Page";
      const sectionsHTML = buildSectionsHTML(pageObj.sections);

      let navHTML = "";
      if (includeNav.checked && isTopLevel(pageObj)) {
        navHTML = buildNavHTML(pages, isPreviewNav);
      }

      let layoutCSS = "";
      if (pageObj.layout === "ReferencedSiteLayout") {
        layoutCSS = getReferencedLayoutCSS(pageObj);
      } else {
        layoutCSS = getLayoutCSS(pageObj.layout);
      }

      const usedFA = checkIconUse(pageObj, "fontAwesome");
      const usedMI = checkIconUse(pageObj, "materialIcons");

      const faLink = usedFA
        ? `<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">\n`
        : "";
      const materialIconsLink = usedMI
        ? `<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />\n`
        : "";

      const gBg = globalBgColor.value;
      const gTxt = globalTextColor.value;
      const gHead = globalHeadingColor.value;
      const gFont = fontFamily.value.trim() || "Arial, sans-serif";
      const metaDesc = "Page: " + pageTitle;

      return `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>${pageTitle}</title>
  <meta name="description" content="${metaDesc}">
  ${faLink}${materialIconsLink}
  <style>
    body {
      background-color: ${gBg};
      color: ${gTxt};
      font-family: ${gFont};
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    h1, h2, h3 {
      color: ${gHead};
      margin-bottom: 15px;
    }
    p {
      margin-bottom: 15px;
      line-height: 1.6;
    }
    ${layoutCSS}
    nav {
      background: ${gHead};
      padding: 15px;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
      align-items: center;
      position: relative;
    }
    nav li {
      position: relative;
    }
    nav a {
      color: ${gBg};
      text-decoration: none;
      font-weight: bold;
    }
    .submenu {
      position: absolute;
      display: none;
      top: 50px;
      left: 0;
      flex-direction: column;
      background-color: ${gHead};
      padding: 10px;
      border-radius: 5px;
    }
    .submenu li {
      margin: 5px 0;
    }
    .has-submenu:hover .submenu {
      display: flex;
    }
    .has-submenu > a::after {
      content: " \\25BC";
      margin-left: 5px;
      font-size: 0.8em;
    }
  </style>
</head>
<body>
  ${navHTML}
  <div class="container">
    <h1>${pageTitle}</h1>
    <div class="layout-container">
      ${sectionsHTML}
    </div>
  </div>
</body>
</html>
      `.trim();
    }

    function buildSectionsHTML(sections) {
      let html = "";
      sections.forEach(sec => {
        const heading = sec.heading || "Section Heading";
        const paragraph = sec.paragraph || "Lorem ipsum dolor sit amet.";
        let iconHTML = "";

        if (sec.iconLibrary === "fontAwesome" && sec.iconValue) {
          iconHTML = `<i class="${sec.iconValue}" style="margin-right:8px;"></i>`;
        } else if (sec.iconLibrary === "materialIcons" && sec.iconValue) {
          iconHTML = `<span class="material-symbols-outlined" style="vertical-align: middle; margin-right:4px;">${sec.iconValue}</span>`;
        } else if (sec.iconLibrary === "nounProject" && sec.iconValue) {
          iconHTML = `<img src="${sec.iconValue}" alt="Icon" style="width:24px; height:auto; margin-right:8px; vertical-align:middle;" />`;
        }

        let artHTML = sec.art
          ? `<img src="${sec.art}" alt="Art" style="max-width:100%; height:auto; margin:15px 0;" />`
          : "";
        let imageHTML = sec.image
          ? `<img src="${sec.image}" alt="Section" style="max-width:100%; height:auto; margin:15px 0;" />`
          : "";

        let itemStyle = "";
        if (sec.bgType === "color") {
          itemStyle = `background:${sec.bgColor};`;
        } else if (sec.bgType === "graphic") {
          itemStyle = `background:url('${sec.bgImage}') center center / cover no-repeat;`;
        }
        const headingStyle = sec.headingColor ? `style="color:${sec.headingColor}; margin-bottom:15px;"` : `style="margin-bottom:15px;"`;
        const paragraphStyle = sec.paragraphColor ? `style="color:${sec.paragraphColor}; margin-bottom:15px;"` : `style="margin-bottom:15px;"`;

        html += `
          <div class="layout-item" style="${itemStyle} padding:20px; border-radius:5px; margin-bottom:20px;">
            <h2 ${headingStyle}>${iconHTML}${heading}</h2>
            <p ${paragraphStyle}>${paragraph}</p>
            ${artHTML}
            ${imageHTML}
          </div>
        `;
      });
      return html;
    }

    function buildNavHTML(pageArr, isPreviewNav) {
      if (!pageArr.length) return "";
      let nav = `<nav><ul>`;
      pageArr.forEach(pageObj => {
        const fname = pageFilename(pageObj);
        const label = pageObj.title || "Untitled";
        if (pageObj.subPages && pageObj.subPages.length) {
          nav += `
          <li class="has-submenu">
            ${buildNavLink(fname, label, isPreviewNav)}
            <ul class="submenu">`;
          pageObj.subPages.forEach(sp => {
            const sfname = pageFilename(sp);
            const slabel = sp.title || "Untitled";
            nav += `<li>${buildNavLink(sfname, slabel, isPreviewNav)}</li>`;
          });
          nav += `</ul>
          </li>`;
        } else {
          nav += `<li>${buildNavLink(fname, label, isPreviewNav)}</li>`;
        }
      });
      nav += `</ul></nav>`;
      return nav;
    }

    function buildNavLink(filename, label, isPreviewNav) {
      if (isPreviewNav) {
        return `<a href="${filename}" onclick="if(window.parent && window.parent.openPageInPreview){window.parent.openPageInPreview('${filename}');return false;}">${label}</a>`;
      } else {
        return `<a href="${filename}">${label}</a>`;
      }
    }

    function getReferencedLayoutCSS(pageObj) {
      const bg = pageObj.importedLayoutColors.background || "#ffffff";
      const txt = pageObj.importedLayoutColors.textColor || "#000000";
      return `
.layout-container {
  display: block;
  background-color: ${bg};
  color: ${txt};
  padding: 20px;
  border-radius: 5px;
}
.layout-item {
  margin-bottom: 40px;
}
      `;
    }

    function getLayoutCSS(layoutValue) {
      if (layoutValue === 'single') {
        return `
.layout-container {
  display: block;
}
.layout-item {
  margin-bottom: 40px;
}
        `;
      } else if (layoutValue === 'two') {
        return `
.layout-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}
.layout-item {
  flex: 1 1 calc(50% - 20px);
  margin-bottom: 20px;
  background: #f8f8f8;
  color: #000;
  padding: 20px;
  border-radius: 5px;
}
@media (max-width: 768px) {
  .layout-item {
    flex: 1 1 100%;
  }
}
        `;
      } else if (layoutValue === 'grid') {
        return `
.layout-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}
.layout-item {
  background: #f8f8f8;
  color: #000;
  padding: 20px;
  border-radius: 5px;
}
        `;
      } else if (layoutValue === 'masonry') {
        return `
.layout-container {
  column-count: 3;
  column-gap: 20px;
}
.layout-item {
  display: inline-block;
  width: 100%;
  margin-bottom: 20px;
  background: #f8f8f8;
  color: #000;
  padding: 20px;
  border-radius: 5px;
}
@media (max-width: 992px) {
  .layout-container {
    column-count: 2;
  }
}
@media (max-width: 576px) {
  .layout-container {
    column-count: 1;
  }
}
        `;
      } else if (layoutValue === 'cards') {
        return `
.layout-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}
.layout-item {
  background: #f8f8f8;
  color: #000;
  border-radius: 5px;
  padding: 20px;
  width: 100%;
  max-width: 300px;
}
        `;
      } else if (layoutValue === 'three') {
        return `
.layout-container {
  display: flex;
  gap: 20px;
}
.layout-item {
  flex: 1;
  background: #f8f8f8;
  color: #000;
  padding: 20px;
  border-radius: 5px;
  margin-bottom: 20px;
}
@media (max-width: 768px) {
  .layout-container {
    flex-direction: column;
  }
}
        `;
      } else if (layoutValue === 'heroGrid') {
        return `
.layout-container {
  display: grid;
  grid-template-rows: 300px auto;
  gap: 20px;
}
.layout-container .layout-item:first-child {
  grid-row: 1;
  background: #4A88F6;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
}
.layout-container .layout-item:first-child h2 {
  margin-bottom: 0;
}
.layout-container .layout-item:not(:first-child) {
  background: #f8f8f8;
  color: #000;
  padding: 20px;
  border-radius: 5px;
}
@media (max-width: 768px) {
  .layout-container {
    grid-template-rows: 200px auto;
  }
}
        `;
      } else if (layoutValue === 'splitBanner') {
        return `
.layout-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}
.layout-item {
  background: #f8f8f8;
  color: #000;
  padding: 20px;
  border-radius: 5px;
  width: 100%;
}
.layout-item:first-child {
  display: flex;
  flex: 1 1 100%;
  background: #4A88F6;
  color: #ffffff;
  margin-bottom: 0;
  align-items: center;
  justify-content: center;
}
.layout-item:first-child h2 {
  margin: 0;
}
@media (max-width: 768px) {
  .layout-item:first-child {
    flex-direction: column;
    text-align: center;
    height: auto;
  }
}
        `;
      } else if (layoutValue === 'minimalist') {
        return `
.layout-container {
  display: block;
  padding: 20px;
}
.layout-item {
  border-bottom: 1px solid #ccc;
  padding: 20px 0;
  background: #fff;
  color: #000;
}
.layout-item:last-child {
  border-bottom: none;
}
        `;
      } else {
        return `
.layout-container {
  display: block;
}
.layout-item {
  margin-bottom: 40px;
}
        `;
      }
    }

    function checkIconUse(pageObj, libraryType) {
      const pageHasIcons = pageObj.sections.some(s => s.iconLibrary === libraryType && s.iconValue);
      if (pageHasIcons) return true;

      if (pageObj.subPages && pageObj.subPages.length > 0) {
        for (let sp of pageObj.subPages) {
          if (checkIconUse(sp, libraryType)) return true;
        }
      }
      return false;
    }
  </script>
</body>
</html>
