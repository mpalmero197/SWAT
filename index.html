<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SWAT Experimental - Simple Website Administration Tool</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Roboto', sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      overflow-x: hidden;
    }
    /* Top Navigation Bar */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: #111;
      border-bottom: 2px solid #4A88F6;
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
    }
    .sidebar h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 1.4rem;
      color: #fff;
      flex: 1;
    }
    .tab-nav {
      display: flex;
      gap: 20px;
    }
    .tab-btn {
      background: none;
      border: none;
      font-size: 1rem;
      color: #bbb;
      cursor: pointer;
      padding: 10px 15px;
      transition: color 0.3s, border-bottom 0.3s;
      border-bottom: 2px solid transparent;
    }
    .tab-btn:hover {
      color: #fff;
    }
    .tab-btn.active {
      color: #4A88F6;
      border-bottom: 2px solid #4A88F6;
    }
    /* Right Media Sidebar */
    #mediaSidebar {
      position: fixed;
      top: 60px;
      right: 0;
      width: 320px;
      height: calc(100vh - 60px);
      background: #1f1f1f;
      padding: 20px;
      border-left: 2px solid #4A88F6;
      z-index: 1000;
    }
    #mediaSidebar h2 {
      font-family: 'Poppins', sans-serif;
      font-size: 1.2rem;
      color: #fff;
      margin-bottom: 10px;
    }
    #mediaSidebar .field label {
      font-size: 0.9rem;
      color: #ccc;
      margin-bottom: 5px;
      display: block;
    }
    #mediaSidebar input[type="text"],
    #mediaSidebar input[type="file"] {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #333;
      background: #2b2b2b;
      color: #fff;
      margin-bottom: 10px;
    }
    .custom-file-label {
      display: inline-block;
      padding: 8px 12px;
      background: #4A88F6;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    #mediaSidebar .buttons button {
      background: #4A88F6;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
      margin-bottom: 10px;
      transition: background 0.3s;
    }
    #mediaSidebar .buttons button:hover {
      background: #3c74d4;
    }
    #undoBtn { background: #f0ad4e; }
    #redoBtn { background: #5bc0de; }
    /* Scrollable media content container */
    .media-content {
      margin-top: 20px;
      overflow-y: auto;
      max-height: calc(100vh - 240px);
    }
    /* Main Content Area */
    .main-content {
      margin-top: 60px;
      margin-right: 320px;
      padding: 30px 20px;
      background: #1a1a1a;
      min-height: calc(100vh - 60px);
    }
    .main-content h2 {
      font-family: 'Poppins', sans-serif;
      font-size: 1.6rem;
      color: #fff;
      margin-bottom: 15px;
    }
    .main-content p {
      color: #ccc;
      line-height: 1.6;
      margin-bottom: 15px;
    }
    /* Original Grid Layout for other sections */
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    .grid-container .field input[type="color"] {
      width: 60px;
      height: 60px;
      padding: 0;
      border: 2px solid #4A88F6;
      border-radius: 4px;
      cursor: pointer;
    }
    /* Tab Contents */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* Form Fields */
    .field {
      margin-bottom: 15px;
    }
    .field label {
      font-size: 0.9rem;
      color: #bbb;
      margin-bottom: 5px;
      display: block;
    }
    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #333;
      background: #2b2b2b;
      color: #e0e0e0;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }
    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: #4A88F6;
    }
    /* Buttons */
    .buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    button {
      background: #4A88F6;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.3s, transform 0.2s;
    }
    button:hover {
      background: #3c74d4;
      transform: translateY(-2px);
    }
    button.removePageBtn { background: #d9534f; }
    button.removePageBtn:hover { background: #c9302c; }
    /* Page Editor UI */
    .pageItem {
      background: #2b2b2b;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
      transition: box-shadow 0.3s;
    }
    .pageItem:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .pageItem .pageHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .pageItem h3 {
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      color: #fff;
    }
    /* Section Container */
    .sectionContainer {
      margin-top: 15px;
    }
    .sectionItem {
      background: #242424;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      border: 1px solid #333;
      position: relative;
    }
    .sectionItem label {
      font-size: 0.85rem;
      color: #ccc;
    }
    .reorder-btns {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .reorder-btns button {
      background: #555;
      color: #eee;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .reorder-btns button:hover {
      background: #666;
    }
    /* Template Cards Styles */
    .templateItem {
      background: #2b2b2b;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .templateItem:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .templateItem h3 {
      margin-bottom: 15px;
      font-family: 'Poppins', sans-serif;
      color: #fff;
    }
    .templateItem button {
      margin-top: 10px;
      background: #4A88F6;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    .templateItem button:hover {
      background: #3c74d4;
    }
    /* Preview & Generated Code */
    #previewFrame {
      width: 100%;
      height: 500px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #2b2b2b;
      margin-top: 20px;
    }
    #generatedCode {
      width: 100%;
      height: 400px;
      background: #1f1f1f;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      color: #fff;
      margin-top: 20px;
    }
    /* Modal Styles */
    .import-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }
    .import-modal {
      background: #fff;
      padding: 20px;
      border-radius: 5px;
      max-width: 400px;
      width: 100%;
      color: #000;
    }
    .import-modal h3 {
      margin-bottom: 15px;
    }
    .import-modal div {
      margin-bottom: 10px;
    }
    .import-modal button {
      padding: 6px 12px;
      margin-top: 10px;
    }
    /* Floating View Source Panel */
    #viewSourcePanel {
      position: fixed;
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      border-radius: 4px;
      z-index: 3000;
      display: none;
      max-width: 300px;
      max-height: 200px;
      overflow: auto;
      word-break: break-all;
    }
    /* Responsive Design */
    @media (max-width: 900px) {
      #mediaSidebar { width: 280px; }
      .main-content { margin-right: 280px; }
    }
    @media (max-width: 600px) {
      .sidebar {
        flex-direction: column;
        height: auto;
        padding: 10px;
      }
      .tab-nav {
        flex-wrap: wrap;
        gap: 10px;
      }
      #mediaSidebar {
        width: 100%;
        height: auto;
        position: relative;
        border-left: none;
        border-top: 2px solid #4A88F6;
        margin-top: 10px;
      }
      .main-content {
        margin-top: calc(60px + 10px + 280px);
        margin-right: 0;
      }
    }
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #2b2b2b; border-radius: 4px; }
    ::-webkit-scrollbar-thumb {
      background: #4A88F6;
      border-radius: 4px;
      border: 2px solid #2b2b2b;
    }
    ::-webkit-scrollbar-thumb:hover { background: #3c74d4; }
    * { scrollbar-width: thin; scrollbar-color: #4A88F6 #2b2b2b; }

    /* =========================
       Basic Settings Revamp Start
       ========================= */
    #basicTab {
      padding: 30px;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border-radius: 8px;
      margin: 20px;
    }
    .basic-settings-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    #basicTab h2 {
      font-family: 'Poppins', sans-serif;
      font-size: 2rem;
      text-align: center;
      color: #fff;
      margin-bottom: 20px;
    }
    .basic-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    .basic-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .basic-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    }
    .basic-card label {
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
      color: #ccc;
    }
    .basic-card input[type="text"],
    .basic-card input[type="number"],
    .basic-card textarea,
    .basic-card select {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      color: #e0e0e0;
      margin-top: 5px;
      transition: background 0.3s;
    }
    .basic-card input:focus,
    .basic-card textarea:focus,
    .basic-card select:focus {
      background: rgba(255, 255, 255, 0.2);
      outline: none;
    }
    .basic-card input[type="color"] {
      -webkit-appearance: none;
      appearance: none;
      width: 40px;
      height: 40px;
      border: 2px solid transparent;
      border-radius: 50%;
      cursor: pointer;
      transition: border 0.3s, box-shadow 0.3s;
      background-color: transparent;
    }
    .basic-card input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }
    .basic-card input[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: 50%;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    .basic-card input[type="color"]:focus {
      outline: none;
      border: 2px solid #4A88F6;
      box-shadow: 0 0 8px rgba(74,136,246,0.8);
    }
    /* =========================
       Basic Settings Revamp End
       ========================= */

    /* ======================================
       Light Theme Overrides (Toggled Class)
       ====================================== */
    body.light-theme {
      background: #fafafa;
      color: #1a1a1a;
    }
    .light-theme .sidebar {
      background: #f4f4f4;
      border-bottom: 2px solid #4A88F6;
    }
    .light-theme .sidebar h1 {
      color: #1a1a1a;
    }
    .light-theme .tab-btn {
      color: #555;
    }
    .light-theme .tab-btn.active {
      color: #4A88F6;
    }
    .light-theme #mediaSidebar {
      background: #eaeaea;
      border-left: 2px solid #4A88F6;
    }
    .light-theme #mediaSidebar h2 {
      color: #333;
    }
    .light-theme #mediaSidebar input[type="text"],
    .light-theme #mediaSidebar input[type="file"] {
      background: #f4f4f4;
      color: #333;
      border: 1px solid #ccc;
    }
    .light-theme #mediaSidebar .buttons button {
      background: #4A88F6;
      color: #fff;
    }
    .light-theme .main-content {
      background: #fff;
      color: #333;
    }
    .light-theme .main-content h2 {
      color: #111;
    }
    .light-theme .main-content p {
      color: #444;
    }
    .light-theme .pageItem {
      background: #f9f9f9;
      border-color: #ddd;
    }
    .light-theme .pageItem h3 {
      color: #111;
    }
    .light-theme .sectionItem {
      background: #f2f2f2;
      border-color: #ccc;
    }
    .light-theme .sectionItem label {
      color: #333;
    }
    .light-theme .field input,
    .light-theme .field textarea,
    .light-theme .field select {
      background: #f9f9f9;
      color: #111;
      border: 1px solid #ccc;
    }
    .light-theme .templateItem {
      background: #f9f9f9;
      border-color: #ddd;
      color: #111;
    }
    .light-theme .templateItem h3 {
      color: #111 !important;
    }
    .light-theme #previewFrame {
      background: #fff;
    }
    .light-theme #generatedCode {
      background: #eee;
      color: #333;
      border: 1px solid #bbb;
    }
    .light-theme #basicTab {
      background: linear-gradient(135deg, #f9f9f9, #efefef);
    }
    .light-theme #basicTab h2 {
      color: #111;
    }
    .light-theme .basic-card {
      background: #fff;
      color: #111;
    }
    .light-theme .basic-card label {
      color: #333;
    }
    .light-theme .basic-card input[type="text"],
    .light-theme .basic-card input[type="number"],
    .light-theme .basic-card textarea,
    .light-theme .basic-card select {
      background: #f9f9f9;
      color: #111;
      border: 1px solid #ccc;
    }
    .light-theme .reorder-btns button {
      background: #ddd;
      color: #333;
    }
    .light-theme #editElementPanel {
      background: #f9f9f9;
      border: 1px solid #ccc;
      color: #111;
    }
    .light-theme label {
      color: #333;
    }
    .light-theme ::placeholder {
      color: #666;
    }

    /* =========================
       Landing Page Styles
       ========================= */
    #landingTab {
      padding: 30px;
      background: linear-gradient(135deg, #2b2b2b, #1a1a1a);
      border-radius: 8px;
      margin: 20px;
    }
    .landing-hero {
      position: relative;
      text-align: center;
      padding: 60px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #2b2b2b, #1a1a1a);
    }
    .landing-hero::before {
      content: "";
      position: absolute;
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0;
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
    }
    .landing-hero-content {
      position: relative;
      z-index: 2;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    .landing-hero h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 2.5rem;
      color: #fff;
      margin-bottom: 15px;
    }
    .landing-hero p {
      color: #ccc;
      font-size: 1.1rem;
      line-height: 1.6;
      margin-bottom: 30px;
    }
    .landing-hero .cta-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .landing-hero .cta-buttons button {
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      border-radius: 6px;
      padding: 12px 20px;
      font-size: 1rem;
      background: #4A88F6;
      transition: background 0.3s;
    }
    .landing-hero .cta-buttons button:hover {
      background: #3c74d4;
    }
    .landing-steps {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .landing-step-card {
      background-color: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 20px;
      transition: transform 0.3s, box-shadow 0.3s;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .landing-step-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }
    .landing-step-card h3 {
      font-family: 'Poppins', sans-serif;
      color: #fff;
      margin-bottom: 10px;
      font-size: 1.2rem;
    }
    .landing-step-card p {
      color: #ccc;
      line-height: 1.4;
    }
    .light-theme #landingTab {
      background: linear-gradient(135deg, #f9f9f9, #efefef);
    }
    .light-theme .landing-hero {
      background: linear-gradient(135deg, #f9f9f9, #ddd);
    }
    .light-theme .landing-hero::before {
      background: rgba(255,255,255,0.35);
    }
    .light-theme .landing-hero h1 {
      color: #111;
    }
    .light-theme .landing-hero p {
      color: #555;
    }
    .light-theme .landing-step-card {
      background-color: rgba(0,0,0,0.05);
    }
    .light-theme .landing-step-card h3 {
      color: #111;
    }
    .light-theme .landing-step-card p {
      color: #333;
    }

    /* Hide the default file input button so that only the custom label is shown */
    #localImageInput {
      display: none;
    }

    /* ========================
       THEME TOGGLE SWITCH - SMALLER
       ======================== */
    .theme-switch-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 20px;
    }
    .theme-switch {
      position: relative;
      display: inline-block;
      width: 30px;
      height: 17px;
    }
    .theme-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; 
      left: 0;
      right: 0; 
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 17px;
    }
    /* Insert day or night icon in the slider */
    .slider:before {
      position: absolute;
      content: "🌞";
      left: 3px;
      bottom: 1px;
      font-size: 14px;
      transition: 0.4s;
    }
    /* When switch is checked, move icon, change content to moon */
    input:checked + .slider {
      background-color: #555;
    }
    input:checked + .slider:before {
      transform: translateX(13px);
      content: "🌙";
      font-size: 14px;
    }
    input:focus + .slider {
      box-shadow: 0 0 1px #4A88F6;
    }
  </style>
</head>
<body>
  <!-- Hidden inputs for folder and image selection, plus text color picker -->
  <input type="file" id="folderInput" webkitdirectory style="display:none;">
  <input type="color" id="textColorPicker" style="display:none;">
  
  <!-- Top Navigation Bar -->
  <div class="sidebar">
    <h1>SWAT Experimental</h1>

    <!-- THEME TOGGLE SWITCH (smaller) -->
    <div class="theme-switch-wrapper">
      <span style="color:#fff;">Theme</span>
      <label class="theme-switch">
        <!-- Checkbox for toggling the theme -->
        <input type="checkbox" id="themeToggleSwitch">
        <span class="slider"></span>
      </label>
    </div>

    <div class="tab-nav">
      <button class="tab-btn active" data-tab="landingTab">Welcome</button>
      <button class="tab-btn" data-tab="basicTab">Basic Settings</button>
      <button class="tab-btn" data-tab="pagesTab">Pages & Navigation</button>
      <button class="tab-btn" data-tab="referenceTab">Reference Layout</button>
      <button class="tab-btn" data-tab="templatesTab">Templates</button>
      <button class="tab-btn" data-tab="previewCodeTab">Preview & Code</button>
    </div>
  </div>
  
  <!-- Right Media Sidebar -->
  <div id="mediaSidebar">
    <h2>Media Options</h2>
    <div class="field">
      <label for="mediaSearchInput">Search Query:</label>
      <input type="text" id="mediaSearchInput" placeholder="e.g. 'nature', 'city'...">
    </div>
    <div class="buttons">
      <button id="mediaSearchBtn">Search Images</button>
    </div>
    <div class="field">
      <label for="localImageInput">Or Choose Image:</label>
      <label for="localImageInput" class="custom-file-label">Browse...</label>
      <input type="file" id="localImageInput" accept="image/*">
    </div>
    <div class="buttons">
      <button id="undoBtn">Undo</button>
      <button id="redoBtn">Redo</button>
    </div>
    <div class="media-content">
      <div id="mediaResults"></div>
    </div>
  </div>
  
  <!-- Main Content Area -->
  <div class="main-content">
    <!-- LANDING PAGE TAB -->
    <div id="landingTab" class="tab-content active">
      <div class="landing-hero">
        <div class="landing-hero-content">
          <h1>Welcome to SWAT Experimental</h1>
          <p>
            Build and customize pages quickly with intuitive controls.  
            Add sections, tweak layouts, and preview in real-time.
          </p>
          <div class="cta-buttons">
            <button id="getStartedBtn">Get Started</button>
          </div>
        </div>
      </div>
      <div class="landing-steps">
        <div class="landing-step-card">
          <h3>1. Configure Basics</h3>
          <p>Set global colors, fonts, and other default settings under “Basic Settings.”</p>
        </div>
        <div class="landing-step-card">
          <h3>2. Create Pages</h3>
          <p>Use “Pages & Navigation” to define top-level and sub-pages for your site.</p>
        </div>
        <div class="landing-step-card">
          <h3>3. Reference Layouts</h3>
          <p>Import an existing HTML layout into a page under “Reference Layout.”</p>
        </div>
        <div class="landing-step-card">
          <h3>4. Use Templates</h3>
          <p>Browse or create templates to speed up page creation in “Templates.”</p>
        </div>
        <div class="landing-step-card">
          <h3>5. Preview & Export</h3>
          <p>Generate code in “Preview & Code” to see your final product and export it.</p>
        </div>
      </div>
    </div>

    <!-- BASIC SETTINGS TAB -->
    <div id="basicTab" class="tab-content">
      <div class="basic-settings-container">
        <h2>Global Settings</h2>
        <div class="basic-grid">
          <div class="basic-card">
            <label for="fontFamilySearch">Font Family:</label>
            <input type="text" id="fontFamilySearch" placeholder="Search fonts (e.g., script, sans-serif)...">
            <div id="fontFamilyContainer" style="max-height:200px; overflow-y:auto; margin-top:5px;"></div>
          </div>
          <div class="basic-card">
            <label for="globalBgColor">Background Color:</label>
            <input type="color" id="globalBgColor" value="#ffffff">
          </div>
          <div class="basic-card">
            <label for="globalTextColor">Text Color:</label>
            <input type="color" id="globalTextColor" value="#000000">
          </div>
          <div class="basic-card">
            <label for="globalHeadingColor">Heading Color:</label>
            <input type="color" id="globalHeadingColor" value="#000000">
          </div>
          <div class="basic-card">
            <label for="includeNav">Include Navigation Bar:</label>
            <input type="checkbox" id="includeNav">
          </div>
          <div class="basic-card">
            <label for="globalFontSize">Font Size (px):</label>
            <input type="number" id="globalFontSize" value="16" min="10" max="72">
          </div>
          <div class="basic-card">
            <label for="globalLineHeight">Line Height:</label>
            <input type="number" step="0.1" id="globalLineHeight" value="1.6" min="1" max="3">
          </div>
          <div class="basic-card">
            <label for="globalLinkColor">Link Color:</label>
            <input type="color" id="globalLinkColor" value="#4A88F6">
          </div>
          <div class="basic-card">
            <label for="globalBgImage">Background Image URL (Optional):</label>
            <input type="text" id="globalBgImage" placeholder="https://example.com/bg.jpg">
          </div>
          <div class="basic-card">
            <label for="globalCustomCSS">Custom CSS (Optional):</label>
            <textarea id="globalCustomCSS" rows="4" placeholder="Additional custom CSS..."></textarea>
          </div>
        </div>
      </div>
    </div>
    
    <!-- PAGES & NAVIGATION TAB -->
    <div id="pagesTab" class="tab-content">
      <h2>Pages & Navigation</h2>
      <p>Add pages (and sub-pages). Sub-pages appear as dropdown items in navigation.</p>
      <div class="buttons">
        <button id="addPageBtn" style="background:#4A88F6;">Add New Page</button>
      </div>
      <div id="pagesContainer"></div>
    </div>
    
    <!-- REFERENCE LAYOUT TAB -->
    <div id="referenceTab" class="tab-content">
      <h2>Reference Layout via Paste</h2>
      <p>Paste HTML code from another site to extract its parts.</p>
      <div class="field">
        <label for="manualHtmlInput">Paste HTML Code Here:</label>
        <textarea id="manualHtmlInput" rows="10" placeholder="Paste HTML source..."></textarea>
      </div>
      <div class="buttons">
        <button id="importHtmlBtn">Import Layout</button>
      </div>
    </div>
    
    <!-- TEMPLATES TAB -->
    <div id="templatesTab" class="tab-content">
      <h2>Template Library</h2>
      <p>Select a template. Remote templates are fetched from GitHub; local templates are saved on your device.</p>
      <div style="display:flex; gap:10px; margin-bottom:10px;">
        <button id="saveTemplateBtn" style="background:#4A88F6;">Save Current Template</button>
        <button id="chooseFolderBtn" style="background:#4A88F6;">Choose Template Folder</button>
      </div>
      <div style="margin-bottom:20px;">
        <h3>Remote Templates</h3>
        <div id="remoteTemplateListContainer" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:20px;"></div>
      </div>
      <div>
        <h3>Local Templates</h3>
        <div id="localTemplateListContainer" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:20px;"></div>
      </div>
    </div>
    
    <!-- PREVIEW & CODE TAB -->
    <div id="previewCodeTab" class="tab-content">
      <h2>Live Preview (Home Page)</h2>
      <p>Preview shows the first top-level page. Navigation links are interactive.</p>
      <div class="buttons">
        <button id="previewBtn">Update Preview</button>
        <button id="toggleViewSourceBtn">Enable View Source</button>
        <button id="changeTextColorBtn">Change Text Color</button>
      </div>
      <iframe id="previewFrame"></iframe>
      <div id="viewSourcePanel"></div>
      <div id="editElementPanel" style="display:none; margin-top:10px; background:#1f1f1f; padding:10px; border:1px solid #444; border-radius:4px;">
        <textarea id="editElementTextarea" style="width:100%; height:150px; font-family:'Courier New', monospace; font-size:0.8rem;"></textarea>
        <div class="buttons">
          <button id="updateElementBtn">Update Element</button>
          <button id="pushUpdatesBtn">Push Updates</button>
          <button id="deleteElementBtn" style="background:#e74c3c;">Delete Element</button>
        </div>
      </div>
      <hr style="margin:20px 0;">
      <h2>Generated Code (All Pages)</h2>
      <p>Each top-level page is generated with a navigation bar; sub-pages appear as dropdowns.</p>
      <div class="buttons">
        <button id="generateBtn">Generate Site Code</button>
        <button id="clearBtn" style="background:#d9534f;">Clear All</button>
      </div>
      <div class="field">
        <label for="codeSearchInput">Search Code:</label>
        <input type="text" id="codeSearchInput" placeholder="Enter search term...">
        <button id="prevBtn">Previous</button>
        <button id="nextBtn">Next</button>
      </div>
      <div class="field">
        <label for="codeReplaceInput">Replace With:</label>
        <input type="text" id="codeReplaceInput" placeholder="Replacement text">
      </div>
      <div class="buttons">
        <button id="replaceAllBtn">Replace All</button>
        <button id="exportHTMLBtn">Export as HTML</button>
      </div>
      <textarea id="generatedCode"></textarea>
    </div>
  </div>
  
  <!-- Modal Styles -->
  <style>
    .import-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex; justify-content: center; align-items: center;
      z-index: 3000;
    }
    .import-modal {
      background: #fff;
      padding: 20px;
      border-radius: 5px;
      max-width: 400px;
      width: 100%;
      color: #000;
    }
    .import-modal h3 { margin-bottom: 15px; }
    .import-modal div { margin-bottom: 10px; }
    .import-modal button { padding: 6px 12px; }
  </style>
  
  <script>
    // Global variable for folder
    let defaultLocalTemplateFolder = localStorage.getItem("defaultLocalTemplateFolder") || "DefaultFolder";
    document.getElementById("chooseFolderBtn").addEventListener("click", function() {
      document.getElementById("folderInput").click();
    });
    document.getElementById("folderInput").addEventListener("change", function(e) {
      const files = e.target.files;
      Array.from(files).forEach(file => {
        if(file.name.toLowerCase().endsWith(".html")) {
          let reader = new FileReader();
          reader.onload = function(ev) {
            let relativePath = file.webkitRelativePath;
            let folder = relativePath.split("/")[0] || "Unknown";
            addLocalTemplateToList(file.name, ev.target.result, folder);
          }
          reader.readAsText(file);
        }
      });
    });
    // Undo/Redo Stacks
    let undoStack = [];
    let redoStack = [];
    // Tab Functionality
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-tab');
        tabButtons.forEach(b => b.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(target).classList.add('active');
      });
    });
    // By default, show the landing tab
    document.getElementById('landingTab').classList.add('active');
    tabButtons[0].classList.add('active');
    
    // -------------- ADDED EVENT LISTENER FOR "Get Started" BUTTON --------------
    document.getElementById('getStartedBtn').addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      tabContents.forEach(tc => tc.classList.remove('active'));
      document.querySelector('.tab-btn[data-tab="basicTab"]').classList.add('active');
      document.getElementById('basicTab').classList.add('active');
    });
    // --------------------------------------------------------------------------
    
    // Font Selection Functionality
    const fontsList = [
      { name: "Arial", category: "sans-serif" },
      { name: "Helvetica Neue", category: "sans-serif" },
      { name: "Montserrat", category: "sans-serif" },
      { name: "Times New Roman", category: "serif" },
      { name: "Georgia", category: "serif" },
      { name: "Roboto", category: "sans-serif" },
      { name: "Open Sans", category: "sans-serif" },
      { name: "Lato", category: "sans-serif" },
      { name: "Oswald", category: "sans-serif" },
      { name: "Raleway", category: "sans-serif" },
      { name: "Merriweather", category: "serif" },
      { name: "Ubuntu", category: "sans-serif" },
      { name: "PT Sans", category: "sans-serif" },
      { name: "Source Sans Pro", category: "sans-serif" },
      { name: "Poppins", category: "sans-serif" },
      { name: "Noto Sans", category: "sans-serif" },
      { name: "Noto Serif", category: "serif" },
      { name: "Roboto Condensed", category: "sans-serif" },
      { name: "Dancing Script", category: "script" },
      { name: "Inconsolata", category: "monospace" }
    ];
    let selectedFont = "'Montserrat', sans-serif";
    const fontFamilySearchInput = document.getElementById('fontFamilySearch');
    const fontFamilyContainer = document.getElementById('fontFamilyContainer');
    function renderFontList(filter = "") {
      fontFamilyContainer.innerHTML = "";
      const filtered = fontsList.filter(f => f.name.toLowerCase().includes(filter.toLowerCase()));
      filtered.forEach(f => {
        const fontDiv = document.createElement('div');
        fontDiv.textContent = f.name;
        fontDiv.style.fontFamily = f.name + ", sans-serif";
        fontDiv.style.padding = "5px";
        fontDiv.style.cursor = "pointer";
        if (selectedFont.indexOf(f.name) !== -1) {
          fontDiv.style.backgroundColor = "#4A88F6";
          fontDiv.style.color = "#fff";
        }
        fontDiv.addEventListener('click', () => {
          selectedFont = f.name + ", sans-serif";
          renderFontList(fontFamilySearchInput.value);
        });
        fontFamilyContainer.appendChild(fontDiv);
      });
    }
    fontFamilySearchInput.addEventListener('input', function() { renderFontList(this.value); });
    renderFontList();
    
    // Pages & Navigation
    const pagesContainer = document.getElementById('pagesContainer');
    const addPageBtn = document.getElementById('addPageBtn');
    let pageCount = 0;
    let pages = [];
    addPageBtn.addEventListener('click', () => { createPageEditor(null); });
    function createPageEditor(parentPage) {
      const pageId = pageCount++;
      const pageObj = { id: pageId, title: "Untitled Page", layout: "single", sections: [], subPages: [], importedParts: null };
      if (parentPage) {
        pageObj.parent = parentPage.id;
        parentPage.subPages.push(pageObj);
      }
      else { pages.push(pageObj); }
      const pageDiv = document.createElement('div');
      pageDiv.classList.add('pageItem');
      pageDiv.setAttribute('data-pageid', pageId);
      const pageLevel = parentPage ? "Sub-page" : "Page";
      pageDiv.innerHTML = `
        <div class="pageHeader">
          <h3>${pageLevel} Editor (ID: ${pageId})</h3>
          <button class="removePageBtn">Remove</button>
        </div>
        <div class="field">
          <label>Page Title:</label>
          <input type="text" class="pageTitleInput" value="${pageLevel} ${pageId}">
        </div>
        <div class="field">
          <label>Layout Style:</label>
          <select class="pageLayoutSelect">
            <option value="single">Single Column</option>
            <option value="two">Two Columns</option>
            <option value="grid">Grid</option>
            <option value="masonry">Masonry</option>
            <option value="cards">Cards</option>
            <option value="three">Three Columns</option>
            <option value="heroGrid">Hero + Grid</option>
            <option value="splitBanner">Split Banner</option>
            <option value="minimalist">Minimalist</option>
            <option value="ReferencedSiteLayout">ReferencedSiteLayout</option>
            <option value="raw">Raw Template</option>
          </select>
        </div>
        <h4 style="margin:10px 0; color:#fff;">Sections</h4>
        <div class="sectionContainer"></div>
        <div class="buttons">
          <button class="addSectionBtn" style="background:#28A745;">Add Section</button>
          ${!parentPage ? '<button class="addSubPageBtn" style="background:#5bc0de;">Add Sub-Page</button>' : ''}
        </div>
      `;
      if (parentPage) {
        const parentDiv = pagesContainer.querySelector(`.pageItem[data-pageid="${parentPage.id}"]`);
        if (!parentDiv) { pagesContainer.appendChild(pageDiv); }
        else { parentDiv.insertAdjacentElement('afterend', pageDiv); }
      } else {
        pagesContainer.appendChild(pageDiv);
      }
      pageDiv.querySelector('.removePageBtn').addEventListener('click', () => { removePage(pageObj, pageDiv); });
      const titleInput = pageDiv.querySelector('.pageTitleInput');
      titleInput.addEventListener('input', (e) => { pageObj.title = e.target.value.trim(); });
      pageObj.title = titleInput.value;
      const layoutSelect = pageDiv.querySelector('.pageLayoutSelect');
      layoutSelect.addEventListener('change', (e) => { pageObj.layout = e.target.value; });
      pageObj.layout = layoutSelect.value;
      const sectionContainer = pageDiv.querySelector('.sectionContainer');
      pageDiv.querySelector('.addSectionBtn').addEventListener('click', () => { createSectionEditor(pageObj, sectionContainer); });
      if (!parentPage) {
        const addSubPageBtn = pageDiv.querySelector('.addSubPageBtn');
        if(addSubPageBtn) {
          addSubPageBtn.addEventListener('click', () => { createPageEditor(pageObj); });
        }
      }
    }
    function removePage(pageObj, pageDiv) {
      if (pageObj) {
        pageObjSubSearch(pageObj.id, pages);
      }
      pageDiv.remove();
    }
    function pageObjSubSearch(id, pageArr) {
      for (let i = 0; i < pageArr.length; i++) {
        if (pageArr[i].id === id) {
          pageArr.splice(i, 1);
          return true;
        }
        else if (pageArr[i].subPages.length > 0) {
          const found = pageObjSubSearch(id, pageArr[i].subPages);
          if (found) return true;
        }
      }
      return false;
    }
    // Section Editor
    function createSectionEditor(pageObj, containerEl, fetchedSectionData = null) {
      const sectionData = fetchedSectionData || {
        heading: "", paragraph: "", iconLibrary: "none", iconValue: "",
        art: "", image: "", bgType: "none", bgColor: "#ffffff", bgImage: "",
        headingColor: "", paragraphColor: "", breakCount: 0, paragraphIndent: 0, customHTML: null
      };
      pageObj.sections.push(sectionData);
      const secDiv = document.createElement('div');
      secDiv.classList.add('sectionItem');
      secDiv.innerHTML = `
        <div class="reorder-btns">
          <button class="moveUpBtn">&#9650;</button>
          <button class="moveDownBtn">&#9660;</button>
        </div>
        <div class="field">
          <label>Section Heading:</label>
          <input type="text" class="secHeading" placeholder="Optional heading">
        </div>
        <div class="field">
          <label>Section Paragraph:</label>
          <textarea rows="4" class="secParagraph" placeholder="Enter paragraph"></textarea>
        </div>
        <div class="field">
          <label>Breaks after Heading:</label>
          <input type="number" class="secBreakCount" value="0" min="0">
        </div>
        <div class="field">
          <label>Paragraph Indentation (px):</label>
          <input type="number" class="secParagraphIndent" value="0" min="0">
        </div>
        <div class="field">
          <label>Icon Library:</label>
          <select class="iconLibrarySelect">
            <option value="none">No Icon</option>
            <option value="fontAwesome">Font Awesome</option>
            <option value="materialIcons">Google Material Icons</option>
            <option value="nounProject">Noun Project (URL)</option>
          </select>
        </div>
        <div class="field">
          <div class="iconValueContainer" style="margin:5px 0;"><div class="iconValueFields"></div></div>
        </div>
        <div class="field">
          <label>Art/Image URL (Optional):</label>
          <input type="text" class="secArt" placeholder="https://example.com/art.jpg">
        </div>
        <div class="field">
          <label>Image URL (Optional):</label>
          <input type="text" class="secImage" placeholder="Optional image URL">
        </div>
        <hr style="margin:10px 0; border-top:1px solid #444;">
        <div class="field">
          <label>Section Background Type:</label>
          <select class="bgTypeSelect">
            <option value="none">No Override</option>
            <option value="color">Color</option>
            <option value="graphic">Graphic</option>
          </select>
        </div>
        <div class="field bgColorField" style="display:none;">
          <label>Background Color:</label>
          <input type="color" class="secBgColor" value="#ffffff">
        </div>
        <div class="field bgImageField" style="display:none;">
          <label>Background Image URL:</label>
          <input type="text" class="secBgImage" placeholder="https://example.com/background.jpg">
        </div>
        <div class="field">
          <label>Heading Text Color:</label>
          <input type="color" class="secHeadingColor" value="">
        </div>
        <div class="field">
          <label>Paragraph Text Color:</label>
          <input type="color" class="secParagraphColor" value="">
        </div>
        <button class="removeSectionBtn" style="background:#d9534f; margin-top:8px;">Remove Section</button>
      `;
      containerEl.appendChild(secDiv);
      const headingInput = secDiv.querySelector('.secHeading');
      const paragraphInput = secDiv.querySelector('.secParagraph');
      const breakCountInput = secDiv.querySelector('.secBreakCount');
      const paragraphIndentInput = secDiv.querySelector('.secParagraphIndent');
      const iconLibrarySelect = secDiv.querySelector('.iconLibrarySelect');
      const iconValueContainer = secDiv.querySelector('.iconValueContainer .iconValueFields');
      const artInput = secDiv.querySelector('.secArt');
      const imageInput = secDiv.querySelector('.secImage');
      const bgTypeSelect = secDiv.querySelector('.bgTypeSelect');
      const bgColorField = secDiv.querySelector('.bgColorField');
      const bgImageField = secDiv.querySelector('.bgImageField');
      const secBgColor = secDiv.querySelector('.secBgColor');
      const secBgImage = secDiv.querySelector('.secBgImage');
      const secHeadingColor = secDiv.querySelector('.secHeadingColor');
      const secParagraphColor = secDiv.querySelector('.secParagraphColor');
      const removeSectionBtn = secDiv.querySelector('.removeSectionBtn');
      const moveUpBtn = secDiv.querySelector('.moveUpBtn');
      const moveDownBtn = secDiv.querySelector('.moveDownBtn');
      headingInput.value = sectionData.heading;
      paragraphInput.value = sectionData.paragraph;
      breakCountInput.value = sectionData.breakCount;
      paragraphIndentInput.value = sectionData.paragraphIndent;
      iconLibrarySelect.value = sectionData.iconLibrary;
      artInput.value = sectionData.art;
      imageInput.value = sectionData.image;
      bgTypeSelect.value = sectionData.bgType;
      secBgColor.value = sectionData.bgColor;
      secBgImage.value = sectionData.bgImage;
      secHeadingColor.value = sectionData.headingColor;
      secParagraphColor.value = sectionData.paragraphColor;
      function updateBgFields() {
        if (bgTypeSelect.value === "color") {
          bgColorField.style.display = "block";
          bgImageField.style.display = "none";
        } else if (bgTypeSelect.value === "graphic") {
          bgColorField.style.display = "none";
          bgImageField.style.display = "block";
        } else {
          bgColorField.style.display = "none";
          bgImageField.style.display = "none";
        }
      }
      updateBgFields();
      bgTypeSelect.addEventListener('change', () => {
        sectionData.bgType = bgTypeSelect.value;
        updateBgFields();
      });
      secBgColor.addEventListener('input', e => { sectionData.bgColor = e.target.value; });
      secBgImage.addEventListener('input', e => { sectionData.bgImage = e.target.value.trim(); });
      secHeadingColor.addEventListener('input', e => { sectionData.headingColor = e.target.value; });
      secParagraphColor.addEventListener('input', e => { sectionData.paragraphColor = e.target.value; });
      headingInput.addEventListener('input', e => { sectionData.heading = e.target.value; });
      paragraphInput.addEventListener('input', e => { sectionData.paragraph = e.target.value; });
      breakCountInput.addEventListener('input', e => { sectionData.breakCount = parseInt(e.target.value, 10) || 0; });
      paragraphIndentInput.addEventListener('input', e => { sectionData.paragraphIndent = parseInt(e.target.value, 10) || 0; });
      artInput.addEventListener('input', e => { sectionData.art = e.target.value.trim(); });
      imageInput.addEventListener('input', e => { sectionData.image = e.target.value.trim(); });
      iconLibrarySelect.addEventListener('change', () => {
        sectionData.iconLibrary = iconLibrarySelect.value;
        renderIconField();
      });
      function renderIconField() {
        iconValueContainer.innerHTML = "";
        const currentLib = iconLibrarySelect.value;
        if (currentLib === "none") {
          sectionData.iconValue = "";
          return;
        }
        else if (currentLib === "fontAwesome") {
          const selectEl = document.createElement('select');
          selectEl.innerHTML = `
            <option value="">(Select an icon)</option>
            <option value="fa fa-user">User</option>
            <option value="fa fa-star">Star</option>
            <option value="fa fa-heart">Heart</option>
            <option value="fa fa-check">Check</option>
            <option value="fa fa-cog">Cog</option>
          `;
          selectEl.value = sectionData.iconValue;
          selectEl.addEventListener('change', e => { sectionData.iconValue = e.target.value; });
          iconValueContainer.appendChild(selectEl);
        } else if (currentLib === "materialIcons") {
          const inputEl = document.createElement('input');
          inputEl.type = "text"; 
          inputEl.placeholder = "e.g. 'face', 'home'";
          inputEl.value = sectionData.iconValue || "";
          inputEl.addEventListener('input', e => { sectionData.iconValue = e.target.value.trim(); });
          iconValueContainer.appendChild(inputEl);
        } else if (currentLib === "nounProject") {
          const inputEl = document.createElement('input');
          inputEl.type = "text";
          inputEl.placeholder = "Icon URL";
          inputEl.value = sectionData.iconValue || "";
          inputEl.addEventListener('input', e => { sectionData.iconValue = e.target.value.trim(); });
          iconValueContainer.appendChild(inputEl);
        }
      }
      renderIconField();
      removeSectionBtn.addEventListener('click', () => {
        const idx = pageObj.sections.indexOf(sectionData);
        if (idx !== -1) {
          pageObj.sections.splice(idx, 1);
        }
        secDiv.remove();
      });
      moveUpBtn.addEventListener('click', () => {
        const idx = pageObj.sections.indexOf(sectionData);
        if (idx > 0) {
          [pageObj.sections[idx - 1], pageObj.sections[idx]] = [pageObj.sections[idx], pageObj.sections[idx - 1]];
          containerEl.insertBefore(secDiv, containerEl.children[idx - 1]);
        }
      });
      moveDownBtn.addEventListener('click', () => {
        const idx = pageObj.sections.indexOf(sectionData);
        if (idx < pageObj.sections.length - 1) {
          [pageObj.sections[idx], pageObj.sections[idx + 1]] = [pageObj.sections[idx + 1], pageObj.sections[idx]];
          containerEl.insertBefore(secDiv, containerEl.children[idx + 2]);
        }
      });
    }
    
    // Dummy functions for icons and layout CSS
    function checkIconUse(pageObj, lib) { return false; }
    function getReferencedLayoutCSS(pageObj) { return ""; }
    function getLayoutCSS(layout) { return ""; }
    
    // Build Sections HTML for Preview
    function buildSectionsHTML(sections, pageId) {
      return sections.map((section, index) => {
        if(section.customHTML) return section.customHTML;
        return `
          <div class="layout-item droppable" data-page-id="${pageId}" data-section-index="${index}" style="position: relative;">
            <h2>${section.heading || "Section " + index}</h2>
            <p>${section.paragraph || ""}</p>
            <div class="image-dropzone">
              ${ section.image 
                ? `<img src="${section.image}" alt="" style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;">`
                : `<div>Drop image here</div>` }
            </div>
          </div>
        `;
      }).join("");
    }
    
    // Import Layout Functionality
    const importHtmlBtn = document.getElementById('importHtmlBtn');
    const manualHtmlInput = document.getElementById('manualHtmlInput');
    importHtmlBtn.addEventListener('click', () => {
      const htmlString = manualHtmlInput.value.trim();
      if (!htmlString) {
        alert("Please paste HTML code.");
        return;
      }
      const parts = separateHTMLParts(htmlString);
      showImportOptions(parts, (selectedParts) => {
        const pageId = prompt("Enter the Page ID to import these parts (e.g., 0, 1):");
        if (pageId === null) return;
        const targetPage = findPageById(parseInt(pageId, 10), pages);
        if (!targetPage) {
          alert("Page not found.");
          return;
        }
        targetPage.importedParts = selectedParts;
        targetPage.layout = "ReferencedSiteLayout";
        const pageDiv = document.querySelector(`.pageItem[data-pageid="${targetPage.id}"]`);
        const layoutSelect = pageDiv.querySelector('.pageLayoutSelect');
        if (layoutSelect) {
          layoutSelect.value = "ReferencedSiteLayout";
        }
        alert("Imported selected HTML parts into the page!");
      });
    });
    function separateHTMLParts(htmlString) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlString, "text/html");
      let headContent = doc.head ? doc.head.innerHTML : "";
      let bodyContent = doc.body ? doc.body.innerHTML : "";
      let styleContent = "";
      let scriptContent = "";
      const styleElements = doc.head ? doc.head.querySelectorAll("style") : [];
      styleElements.forEach(styleEl => {
        styleContent += styleEl.outerHTML;
        headContent = headContent.replace(styleEl.outerHTML, "");
      });
      const scriptElements = doc.querySelectorAll("script");
      scriptElements.forEach(scriptEl => {
        scriptContent += scriptEl.outerHTML;
        if (scriptEl.parentNode.tagName.toLowerCase() === "head") {
          headContent = headContent.replace(scriptEl.outerHTML, "");
        } else if (scriptEl.parentNode.tagName.toLowerCase() === "body") {
          bodyContent = bodyContent.replace(scriptEl.outerHTML, "");
        }
      });
      return { head: headContent.trim(), style: styleContent.trim(), body: bodyContent.trim(), scripts: scriptContent.trim() };
    }
    function showImportOptions(parts, callback) {
      const overlay = document.createElement('div');
      overlay.className = "import-overlay";
      const modal = document.createElement('div');
      modal.className = "import-modal";
      modal.innerHTML = `
        <h3>Select HTML Parts to Import</h3>
        <div><input type="checkbox" id="importHead" checked> <label for="importHead">Head (meta, title, etc.)</label></div>
        <div><input type="checkbox" id="importStyle" checked> <label for="importStyle">Style (CSS)</label></div>
        <div><input type="checkbox" id="importBody" checked> <label for="importBody">Body (Content)</label></div>
        <div><input type="checkbox" id="importScripts" checked> <label for="importScripts">Scripts (JS)</label></div>
        <div style="margin-top:15px; text-align:right;">
          <button id="cancelImport">Cancel</button>
          <button id="confirmImport" style="margin-left:10px;">Confirm</button>
        </div>
      `;
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      document.getElementById('cancelImport').addEventListener('click', () => {
        document.body.removeChild(overlay);
      });
      document.getElementById('confirmImport').addEventListener('click', () => {
        const selectedParts = {};
        if (document.getElementById('importHead').checked) { selectedParts.head = parts.head; }
        if (document.getElementById('importStyle').checked) { selectedParts.style = parts.style; }
        if (document.getElementById('importBody').checked) { selectedParts.body = parts.body; }
        if (document.getElementById('importScripts').checked) { selectedParts.scripts = parts.scripts; }
        document.body.removeChild(overlay);
        callback(selectedParts);
      });
    }
    function findPageById(id, pageArr) {
      for (let p of pageArr) {
        if (p.id === id) return p;
        if (p.subPages && p.subPages.length > 0) {
          const found = findPageById(id, p.subPages);
          if (found) return found;
        }
      }
      return null;
    }
    
    // Media Sidebar Search & Drag/Drop (Pexels API)
    const mediaSearchInput = document.getElementById('mediaSearchInput');
    const mediaSearchBtn = document.getElementById('mediaSearchBtn');
    const mediaResults = document.getElementById('mediaResults');
    mediaSearchBtn.addEventListener('click', async () => {
      const query = mediaSearchInput.value.trim();
      if (!query) {
        mediaResults.innerHTML = "<p style='color:red;'>Please enter a search term.</p>";
        return;
      }
      mediaResults.innerHTML = "Searching...";
      try {
        const response = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=50`, {
          headers: { Authorization: "2mxS3gi2IIXAmd4anXuVaaNs5k98X0F6KaTpszZYFCJstNfWXVH71gN1" }
        });
        if (!response.ok) {
          mediaResults.innerHTML = "<p style='color:red;'>Error fetching images.</p>";
          return;
        }
        const data = await response.json();
        const images = data.photos || [];
        if (!images.length) {
          mediaResults.innerHTML = "<p style='color:#bbb;'>No results found.</p>";
          return;
        }
        mediaResults.innerHTML = "";
        images.forEach(imgObj => {
          const thumbUrl = imgObj.src.small;
          const largeUrl = imgObj.src.large;
          const altText = imgObj.alt || "No description";
          const wrapper = document.createElement('div');
          wrapper.classList.add('imageResult');
          wrapper.innerHTML = `<img src="${thumbUrl}" alt="${altText}" style="max-width:100%;">`;
          wrapper.setAttribute('draggable', 'true');
          wrapper.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData("text/plain", largeUrl);
          });
          mediaResults.appendChild(wrapper);
        });
      } catch (err) {
        console.error(err);
        mediaResults.innerHTML = "<p style='color:red;'>Failed to retrieve images.</p>";
      }
    });
    
    // Local Image Handler
    const localImageInput = document.getElementById('localImageInput');
    localImageInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const wrapper = document.createElement('div');
          wrapper.classList.add('imageResult');
          wrapper.innerHTML = `<img src="${event.target.result}" alt="Local Image" style="max-width:100%;">`;
          wrapper.setAttribute('draggable', 'true');
          wrapper.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData("text/plain", event.target.result);
          });
          mediaResults.appendChild(wrapper);
        };
        reader.readAsDataURL(file);
      } else {
        alert("Please select a valid image file.");
      }
    });
    
    // Preview & Code Generation
    function buildPageHTML(pageObj, isPreviewNav) {
      if (pageObj.layout === "raw" && pageObj.rawHTML) {
        return pageObj.rawHTML;
      }
      const gFont = selectedFont || "Arial, sans-serif";
      const fontName = gFont.split(',')[0].replace(/['"]/g, '').trim();
      const googleFonts = {
        "Montserrat": "https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap",
        "Roboto": "https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap",
        "Open Sans": "https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap",
        "Lato": "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",
        "Oswald": "https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&display=swap",
        "Raleway": "https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700&display=swap",
        "Merriweather": "https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap",
        "Ubuntu": "https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap",
        "PT Sans": "https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap",
        "Source Sans Pro": "https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap",
        "Poppins": "https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      };
      let fontLink = "";
      if (googleFonts[fontName]) {
        fontLink = `<link href="${googleFonts[fontName]}" rel="stylesheet">`;
      }
      const pageTitle = pageObj.title.trim() || "Untitled Page";
      if (pageObj.layout === "ReferencedSiteLayout" && pageObj.importedParts) {
        return `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>${pageTitle}</title>
  ${ checkIconUse(pageObj, "fontAwesome") ? `<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">` : "" }
  ${ checkIconUse(pageObj, "materialIcons") ? `<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />` : "" }
  ${fontLink}
  <style>
    body {
      background-color: ${globalBgColor.value};
      ${globalBgImage.value ? `background-image: url('${globalBgImage.value}'); background-size: cover; background-repeat: no-repeat;` : ''}
      color: ${globalTextColor.value};
      font-family: ${gFont};
      font-size: ${globalFontSize.value}px;
      line-height: ${globalLineHeight.value};
      margin: 0; padding: 0;
    }
    a { color: ${globalLinkColor.value}; }
    ${ pageObj.importedParts.style || '' }
  </style>
  ${ pageObj.importedParts.head || '' }
</head>
<body>
  ${ includeNav.checked && isTopLevel(pageObj) ? buildNavHTML(pages, isPreviewNav) : '' }
  ${ pageObj.importedParts.body || '' }
  ${ pageObj.importedParts.scripts || '' }
</body>
</html>`.trim();
      }
      const sectionsHTML = buildSectionsHTML(pageObj.sections, pageObj.id);
      let navHTML = "";
      if (includeNav.checked && isTopLevel(pageObj)) {
        navHTML = buildNavHTML(pages, isPreviewNav);
      }
      let layoutCSS = (pageObj.layout === "ReferencedSiteLayout") ? getReferencedLayoutCSS(pageObj) : getLayoutCSS(pageObj.layout);
      const usedFA = checkIconUse(pageObj, "fontAwesome");
      const usedMI = checkIconUse(pageObj, "materialIcons");
      const faLink = usedFA ? `<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">\n` : "";
      const materialIconsLink = usedMI ? `<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />\n` : "";
      const gBg = globalBgColor.value;
      const gTxt = globalTextColor.value;
      const gHead = globalHeadingColor.value;
      const gFontSize = globalFontSize.value;
      const gLineHeight = globalLineHeight.value;
      const gLinkColor = globalLinkColor.value;
      const gBgImage = globalBgImage.value.trim();
      const customCSS = globalCustomCSS.value;
      const metaDesc = "Page: " + pageTitle;
      return `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title data-page-id="${pageObj.id}">${pageTitle}</title>
  <meta name="description" content="${metaDesc}">
  ${faLink}${materialIconsLink}${fontLink}
  <style>
    body {
      background-color: ${gBg};
      ${gBgImage ? `background-image: url('${gBgImage}'); background-size: cover; background-repeat: no-repeat;` : ''}
      color: ${gTxt};
      font-family: ${gFont};
      font-size: ${gFontSize}px;
      line-height: ${gLineHeight};
      margin: 0; padding: 0;
    }
    a { color: ${gLinkColor}; }
    .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
    h1, h2, h3 { color: ${gHead}; margin-bottom: 15px; }
    p { margin-bottom: 15px; }
    ${layoutCSS}
    nav { background: ${gHead}; padding: 15px; }
    nav ul {
      list-style: none; display: flex; gap: 20px; margin: 0; padding: 0; align-items: center;
    }
    nav li { position: relative; }
    nav a { color: ${gBg}; text-decoration: none; font-weight: bold; }
    .submenu {
      position: absolute; display: none; top: 50px; left: 0;
      background-color: ${gHead}; padding: 10px; border-radius: 5px;
    }
    .submenu li { margin: 5px 0; }
    .has-submenu:hover .submenu { display: flex; flex-direction: column; }
    .has-submenu > a::after { content: " \\25BC"; margin-left: 5px; font-size: 0.8em; }
    .layout-container {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 20px;
    }
    .layout-container .layout-item {
      background-color: ${gBg}; color: ${gTxt}; padding: 20px; border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.2s ease;
    }
    .layout-container .layout-item:hover {
      transform: translateY(-3px);
    }
    ${customCSS}
  </style>
</head>
<body>
  ${navHTML}
  <div class="container">
    <h1>${pageTitle}</h1>
    <div class="layout-container">
      ${sectionsHTML}
    </div>
  </div>
</body>
</html>`.trim();
    }
    function flattenPages(pageArr) {
      let result = [];
      for (let p of pageArr) {
        result.push(p);
        if (p.subPages && p.subPages.length > 0) {
          result = result.concat(flattenPages(p.subPages));
        }
      }
      return result;
    }
    function pageFilename(pg) {
      const t = pg.title.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/gi, '');
      return t ? t + ".html" : "page-" + pg.id + ".html";
    }
    function isTopLevel(pageObj) {
      return pages.includes(pageObj);
    }
    // Build Navigation HTML
    function buildNavHTML(pageArr, isPreviewNav) {
      let navHTML = `<nav><ul>`;
      pageArr.forEach(p => {
        const filename = pageFilename(p);
        if (p.subPages.length > 0) {
          navHTML += `
            <li class="has-submenu">
              <a href="${isPreviewNav ? '#' : filename}" onclick="${isPreviewNav ? `openPageInPreview('${filename}')` : ''}">${p.title}</a>
              <ul class="submenu">
          `;
          p.subPages.forEach(sp => {
            const subFilename = pageFilename(sp);
            navHTML += `
              <li><a href="${isPreviewNav ? '#' : subFilename}" onclick="${isPreviewNav ? `openPageInPreview('${subFilename}')` : ''}">${sp.title}</a></li>
            `;
          });
          navHTML += `</ul></li>`;
        } else {
          navHTML += `
            <li>
              <a href="${isPreviewNav ? '#' : filename}" onclick="${isPreviewNav ? `openPageInPreview('${filename}')` : ''}">${p.title}</a>
            </li>
          `;
        }
      });
      navHTML += `</ul></nav>`;
      return navHTML;
    }
    
    // Fetch Remote Templates from GitHub
    fetch('https://api.github.com/repos/mpalmero197/webbuilder/contents/')
      .then(response => response.json())
      .then(data => {
        const templateFiles = data.filter(file => file.name.startsWith('template-') && file.type === 'file');
        const remoteTemplateListContainer = document.getElementById('remoteTemplateListContainer');
        templateFiles.forEach(file => {
          let baseName = file.name.replace(/^template-/, '').replace(/\.[^/.]+$/, '');
          let displayName = baseName.charAt(0).toUpperCase() + baseName.slice(1) + ' Template';
          const templateDiv = document.createElement('div');
          templateDiv.classList.add('templateItem');
          templateDiv.innerHTML = `<h3>${displayName}</h3>`;
          const button = document.createElement('button');
          button.textContent = 'Apply Template';
          button.addEventListener('click', () => {
            fetch(file.download_url)
              .then(resp => resp.text())
              .then(htmlContent => {
                const previewFrame = document.getElementById('previewFrame');
                previewFrame.srcdoc = htmlContent;
                const newPage = {
                  id: pageCount++,
                  title: displayName,
                  layout: "raw",
                  rawHTML: htmlContent,
                  sections: [],
                  subPages: []
                };
                pages = [newPage];
                pagesContainer.innerHTML = "";
                createPageEditor(newPage, null);
                alert('Remote template loaded.');
              })
              .catch(err => console.error('Error loading template:', err));
          });
          templateDiv.appendChild(button);
          remoteTemplateListContainer.appendChild(templateDiv);
        });
      })
      .catch(err => console.error('Error fetching templates:', err));
    // Local Template Functions
    function addLocalTemplateToList(filename, content, folder) {
      const localTemplateListContainer = document.getElementById('localTemplateListContainer');
      const templateDiv = document.createElement('div');
      templateDiv.classList.add('templateItem');
      const displayName = filename.replace(/^template-/, '').replace(/\.html$/i, '');
      templateDiv.innerHTML = `<h3>${displayName} (Local, Folder: ${folder || "None"})</h3>`;
      const applyButton = document.createElement('button');
      applyButton.textContent = 'Apply Template';
      applyButton.addEventListener('click', () => {
         const previewFrame = document.getElementById('previewFrame');
         previewFrame.srcdoc = content;
         const newPage = {
            id: pageCount++,
            title: displayName,
            layout: "raw",
            rawHTML: content,
            sections: [],
            subPages: []
         };
         pages = [newPage];
         pagesContainer.innerHTML = "";
         createPageEditor(newPage, null);
         alert('Local template loaded.');
      });
      templateDiv.appendChild(applyButton);
      const deleteButton = document.createElement('button');
      deleteButton.textContent = 'Delete Template';
      deleteButton.style.background = '#d9534f';
      deleteButton.addEventListener('click', () => {
        if (confirm("Delete this template?")) {
          let localTemplates = JSON.parse(localStorage.getItem("localTemplates") || "[]");
          localTemplates = localTemplates.filter(t => t.filename !== filename);
          localStorage.setItem("localTemplates", JSON.stringify(localTemplates));
          templateDiv.remove();
          alert("Template deleted.");
        }
      });
      templateDiv.appendChild(deleteButton);
      localTemplateListContainer.appendChild(templateDiv);
    }
    function loadLocalTemplates() {
      const localTemplates = JSON.parse(localStorage.getItem("localTemplates") || "[]");
      localTemplates.forEach(template => {
           addLocalTemplateToList(template.filename, template.content, template.folder);
      });
    }
    window.addEventListener("load", loadLocalTemplates);
    
    // Save Current Template
    document.getElementById("saveTemplateBtn").addEventListener("click", function() {
      const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
      if (!iframeDoc) {
        alert("Preview not loaded.");
        return;
      }
      const templateHTML = iframeDoc.documentElement.outerHTML;
      let fileName = prompt("Enter filename for template (e.g., template-myLayout):", "template-");
      if (fileName) {
        fileName = fileName.trim();
        if (!fileName.toUpperCase().endsWith(".HTML")) { fileName += ".HTML"; }
        let folderName = defaultLocalTemplateFolder;
        let localTemplates = JSON.parse(localStorage.getItem("localTemplates") || "[]");
        localTemplates.push({ filename: fileName, content: templateHTML, folder: folderName });
        localStorage.setItem("localTemplates", JSON.stringify(localTemplates));
        addLocalTemplateToList(fileName, templateHTML, folderName);
        const blob = new Blob([templateHTML], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("Template saved as " + fileName + "\nFolder: " + folderName);
      }
    });
    
    // Change Text Color Functionality
    document.getElementById("changeTextColorBtn").addEventListener("click", function() {
      const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
      const selection = iframeDoc.getSelection();
      if (selection.isCollapsed) {
        alert("Select text in preview pane.");
        return;
      }
      document.getElementById("textColorPicker").click();
    });
    document.getElementById("textColorPicker").addEventListener("input", function() {
      const color = this.value;
      const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
      iframeDoc.body.focus();
      iframeDoc.execCommand("styleWithCSS", false, true);
      iframeDoc.execCommand("foreColor", false, color);
    });
    
    // View Source & Update Element
    let viewSourceEnabled = false;
    const toggleViewSourceBtn = document.getElementById('toggleViewSourceBtn');
    const viewSourcePanel = document.getElementById('viewSourcePanel');
    toggleViewSourceBtn.addEventListener('click', function() {
      viewSourceEnabled = !viewSourceEnabled;
      this.textContent = viewSourceEnabled ? "Disable View Source" : "Enable View Source";
      const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
      if (viewSourceEnabled) {
        attachViewSourceListeners(iframeDoc);
      } else {
        detachViewSourceListeners(iframeDoc);
        removeHighlight();
        viewSourcePanel.style.display = "none";
      }
    });
    function attachViewSourceListeners(doc) {
      if (!doc) return;
      doc.addEventListener('mouseover', handleElementMouseOver);
      doc.addEventListener('mouseout', handleElementMouseOut);
      doc.addEventListener('click', handleElementClick);
      if (doc.head) {
        const titleElem = doc.head.querySelector('title');
        if (titleElem) {
          titleElem.style.cursor = 'pointer';
          titleElem.addEventListener('click', handleElementClick);
        }
      }
    }
    function detachViewSourceListeners(doc) {
      if (!doc) return;
      doc.removeEventListener('mouseover', handleElementMouseOver);
      doc.removeEventListener('mouseout', handleElementMouseOut);
      doc.removeEventListener('click', handleElementClick);
      if (doc.head) {
        const titleElem = doc.head.querySelector('title');
        if (titleElem) {
          titleElem.removeEventListener('click', handleElementClick);
        }
      }
    }
    function handleElementMouseOver(e) {
      e.stopPropagation();
      const target = e.target;
      target.style.outline = "2px solid red";
      viewSourcePanel.textContent = target.outerHTML;
      viewSourcePanel.style.top = (e.clientY + 10) + "px";
      viewSourcePanel.style.left = (e.clientX + 10) + "px";
      viewSourcePanel.style.display = "block";
    }
    function handleElementMouseOut(e) {
      e.stopPropagation();
      e.target.style.outline = "";
      viewSourcePanel.style.display = "none";
    }
    function handleElementClick(e) {
      const target = e.target;
      if (target.tagName.toLowerCase() === 'a') {
        const href = target.getAttribute('href');
        if (href && href.startsWith('#')) return;
      }
      e.preventDefault();
      e.stopPropagation();
      const elementHTML = target.outerHTML;
      const editPanel = document.getElementById('editElementPanel');
      const editTextarea = document.getElementById('editElementTextarea');
      editTextarea.value = elementHTML;
      editTextarea.select();
      editPanel.style.display = 'block';
      window.currentlySelectedElement = target;
    }
    function removeHighlight() {
      const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
      if (iframeDoc) {
        iframeDoc.querySelectorAll('*').forEach(elem => {
          elem.style.outline = "";
        });
      }
    }
    function performUpdateElement() {
      const newHTML = document.getElementById('editElementTextarea').value;
      if (!newHTML.trim()) {
        if (window.currentlySelectedElement) {
          if (window.currentlySelectedElement.tagName.toLowerCase() === 'title') {
            alert("Cannot delete title element.");
            return false;
          }
          const pageId = window.currentlySelectedElement.getAttribute('data-page-id');
          const sectionIndex = window.currentlySelectedElement.getAttribute('data-section-index');
          if (pageId !== null && sectionIndex !== null) {
            const targetPage = findPageById(parseInt(pageId, 10), pages);
            if (targetPage) {
              targetPage.sections.splice(parseInt(sectionIndex, 10), 1);
            }
          }
          window.currentlySelectedElement.parentNode.removeChild(window.currentlySelectedElement);
          window.currentlySelectedElement = null;
          document.getElementById('editElementPanel').style.display = 'none';
          return true;
        }
        return false;
      }
      if (window.currentlySelectedElement) {
        if (window.currentlySelectedElement.tagName.toLowerCase() === 'title') {
          const pageId = window.currentlySelectedElement.getAttribute('data-page-id');
          if (pageId !== null) {
            const targetPage = findPageById(parseInt(pageId, 10), pages);
            if (targetPage) {
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = newHTML;
              const newTitleElem = tempDiv.querySelector('title');
              if (newTitleElem) {
                const newTitleText = newTitleElem.textContent;
                targetPage.title = newTitleText;
                const pageDiv = document.querySelector(`.pageItem[data-pageid="${pageId}"]`);
                if (pageDiv) {
                  const titleInput = pageDiv.querySelector('.pageTitleInput');
                  if (titleInput) {
                    titleInput.value = newTitleText;
                  }
                }
                document.getElementById('editElementPanel').style.display = 'none';
                window.currentlySelectedElement = null;
                return true;
              } else {
                alert("Invalid title HTML.");
                return false;
              }
            }
          }
        } else {
          const pageId = window.currentlySelectedElement.getAttribute('data-page-id');
          const sectionIndex = window.currentlySelectedElement.getAttribute('data-section-index');
          if (pageId !== null && sectionIndex !== null) {
            const targetPage = findPageById(parseInt(pageId, 10), pages);
            if (targetPage && targetPage.sections[parseInt(sectionIndex, 10)]) {
              targetPage.sections.splice(parseInt(sectionIndex, 10), 1, { customHTML: newHTML });
            }
          }
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = newHTML;
          const newElem = tempDiv.firstElementChild;
          if (newElem) {
            if (pageId !== null && sectionIndex !== null) {
              newElem.setAttribute('data-page-id', pageId);
              newElem.setAttribute('data-section-index', sectionIndex);
            }
            window.currentlySelectedElement.parentNode.replaceChild(newElem, window.currentlySelectedElement);
            window.currentlySelectedElement = null;
            document.getElementById('editElementPanel').style.display = 'none';
            return true;
          } else {
            alert("Invalid HTML.");
            return false;
          }
        }
      }
      return false;
    }
    document.getElementById('pushUpdatesBtn').addEventListener('click', function() {
      if (performUpdateElement()) {
        try {
          removeHighlight();
          const updatedHTML = previewFrame.contentDocument.documentElement.outerHTML;
          generatedCode.value = updatedHTML;
        } catch (err) {
          console.error("Error:", err);
        }
      }
    });
    document.getElementById('updateElementBtn').addEventListener('click', function() {
      performUpdateElement();
    });
    document.getElementById('deleteElementBtn').addEventListener('click', function() {
      if (window.currentlySelectedElement) {
        if (window.currentlySelectedElement.tagName.toLowerCase() === 'title') {
          alert("Cannot delete title element.");
          return;
        }
        const pageId = window.currentlySelectedElement.getAttribute('data-page-id');
        const sectionIndex = window.currentlySelectedElement.getAttribute('data-section-index');
        if (pageId !== null && sectionIndex !== null) {
          const targetPage = findPageById(parseInt(pageId, 10), pages);
          if (targetPage) {
            targetPage.sections.splice(parseInt(sectionIndex, 10), 1);
          }
        }
        window.currentlySelectedElement.parentNode.removeChild(window.currentlySelectedElement);
        window.currentlySelectedElement = null;
        document.getElementById('editElementPanel').style.display = 'none';
        alert("Element deleted.");
      } else {
        alert("No element selected.");
      }
    });
    const previewFrame = document.getElementById('previewFrame');
    function makeAllElementsDropZones() {
      const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
      const allElements = iframeDoc.body.querySelectorAll("*");
      allElements.forEach(el => {
        el.addEventListener("dragover", function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = "copy";
        });
        el.addEventListener("drop", function(e) {
          e.preventDefault();
          e.stopPropagation();
          const imgUrl = e.dataTransfer.getData("text/plain");
          if (imgUrl) {
            const prevBackground = el.style.backgroundImage;
            undoStack.push({ element: el, background: prevBackground });
            redoStack = [];
            el.style.backgroundImage = `url('${imgUrl}')`;
            el.style.backgroundSize = "cover";
            el.style.backgroundPosition = "center";
            el.style.backgroundRepeat = "no-repeat";
            el.style.filter = "none";
          }
        });
      });
    }
    previewFrame.addEventListener('load', function() {
      const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
      iframeDoc.body.contentEditable = "true";
      iframeDoc.body.spellcheck = false;
      iframeDoc.body.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "copy";
      });
      makeAllElementsDropZones();
      if (viewSourceEnabled) {
        attachViewSourceListeners(iframeDoc);
      }
    });
    // Undo/Redo Buttons
    document.getElementById("undoBtn").addEventListener("click", function() {
      if (undoStack.length > 0) {
        const lastAction = undoStack.pop();
        const element = lastAction.element;
        const currentBackground = element.style.backgroundImage;
        redoStack.push({ element: element, background: currentBackground });
        element.style.backgroundImage = lastAction.background;
      } else {
        alert("Nothing to undo.");
      }
    });
    document.getElementById("redoBtn").addEventListener("click", function() {
      if (redoStack.length > 0) {
        const lastAction = redoStack.pop();
        const element = lastAction.element;
        const currentBackground = element.style.backgroundImage;
        undoStack.push({ element: element, background: currentBackground });
        element.style.backgroundImage = lastAction.background;
      } else {
        alert("Nothing to redo.");
      }
    });
    const previewBtn = document.getElementById('previewBtn');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const generatedCode = document.getElementById('generatedCode');
    let siteMap = {};
    previewBtn.addEventListener('click', () => {
      if (pages.length === 0) {
        previewFrame.srcdoc = "<p style='color:red;'>No pages defined.</p>";
        return;
      }
      siteMap = {};
      const flatList = flattenPages(pages);
      flatList.forEach(pg => {
        const code = buildPageHTML(pg, true);
        const fname = pageFilename(pg);
        siteMap[fname] = code;
      });
      const homePage = pages[0];
      const homeFilename = pageFilename(homePage);
      previewFrame.srcdoc = siteMap[homeFilename];
    });
    window.openPageInPreview = function(filename) {
      if (siteMap[filename]) {
        previewFrame.srcdoc = siteMap[filename];
      }
    };
    generateBtn.addEventListener('click', () => {
      let allCode = "";
      if (pages.length === 0) {
        allCode = "<!-- No pages defined -->";
      } else {
        siteMap = {};
        const flatList = flattenPages(pages);
        flatList.forEach(pg => {
          const pgCode = buildPageHTML(pg, false);
          const fname = pageFilename(pg);
          pg.filename = fname;
          siteMap[fname] = pgCode;
          allCode += `<!-- PAGE: ${fname} -->\n${pgCode}\n\n`;
        });
      }
      generatedCode.value = allCode.trim();
    });
    clearBtn.addEventListener('click', () => {
      selectedFont = "'Montserrat', sans-serif";
      fontFamilySearchInput.value = "";
      renderFontList();
      globalBgColor.value = "#ffffff";
      globalTextColor.value = "#000000";
      globalHeadingColor.value = "#000000";
      includeNav.checked = false;
      globalFontSize.value = "16";
      globalLineHeight.value = "1.6";
      globalLinkColor.value = "#4A88F6";
      globalBgImage.value = "";
      globalCustomCSS.value = "";
      pageCount = 0; 
      pages = [];
      pagesContainer.innerHTML = "";
      manualHtmlInput.value = "";
      previewFrame.srcdoc = "";
      generatedCode.value = "";
      siteMap = {};
      tabButtons.forEach(b => b.classList.remove('active'));
      tabContents.forEach(tc => tc.classList.remove('active'));
      tabButtons[0].classList.add('active');
      tabContents[0].classList.add('active');
    });
    const codeSearchInput = document.getElementById('codeSearchInput');
    const codeReplaceInput = document.getElementById('codeReplaceInput');
    const replaceAllBtn = document.getElementById('replaceAllBtn');
    const exportHTMLBtn = document.getElementById('exportHTMLBtn');
    let searchIndex = 0;
    document.getElementById('nextBtn').addEventListener('click', function() {
      const query = codeSearchInput.value;
      if (!query) {
        alert("Enter a search term.");
        return;
      }
      const codeText = generatedCode.value;
      const foundIndex = codeText.indexOf(query, searchIndex);
      if (foundIndex === -1) {
        alert("No more matches. Restarting.");
        searchIndex = 0;
      } else {
        generatedCode.focus();
        generatedCode.setSelectionRange(foundIndex, foundIndex + query.length);
        const computedStyle = window.getComputedStyle(generatedCode);
        const lineHeight = parseFloat(computedStyle.lineHeight) || parseFloat(computedStyle.fontSize) * 1.2;
        const substring = generatedCode.value.substring(0, foundIndex);
        const lineNumber = substring.split("\n").length - 1;
        generatedCode.scrollTop = lineNumber * lineHeight;
        searchIndex = foundIndex + query.length;
      }
    });
    document.getElementById('prevBtn').addEventListener('click', function() {
      const query = codeSearchInput.value;
      if (!query) {
        alert("Enter a search term.");
        return;
      }
      const codeText = generatedCode.value;
      const currentStart = generatedCode.selectionStart;
      const foundIndex = codeText.lastIndexOf(query, currentStart - 1);
      if (foundIndex === -1) {
        alert("No previous matches found.");
      } else {
        generatedCode.focus();
        generatedCode.setSelectionRange(foundIndex, foundIndex + query.length);
        const computedStyle = window.getComputedStyle(generatedCode);
        const lineHeight = parseFloat(computedStyle.lineHeight) || parseFloat(computedStyle.fontSize) * 1.2;
        const substring = generatedCode.value.substring(0, foundIndex);
        const lineNumber = substring.split("\n").length - 1;
        generatedCode.scrollTop = lineNumber * lineHeight;
        searchIndex = foundIndex;
      }
    });
    replaceAllBtn.addEventListener('click', function() {
      const searchText = codeSearchInput.value;
      const replaceText = codeReplaceInput.value;
      if (!searchText) {
        alert("Enter text to search for.");
        return;
      }
      const codeContent = generatedCode.value;
      const updatedCode = codeContent.split(searchText).join(replaceText);
      generatedCode.value = updatedCode;
    });
    exportHTMLBtn.addEventListener('click', function() {
      const codeContent = generatedCode.value;
      if (!codeContent) {
        alert("No generated code to export.");
        return;
      }
      const parser = new DOMParser();
      const doc = parser.parseFromString(codeContent, "text/html");
      doc.body.removeAttribute("contenteditable");
      const cleanedHTML = doc.documentElement.outerHTML;
      const blob = new Blob([cleanedHTML], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "exported_site.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // THEME TOGGLE SWITCH LOGIC
    const themeToggleSwitch = document.getElementById('themeToggleSwitch');
    themeToggleSwitch.addEventListener('change', () => {
      document.body.classList.toggle('light-theme');
    });
  </script>
</body>
</html>
